<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.2.0"/>
    <title>micro_sam.sam_annotator._widgets API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../sam_annotator.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;micro_sam.sam_annotator</a>

            <img src="https://raw.githubusercontent.com/computational-cell-analytics/micro-sam/master/doc/logo/logo_and_text.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#PBarSignals">PBarSignals</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PBarSignals.pbar_total">pbar_total</a>
                        </li>
                        <li>
                                <a class="function" href="#PBarSignals.pbar_update">pbar_update</a>
                        </li>
                        <li>
                                <a class="function" href="#PBarSignals.pbar_description">pbar_description</a>
                        </li>
                        <li>
                                <a class="function" href="#PBarSignals.pbar_stop">pbar_stop</a>
                        </li>
                        <li>
                                <a class="function" href="#PBarSignals.pbar_reset">pbar_reset</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#InfoDialog">InfoDialog</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#InfoDialog.__init__">InfoDialog</a>
                        </li>
                        <li>
                                <a class="function" href="#InfoDialog.button_clicked">button_clicked</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#clear">clear</a>
            </li>
            <li>
                    <a class="variable" href="#clear_volume">clear_volume</a>
            </li>
            <li>
                    <a class="variable" href="#clear_track">clear_track</a>
            </li>
            <li>
                    <a class="variable" href="#commit">commit</a>
            </li>
            <li>
                    <a class="variable" href="#commit_track">commit_track</a>
            </li>
            <li>
                    <a class="function" href="#create_prompt_menu">create_prompt_menu</a>
            </li>
            <li>
                    <a class="variable" href="#settings_widget">settings_widget</a>
            </li>
            <li>
                    <a class="variable" href="#segment">segment</a>
            </li>
            <li>
                    <a class="variable" href="#segment_slice">segment_slice</a>
            </li>
            <li>
                    <a class="variable" href="#segment_frame">segment_frame</a>
            </li>
            <li>
                    <a class="class" href="#EmbeddingWidget">EmbeddingWidget</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EmbeddingWidget.__init__">EmbeddingWidget</a>
                        </li>
                        <li>
                                <a class="variable" href="#EmbeddingWidget.run_button">run_button</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SegmentNDWidget">SegmentNDWidget</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SegmentNDWidget.__init__">SegmentNDWidget</a>
                        </li>
                        <li>
                                <a class="variable" href="#SegmentNDWidget.tracking">tracking</a>
                        </li>
                        <li>
                                <a class="variable" href="#SegmentNDWidget.settings">settings</a>
                        </li>
                        <li>
                                <a class="variable" href="#SegmentNDWidget.run_button">run_button</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AutoSegmentWidget">AutoSegmentWidget</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AutoSegmentWidget.__init__">AutoSegmentWidget</a>
                        </li>
                        <li>
                                <a class="variable" href="#AutoSegmentWidget.with_decoder">with_decoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#AutoSegmentWidget.volumetric">volumetric</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../micro_sam.html">micro_sam</a><wbr>.<a href="./../sam_annotator.html">sam_annotator</a><wbr>._widgets    </h1>

                        <div class="docstring"><p>Implements the widgets used in the annotation plugins.</p>
</div>

                        <input id="mod-_widgets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-_widgets-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;Implements the widgets used in the annotation plugins.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">json</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">elf.parallel</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">h5py</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span> <span class="nn">napari</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">import</span> <span class="nn">zarr</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span> <span class="nn">z5py</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span> <span class="nn">qtpy</span> <span class="kn">import</span> <span class="n">QtWidgets</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span> <span class="nn">qtpy.QtCore</span> <span class="kn">import</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">Signal</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span> <span class="nn">superqt</span> <span class="kn">import</span> <span class="n">QCollapsible</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span> <span class="nn">magicgui</span> <span class="kn">import</span> <span class="n">magic_factory</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span> <span class="nn">magicgui.widgets</span> <span class="kn">import</span> <span class="n">ComboBox</span><span class="p">,</span> <span class="n">Container</span><span class="p">,</span> <span class="n">create_widget</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span> <span class="nn">napari.qt.threading</span> <span class="kn">import</span> <span class="n">thread_worker</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span> <span class="nn">napari.utils</span> <span class="kn">import</span> <span class="n">progress</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span> <span class="nn">._state</span> <span class="kn">import</span> <span class="n">AnnotatorState</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span> <span class="k">as</span> <span class="n">vutil</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">from</span> <span class="nn">._tooltips</span> <span class="kn">import</span> <span class="n">get_tooltip</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">instance_segmentation</span><span class="p">,</span> <span class="n">util</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">from</span> <span class="nn">..multi_dimensional_segmentation</span> <span class="kn">import</span> <span class="n">segment_mask_in_volume</span><span class="p">,</span> <span class="n">merge_instance_segmentation_3d</span><span class="p">,</span> <span class="n">PROJECTION_MODES</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="c1">#</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="c1"># Convenience functionality for creating QT UI and manipulating the napari viewer.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="c1">#</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="k">def</span> <span class="nf">_select_layer</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">):</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">select_only</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_name</span><span class="p">])</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="c1"># Create a collapsible around the widget</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="k">def</span> <span class="nf">_make_collapsible</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    <span class="n">parent_widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="n">parent_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="n">collapsible</span> <span class="o">=</span> <span class="n">QCollapsible</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">parent_widget</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="n">collapsible</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="n">parent_widget</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">collapsible</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="k">return</span> <span class="n">parent_widget</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="c1"># Base class for a widget with convenience functionality for adding parameters.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="k">class</span> <span class="nc">_WidgetBase</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">):</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="k">def</span> <span class="nf">_add_boolean_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="n">checkbox</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QCheckBox</span><span class="p">(</span><span class="n">name</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">title</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="n">checkbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="n">checkbox</span><span class="o">.</span><span class="n">stateChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>            <span class="n">checkbox</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>        <span class="k">return</span> <span class="n">checkbox</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>    <span class="k">def</span> <span class="nf">_add_string_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>        <span class="k">if</span> <span class="n">layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>            <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="n">param</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">()</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="k">if</span> <span class="n">placeholder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">setPlaceholderText</span><span class="p">(</span><span class="n">placeholder</span><span class="p">)</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">layout</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>    <span class="k">def</span> <span class="nf">_add_float_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>                         <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="k">if</span> <span class="n">layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>            <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="n">param</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDoubleSpinBox</span><span class="p">()</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setDecimals</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>        <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">layout</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="k">def</span> <span class="nf">_add_int_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="k">if</span> <span class="n">layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>            <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="n">param</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QSpinBox</span><span class="p">()</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">setSingleStep</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="n">param</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">layout</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>    <span class="k">def</span> <span class="nf">_add_choice_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="k">if</span> <span class="n">layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="c1"># Create the dropdown menu via QComboBox, set the available values.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>        <span class="n">dropdown</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QComboBox</span><span class="p">()</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="n">dropdown</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>            <span class="n">dropdown</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">index</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>            <span class="n">dropdown</span><span class="o">.</span><span class="n">currentIndexChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="c1"># Set the correct value for the value.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>        <span class="n">dropdown</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="n">dropdown</span><span class="o">.</span><span class="n">findText</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>            <span class="n">dropdown</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">dropdown</span><span class="p">)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="k">return</span> <span class="n">dropdown</span><span class="p">,</span> <span class="n">layout</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>    <span class="k">def</span> <span class="nf">_add_shape_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        <span class="n">x_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="n">x_param</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">min_val</span><span class="o">=</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="n">max_val</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">x_layout</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">tooltip</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">x_layout</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="n">y_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="n">y_param</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">min_val</span><span class="o">=</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="n">max_val</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">y_layout</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">tooltip</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">y_layout</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="k">return</span> <span class="n">x_param</span><span class="p">,</span> <span class="n">y_param</span><span class="p">,</span> <span class="n">layout</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>    <span class="k">def</span> <span class="nf">_add_path_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">select_type</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="k">assert</span> <span class="n">select_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>            <span class="n">label</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="n">path_textbox</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLineEdit</span><span class="p">()</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>        <span class="n">path_textbox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="k">if</span> <span class="n">placeholder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="n">path_textbox</span><span class="o">.</span><span class="n">setPlaceholderText</span><span class="p">(</span><span class="n">placeholder</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="n">path_textbox</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>            <span class="n">path_textbox</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">path_textbox</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="k">def</span> <span class="nf">add_path_button</span><span class="p">(</span><span class="n">select_type</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="c1"># Adjust button text.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="n">button_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Select </span><span class="si">{</span><span class="n">select_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="n">path_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="n">button_text</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>            <span class="c1"># Call appropriate function based on select_type.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>            <span class="n">path_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_get_</span><span class="si">{</span><span class="n">select_type</span><span class="si">}</span><span class="s2">_path&quot;</span><span class="p">)(</span><span class="n">name</span><span class="p">,</span> <span class="n">path_textbox</span><span class="p">))</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>            <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>                <span class="n">path_button</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>            <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">path_button</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>        <span class="k">if</span> <span class="n">select_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>            <span class="n">add_path_button</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="n">add_path_button</span><span class="p">(</span><span class="s2">&quot;directory&quot;</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>            <span class="n">add_path_button</span><span class="p">(</span><span class="n">select_type</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="k">return</span> <span class="n">path_textbox</span><span class="p">,</span> <span class="n">layout</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>    <span class="k">def</span> <span class="nf">_get_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">textbox</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="n">directory</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getExistingDirectory</span><span class="p">(</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Select Directory&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">ShowDirsOnly</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>            <span class="n">directory</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="k">if</span> <span class="n">directory</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="n">textbox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="c1"># Handle the case where the selected path is not a directory</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid directory selected. Please try again.&quot;</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>    <span class="k">def</span> <span class="nf">_get_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">textbox</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Select File&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;All Files (*)&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>        <span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="k">if</span> <span class="n">tooltip</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            <span class="n">file_path</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">tooltip</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="n">textbox</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="c1"># Handle the case where the selected path is not a file</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid file selected. Please try again.&quot;</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="c1"># Custom signals for managing progress updates.</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="k">class</span> <span class="nc">PBarSignals</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>    <span class="n">pbar_total</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>    <span class="n">pbar_update</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>    <span class="n">pbar_description</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>    <span class="n">pbar_stop</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>    <span class="n">pbar_reset</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="k">class</span> <span class="nc">InfoDialog</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDialog</span><span class="p">):</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="c1"># Add buttons</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="n">button_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>  <span class="c1"># Use QHBoxLayout for buttons side-by-side</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="n">accept_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="n">accept_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_clicked</span><span class="p">(</span><span class="n">accept_button</span><span class="p">))</span>  <span class="c1"># Connect to clicked signal</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="n">button_box</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">accept_button</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="n">cancel_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="n">cancel_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_clicked</span><span class="p">(</span><span class="n">cancel_button</span><span class="p">))</span>  <span class="c1"># Connect to clicked signal</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="n">button_box</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">cancel_button</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">button_box</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>    <span class="k">def</span> <span class="nf">button_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>        <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OK&quot;</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>  <span class="c1"># Accept the dialog</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>  <span class="c1"># Reject the dialog (Cancel)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="c1"># Set up the progress bar. We handle this via custom signals that are passed as callbacks to the</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="c1"># function that does the actual work. We need callbacks for initializing the progress bar,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="c1"># updating it and for stopping the progress bar.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="k">def</span> <span class="nf">_create_pbar_for_threadworker</span><span class="p">():</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>    <span class="n">pbar</span> <span class="o">=</span> <span class="n">progress</span><span class="p">()</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>    <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">PBarSignals</span><span class="p">()</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>    <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">total</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">pbar</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">))</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>    <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">update</span><span class="p">))</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>    <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">description</span><span class="p">:</span> <span class="n">pbar</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">description</span><span class="p">))</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>    <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">())</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>    <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_reset</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">pbar</span><span class="o">.</span><span class="n">reset</span><span class="p">())</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    <span class="k">return</span> <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="k">def</span> <span class="nf">_reset_tracking_state</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset the tracking state.</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">    This helper function is needed by the widgets clear_track and by commit_track.</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>    <span class="c1"># Reset the lineage and track id.</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">lineage</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>    <span class="c1"># Reset the layer properties.</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">property_choices</span><span class="p">[</span><span class="s2">&quot;track_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">property_choices</span><span class="p">[</span><span class="s2">&quot;track_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>    <span class="c1"># Reset the choices in the track_id menu.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a><span class="c1">#</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="c1"># Widgets implemented with magicgui.</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="c1">#</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="nd">@magic_factory</span><span class="p">(</span><span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Clear Annotations [Shift + C]&quot;</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Widget for clearing the current annotations.</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">    Args:</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>    <span class="n">vutil</span><span class="o">.</span><span class="n">clear_annotations</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="nd">@magic_factory</span><span class="p">(</span><span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Clear Annotations [Shift + C]&quot;</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="k">def</span> <span class="nf">clear_volume</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">,</span> <span class="n">all_slices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Widget for clearing the current annotations in 3D.</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">    Args:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="sd">        all_slices: Choose whether to clear the annotations for all or only the current slice.</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>    <span class="k">if</span> <span class="n">all_slices</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">clear_annotations</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">clear_annotations_slice</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="nd">@magic_factory</span><span class="p">(</span><span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Clear Annotations [Shift + C]&quot;</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="k">def</span> <span class="nf">clear_track</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">,</span> <span class="n">all_frames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Widget for clearing all tracking annotations and state.</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">    Args:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">        all_frames: Choose whether to clear the annotations for all or only the current frame.</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>    <span class="k">if</span> <span class="n">all_frames</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="n">_reset_tracking_state</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">clear_annotations</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">clear_annotations_slice</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="k">def</span> <span class="nf">_commit_impl</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">preserve_committed</span><span class="p">):</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>    <span class="c1"># Check if we have a z_range. If yes, use it to set a bounding box.</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">z_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="n">bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[:]</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">z_range</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="n">bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">z_min</span><span class="p">:(</span><span class="n">z_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>    <span class="n">seg</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>    <span class="c1"># We parallelize these operatios because they take quite long for large volumes.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>    <span class="c1"># Compute the max id in the commited objects.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>    <span class="c1"># id_offset = int(viewer.layers[&quot;committed_objects&quot;].data.max())</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>    <span class="n">full_shape</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;committed_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>    <span class="n">id_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>        <span class="n">elf</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;committed_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">block_shape</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">get_block_shape</span><span class="p">(</span><span class="n">full_shape</span><span class="p">))</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>    <span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>    <span class="c1"># Compute the mask for the current object.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>    <span class="c1"># mask = seg != 0</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;bool&quot;</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">apply_operation</span><span class="p">(</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>        <span class="n">seg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">not_equal</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">block_shape</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">get_block_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>    <span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>    <span class="k">if</span> <span class="n">preserve_committed</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>        <span class="n">prev_seg</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;committed_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="n">mask</span><span class="p">[</span><span class="n">prev_seg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>    <span class="c1"># Write the current object to committed objects.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>    <span class="n">seg</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">+=</span> <span class="n">id_offset</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;committed_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">bb</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;committed_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>    <span class="k">return</span> <span class="n">id_offset</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bb</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="k">def</span> <span class="nf">_commit_to_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="n">extra_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="c1"># NOTE: zarr-python is quite inefficient and writes empty blocks.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>    <span class="c1"># So we have to use z5py here.</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>    <span class="c1"># Deal with issues z5py has with empty folders and require the json.</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="n">required_json</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;.zgroup&quot;</span><span class="p">)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">required_json</span><span class="p">):</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">required_json</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s2">&quot;zarr_format&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>    <span class="n">f</span> <span class="o">=</span> <span class="n">z5py</span><span class="o">.</span><span class="n">ZarrFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>    <span class="c1"># Write metadata about the model that&#39;s being used etc.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>    <span class="c1"># Only if it&#39;s not written to the file yet.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>    <span class="k">if</span> <span class="s2">&quot;data_signature&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="n">embeds</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">]</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="n">tile_shape</span><span class="p">,</span> <span class="n">halo</span> <span class="o">=</span> <span class="n">_process_tiling_inputs</span><span class="p">(</span><span class="n">embeds</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="n">embeds</span><span class="o">.</span><span class="n">tile_y</span><span class="p">,</span> <span class="n">embeds</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="n">embeds</span><span class="o">.</span><span class="n">halo_y</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="n">signature</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_get_embedding_signature</span><span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="n">input_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># We don&#39;t need this because we pass the data signature.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>            <span class="n">predictor</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="n">tile_shape</span><span class="o">=</span><span class="n">tile_shape</span><span class="p">,</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>            <span class="n">halo</span><span class="o">=</span><span class="n">halo</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="n">data_signature</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">data_signature</span><span class="p">,</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>        <span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>    <span class="c1"># Write the segmentation.</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>    <span class="n">full_shape</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;committed_objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>    <span class="n">block_shape</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_block_shape</span><span class="p">(</span><span class="n">full_shape</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>    <span class="n">ds</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>        <span class="s2">&quot;committed_objects&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">full_shape</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">block_shape</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>    <span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>    <span class="n">ds</span><span class="o">.</span><span class="n">n_threads</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>    <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>    <span class="n">ds</span><span class="p">[</span><span class="n">bb</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>    <span class="c1"># Write additional information to attrs.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>    <span class="k">if</span> <span class="n">extra_attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_attrs</span><span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>    <span class="c1"># If we run commit from the automatic segmentation we don&#39;t have</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>    <span class="c1"># any prompts and so don&#39;t need to commit anything else.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>    <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;auto_segmentation&quot;</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="c1"># TODO write the settings for the auto segmentation widget.</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="k">return</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>    <span class="k">def</span> <span class="nf">write_prompts</span><span class="p">(</span><span class="n">object_id</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">point_prompts</span><span class="p">):</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prompts/</span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;prompts&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="k">if</span> <span class="n">point_prompts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">point_prompts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">point_prompts</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">point_prompts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>    <span class="c1"># TODO write the settings for the segmentation widget if necessary.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>    <span class="c1"># Commit the prompts for all the objects in the commit.</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>    <span class="n">object_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">seg</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># We only have a single object.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="n">write_prompts</span><span class="p">(</span><span class="n">object_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="c1"># TODO this logic has to be updated to be compatible with the new batched prompting</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="n">have_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="n">have_point_prompts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>        <span class="k">if</span> <span class="n">have_prompts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">have_point_prompts</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            <span class="n">prompts</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="n">point_prompts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">have_prompts</span> <span class="ow">and</span> <span class="n">have_point_prompts</span><span class="p">:</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="n">prompts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="n">point_prompts</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Got multiple objects from interactive segmentation with box and point prompts.&quot;</span> <span class="k">if</span> <span class="p">(</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>                <span class="n">have_prompts</span> <span class="ow">and</span> <span class="n">have_point_prompts</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Got multiple objects from interactive segmentation with neither box or point prompts.&quot;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">object_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">object_ids</span><span class="p">):</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="n">write_prompts</span><span class="p">(</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>                <span class="n">object_id</span><span class="p">,</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                <span class="kc">None</span> <span class="k">if</span> <span class="n">prompts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="kc">None</span> <span class="k">if</span> <span class="n">point_prompts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">point_prompts</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="nd">@magic_factory</span><span class="p">(</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>    <span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Commit [C]&quot;</span><span class="p">,</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>    <span class="n">layer</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">,</span> <span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]},</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>    <span class="n">commit_path</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">},</span>  <span class="c1"># choose a directory</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="p">)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="k">def</span> <span class="nf">commit</span><span class="p">(</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>    <span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">,</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>    <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;current_object&quot;</span><span class="p">,</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>    <span class="n">preserve_committed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>    <span class="n">commit_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Widget for committing the segmented objects from automatic or interactive segmentation.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">    Args:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">        layer: Select the layer to commit. Can be either &#39;current_object&#39; to commit interacitve segmentation results.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">            Or &#39;auto_segmentation&#39; to commit automatic segmentation results.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">        preserve_committed: If active already committted objects are not over-written by new commits.</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">        commit_path: Select a file path where the committed results and prompts will be saved.</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">            This feature is still experimental.</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">_commit_impl</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">preserve_committed</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    <span class="k">if</span> <span class="n">commit_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="n">_commit_to_file</span><span class="p">(</span><span class="n">commit_path</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bb</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>    <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;current_object&quot;</span><span class="p">:</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">clear_annotations</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint32&quot;</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="n">_select_layer</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="s2">&quot;committed_objects&quot;</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="nd">@magic_factory</span><span class="p">(</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    <span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Commit [C]&quot;</span><span class="p">,</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>    <span class="n">layer</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;choices&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]},</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>    <span class="n">commit_path</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">},</span>  <span class="c1"># choose a directory</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="k">def</span> <span class="nf">commit_track</span><span class="p">(</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>    <span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>    <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;current_object&quot;</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>    <span class="n">preserve_committed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>    <span class="n">commit_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Widget for committing the objects from interactive tracking.</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">    Args:</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">        layer: Select the layer to commit. Can be either &#39;current_object&#39; to commit interacitve segmentation results.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">            Or &#39;auto_segmentation&#39; to commit automatic segmentation results.</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        preserve_committed: If active already committted objects are not over-written by new commits.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">        commit_path: Select a file path where the committed results and prompts will be saved.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">            This feature is still experimental.</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>    <span class="c1"># Commit the segmentation layer.</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>    <span class="n">id_offset</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">_commit_impl</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">preserve_committed</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>    <span class="c1"># Update the lineages.</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>    <span class="n">updated_lineage</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="n">parent</span> <span class="o">+</span> <span class="n">id_offset</span><span class="p">:</span> <span class="p">[</span><span class="n">child</span> <span class="o">+</span> <span class="n">id_offset</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span> <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>    <span class="p">}</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">committed_lineages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updated_lineage</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>    <span class="k">if</span> <span class="n">commit_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="n">_commit_to_file</span><span class="p">(</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="n">commit_path</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">seg</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="n">extra_attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;committed_lineages&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">committed_lineages</span><span class="p">}</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>    <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="s2">&quot;current_object&quot;</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">clear_annotations</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>    <span class="c1"># Reset the tracking state.</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>    <span class="n">_reset_tracking_state</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="k">def</span> <span class="nf">create_prompt_menu</span><span class="p">(</span><span class="n">points_layer</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">menu_name</span><span class="o">=</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="n">label_name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">):</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the menu for toggling point prompt labels.&quot;&quot;&quot;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>    <span class="n">label_menu</span> <span class="o">=</span> <span class="n">ComboBox</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">menu_name</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;prompt_menu&quot;</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">))</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>    <span class="n">label_widget</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="n">label_menu</span><span class="p">])</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>    <span class="k">def</span> <span class="nf">update_label_menu</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="n">new_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">points_layer</span><span class="o">.</span><span class="n">current_properties</span><span class="p">[</span><span class="n">label_name</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="k">if</span> <span class="n">new_label</span> <span class="o">!=</span> <span class="n">label_menu</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="n">label_menu</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_label</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>    <span class="n">points_layer</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current_properties</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_label_menu</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>    <span class="k">def</span> <span class="nf">label_changed</span><span class="p">(</span><span class="n">new_label</span><span class="p">):</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>        <span class="n">current_properties</span> <span class="o">=</span> <span class="n">points_layer</span><span class="o">.</span><span class="n">current_properties</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>        <span class="n">current_properties</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_label</span><span class="p">])</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>        <span class="n">points_layer</span><span class="o">.</span><span class="n">current_properties</span> <span class="o">=</span> <span class="n">current_properties</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="n">points_layer</span><span class="o">.</span><span class="n">refresh_colors</span><span class="p">()</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>    <span class="n">label_menu</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">label_changed</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>    <span class="k">return</span> <span class="n">label_widget</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a><span class="nd">@magic_factory</span><span class="p">(</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>    <span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Update settings&quot;</span><span class="p">,</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>    <span class="n">cache_directory</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">},</span>  <span class="c1"># choose a directory</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="k">def</span> <span class="nf">settings_widget</span><span class="p">(</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>    <span class="n">cache_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_cache_directory</span><span class="p">(),</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Widget to update global micro_sam settings.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">    Args:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        cache_directory: Select the path for the micro_sam cache directory. `$HOME/.cache/micro_sam`.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MICROSAM_CACHEDIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_directory</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;micro-sam cache directory set to: </span><span class="si">{</span><span class="n">cache_directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="k">def</span> <span class="nf">_generate_message</span><span class="p">(</span><span class="n">message_type</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">    Displays a message dialog based on the provided message type.</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">    Args:</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        message_type (str): The type of message to display. Valid options are:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">            - &quot;error&quot;: Displays a critical error message with an &quot;Ok&quot; button.</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">            - &quot;info&quot;: Displays an informational message in a separate dialog box.</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">                 The user can dismiss it by either clicking &quot;Ok&quot; or closing the dialog.</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        message (str): The message content to be displayed in the dialog.</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">    Returns:</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">        bool: A flag indicating whether the user aborted the operation based on the</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">              message type. This flag is only set for &quot;info&quot; messages where the user</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="sd">              can choose to cancel (rejected).</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">    Raises:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">        ValueError: If an invalid message type is provided.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>    <span class="c1"># Set button text and behavior based on message type</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>    <span class="k">if</span> <span class="n">message_type</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="n">abort</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>        <span class="k">return</span> <span class="n">abort</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>    <span class="k">elif</span> <span class="n">message_type</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="n">info_dialog</span> <span class="o">=</span> <span class="n">InfoDialog</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Validation Message&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">info_dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDialog</span><span class="o">.</span><span class="n">Rejected</span><span class="p">:</span>  <span class="c1"># Check for cancel</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>            <span class="n">abort</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Set flag directly in calling function</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>            <span class="k">return</span> <span class="n">abort</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="k">def</span> <span class="nf">_validate_embeddings</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">):</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Image embeddings are not yet computed. Press &#39;Compute Embeddings&#39; to compute them for your image.&quot;</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>        <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>    <span class="c1"># This code is for checking the data signature of the current image layer and the data signature</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>    <span class="c1"># of the embeddings. However, the code has some disadvantages, for example assuming the position of the</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>    <span class="c1"># image layer and also having to compute the data signature every time.</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>    <span class="c1"># That&#39;s why we are not using this for now, but may want to revisit this in the future. See:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="c1"># https://github.com/computational-cell-analytics/micro-sam/issues/504</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>    <span class="c1"># embeddings_save_path = state.embedding_path</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>    <span class="c1"># embedding_data_signature = None</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>    <span class="c1"># image = None</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>    <span class="c1"># if isinstance(viewer.layers[0], napari.layers.Image):  # Assuming the image layer is at index 0</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>    <span class="c1">#     image = viewer.layers[0]</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>    <span class="c1"># else:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>    <span class="c1">#     # Handle the case where the first layer isn&#39;t an Image layer</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>    <span class="c1">#     raise ValueError(&quot;Expected an Image layer in viewer.layers&quot;)</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>    <span class="c1"># img_signature = util._compute_data_signature(image.data)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>    <span class="c1"># if embeddings_save_path is not None:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="c1">#     # Check for existing embeddings</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>    <span class="c1">#     if os.listdir(embeddings_save_path):</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>    <span class="c1">#         try:</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>    <span class="c1">#             with zarr.open(embeddings_save_path, &quot;a&quot;) as f:</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>    <span class="c1">#                 # If data_signature exists, compare and return validation message</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>    <span class="c1">#                 if &quot;data_signature&quot; in f.attrs:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>    <span class="c1">#                     embedding_data_signature = f.attrs[&quot;data_signature&quot;]</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>    <span class="c1">#         except RuntimeError as e:</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>    <span class="c1">#             val_results = {</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>    <span class="c1">#                 &quot;message_type&quot;: &quot;error&quot;,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>    <span class="c1">#                 &quot;message&quot;: f&quot;Failed to load image embeddings: {e}&quot;</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>    <span class="c1">#             }</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>    <span class="c1">#     else:</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>    <span class="c1">#         val_results = {&quot;message_type&quot;: &quot;info&quot;, &quot;message&quot;: &quot;No existing embeddings found at the specified path.&quot;}</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>    <span class="c1"># else:  # load from state object</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>    <span class="c1">#     embedding_data_signature = state.data_signature</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>    <span class="c1"># # compare image data signature with embedding data signature</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>    <span class="c1"># if img_signature != embedding_data_signature:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>    <span class="c1">#     val_results = {</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>    <span class="c1">#         &quot;message_type&quot;: &quot;error&quot;,</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>    <span class="c1">#         &quot;message&quot;: f&quot;The embeddings don&#39;t match with the image: {img_signature} {embedding_data_signature}&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>    <span class="c1">#     }</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>    <span class="c1"># else:</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>    <span class="c1">#     val_results = None</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>    <span class="c1"># if val_results:</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>    <span class="c1">#     return _generate_message(val_results[&quot;message_type&quot;], val_results[&quot;message&quot;])</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>    <span class="c1"># else:</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>    <span class="c1">#     return False</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="k">def</span> <span class="nf">_validate_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No prompts were given. Please provide prompts to run interactive segmentation.&quot;</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>        <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="nd">@magic_factory</span><span class="p">(</span><span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Segment Object [S]&quot;</span><span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="k">def</span> <span class="nf">segment</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">,</span> <span class="n">batched</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Segment object(s) for the current prompts.</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">    Args:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        batched: Choose if you want to segment multiple objects with point prompts.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>    <span class="k">if</span> <span class="n">_validate_embeddings</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>    <span class="k">if</span> <span class="n">_validate_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>    <span class="c1"># get the current box and point prompts</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>    <span class="n">boxes</span><span class="p">,</span> <span class="n">masks</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">shape_layer_to_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span> <span class="n">shape</span><span class="p">)</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>    <span class="n">points</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">point_layer_to_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="n">with_stop_annotation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>    <span class="n">predictor</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span><span class="o">.</span><span class="n">predictor</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>    <span class="n">image_embeddings</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span><span class="o">.</span><span class="n">image_embeddings</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>    <span class="n">seg</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">prompt_segmentation</span><span class="p">(</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="n">predictor</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">image_embeddings</span><span class="o">=</span><span class="n">image_embeddings</span><span class="p">,</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="n">multiple_box_prompts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="n">batched</span><span class="p">,</span> <span class="n">previous_segmentation</span><span class="o">=</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>    <span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>    <span class="c1"># no prompts were given or prompts were invalid, skip segmentation</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>    <span class="k">if</span> <span class="n">seg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You either haven&#39;t provided any prompts or invalid prompts. The segmentation will be skipped.&quot;</span><span class="p">)</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="k">return</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="nd">@magic_factory</span><span class="p">(</span><span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Segment Slice [S]&quot;</span><span class="p">)</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="k">def</span> <span class="nf">segment_slice</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Segment object for to the current prompts.</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">    Args:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>    <span class="k">if</span> <span class="n">_validate_embeddings</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>    <span class="k">if</span> <span class="n">_validate_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>    <span class="n">position</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">position</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>    <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>    <span class="n">point_prompts</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">point_layer_to_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="n">z</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>    <span class="c1"># this is a stop prompt, we do nothing</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">point_prompts</span><span class="p">:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>        <span class="k">return</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>    <span class="n">boxes</span><span class="p">,</span> <span class="n">masks</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">shape_layer_to_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span> <span class="n">shape</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">z</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>    <span class="n">points</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">point_prompts</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>    <span class="n">seg</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">prompt_segmentation</span><span class="p">(</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">multiple_box_prompts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="n">image_embeddings</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>    <span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>    <span class="c1"># no prompts were given or prompts were invalid, skip segmentation</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="k">if</span> <span class="n">seg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You either haven&#39;t provided any prompts or invalid prompts. The segmentation will be skipped.&quot;</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="k">return</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="nd">@magic_factory</span><span class="p">(</span><span class="n">call_button</span><span class="o">=</span><span class="s2">&quot;Segment Frame [S]&quot;</span><span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="k">def</span> <span class="nf">segment_frame</span><span class="p">(</span><span class="n">viewer</span><span class="p">:</span> <span class="s2">&quot;napari.viewer.Viewer&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Segment object for the current prompts.</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">    Args:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">        viewer: The napari viewer.</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>    <span class="k">if</span> <span class="n">_validate_embeddings</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>    <span class="k">if</span> <span class="n">_validate_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>    <span class="n">position</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">position</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>    <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>    <span class="n">point_prompts</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">point_layer_to_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="n">i</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">track_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>    <span class="c1"># this is a stop prompt, we do nothing</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">point_prompts</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        <span class="k">return</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>    <span class="n">boxes</span><span class="p">,</span> <span class="n">masks</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">shape_layer_to_prompts</span><span class="p">(</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span> <span class="n">shape</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">track_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>    <span class="n">points</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">point_prompts</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>    <span class="n">seg</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">prompt_segmentation</span><span class="p">(</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">multiple_box_prompts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="n">image_embeddings</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">t</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>    <span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>    <span class="c1"># no prompts were given or prompts were invalid, skip segmentation</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>    <span class="k">if</span> <span class="n">seg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You either haven&#39;t provided any prompts or invalid prompts. The segmentation will be skipped.&quot;</span><span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="k">return</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>    <span class="c1"># clear the old segmentation for this track_id</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>    <span class="n">old_mask</span> <span class="o">=</span> <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">old_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>    <span class="c1"># set the new segmentation</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>    <span class="n">new_mask</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">new_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="c1">#</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="c1"># Functionality and widget to compute the image embeddings.</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="c1">#</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="k">def</span> <span class="nf">_process_tiling_inputs</span><span class="p">(</span><span class="n">tile_shape_x</span><span class="p">,</span> <span class="n">tile_shape_y</span><span class="p">,</span> <span class="n">halo_x</span><span class="p">,</span> <span class="n">halo_y</span><span class="p">):</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>    <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">tile_shape_x</span><span class="p">,</span> <span class="n">tile_shape_y</span><span class="p">)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="n">halo</span> <span class="o">=</span> <span class="p">(</span><span class="n">halo_x</span><span class="p">,</span> <span class="n">halo_y</span><span class="p">)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>    <span class="c1"># check if tile_shape/halo are not set: (0, 0)</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tile_shape</span><span class="p">):</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="n">tile_shape</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>    <span class="c1"># check if at least 1 param is given</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>    <span class="k">elif</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tile_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="k">if</span> <span class="n">max_val</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>  <span class="c1"># at least tile shape &gt;256</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="mi">256</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>    <span class="c1"># if both inputs given, check if smaller than 256</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>    <span class="k">elif</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="k">if</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Create a new tuple</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>        <span class="k">if</span> <span class="n">tile_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">tile_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">256</span><span class="p">)</span>  <span class="c1"># Create a new tuple with modified value</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">halo</span><span class="p">):</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="k">if</span> <span class="n">tile_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="n">halo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="n">halo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>    <span class="c1"># check if at least 1 param is given</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>    <span class="k">elif</span> <span class="n">halo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">halo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">halo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">halo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="c1"># don&#39;t apply halo if there is no tiling</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="k">if</span> <span class="n">tile_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            <span class="n">halo</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="n">halo</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>    <span class="k">return</span> <span class="n">tile_shape</span><span class="p">,</span> <span class="n">halo</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="k">class</span> <span class="nc">EmbeddingWidget</span><span class="p">(</span><span class="n">_WidgetBase</span><span class="p">):</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="c1"># Create a nested layout for the sections.</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="c1"># Section 1: Image and Model.</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="n">section1_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="n">section1_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_image_section</span><span class="p">())</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="n">section1_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_model_section</span><span class="p">())</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">section1_layout</span><span class="p">)</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="c1"># Section 2: Settings (collapsible).</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_settings_widget</span><span class="p">())</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="c1"># Section 3: The button to trigger the embedding computation.</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Compute Embeddings&quot;</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initialize_image</span><span class="p">)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;run_button&quot;</span><span class="p">))</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>    <span class="k">def</span> <span class="nf">_initialize_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="n">image_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">image_shape</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>    <span class="k">def</span> <span class="nf">_create_image_section</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="n">image_section</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="n">image_layer_widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Image Layer:&quot;</span><span class="p">)</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="c1"># image_layer_widget.setToolTip(get_tooltip(&quot;embedding&quot;, &quot;image&quot;)) #  this adds tooltip to label</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="n">image_section</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">image_layer_widget</span><span class="p">)</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="c1"># Setting a napari layer in QT, see:</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>        <span class="c1"># https://github.com/pyapp-kit/magicgui/blob/main/docs/examples/napari/napari_combine_qt.py</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span> <span class="o">=</span> <span class="n">create_widget</span><span class="p">(</span><span class="n">annotation</span><span class="o">=</span><span class="n">napari</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">native</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">))</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="n">image_section</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">native</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="k">return</span> <span class="n">image_section</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>    <span class="k">def</span> <span class="nf">_update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computed embeddings for&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="c1"># Update the widget itself. This is necessary because we may have loaded</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="c1"># some settings from the embedding file and have to reflect them in the widget.</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">_sync_embedding_widget</span><span class="p">(</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">,</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="n">checkpoint_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>            <span class="n">tile_shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="p">],</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>            <span class="n">halo</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="p">]</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="p">)</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="c1"># Set the default settings for this model in the autosegment widget if it is part of</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="c1"># the currently used plugin.</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="k">if</span> <span class="s2">&quot;autosegment&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="n">with_decoder</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>            <span class="n">vutil</span><span class="o">.</span><span class="n">_sync_autosegment_widget</span><span class="p">(</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;autosegment&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span> <span class="n">update_decoder</span><span class="o">=</span><span class="n">with_decoder</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>            <span class="p">)</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="c1"># Load the AMG/AIS state if we have a 3d segmentation plugin.</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;autosegment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="n">with_decoder</span><span class="p">:</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">_load_is_state</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">embedding_path</span><span class="p">)</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>            <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;autosegment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">with_decoder</span><span class="p">:</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">_load_amg_state</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">embedding_path</span><span class="p">)</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="c1"># Set the default settings for this model in the nd-segmentation widget if it is part of</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="c1"># the currently used plugin.</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="k">if</span> <span class="s2">&quot;segment_nd&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">:</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="n">vutil</span><span class="o">.</span><span class="n">_sync_ndsegment_widget</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;segment_nd&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>    <span class="k">def</span> <span class="nf">_create_model_section</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_DEFAULT_MODEL</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">models</span><span class="p">()</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="c1"># Filter out the decoders from the model list.</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;decoder&quot;</span><span class="p">)]</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_dropdown</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_choice_param</span><span class="p">(</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Model:&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="p">)</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="k">return</span> <span class="n">layout</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>    <span class="k">def</span> <span class="nf">_create_settings_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="n">setting_values</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;settings&quot;</span><span class="p">))</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>        <span class="c1"># Create UI for the device.</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="n">device_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">_available_devices</span><span class="p">()</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device_dropdown</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_choice_param</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">device_options</span><span class="p">,</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>                                                              <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;device&quot;</span><span class="p">))</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        <span class="c1"># Create UI for the save path.</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_path_param</span><span class="p">(</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="s2">&quot;embeddings_save_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">,</span> <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;embeddings save path:&quot;</span><span class="p">,</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;embeddings_save_path&quot;</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="p">)</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="c1"># Create UI for the custom weights.</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_path_param</span><span class="p">(</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="s2">&quot;custom_weights&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;custom weights path:&quot;</span><span class="p">,</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_weights&quot;</span><span class="p">)</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="p">)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="c1"># Create UI for the tile shape.</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_shape_param</span><span class="p">(</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="p">(</span><span class="s2">&quot;tile_x&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_y&quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="p">),</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;tiling&quot;</span><span class="p">)</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="p">)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="c1"># Create UI for the halo.</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">halo_x_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_shape_param</span><span class="p">(</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            <span class="p">(</span><span class="s2">&quot;halo_x&quot;</span><span class="p">,</span> <span class="s2">&quot;halo_y&quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="p">),</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;halo&quot;</span><span class="p">)</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="p">)</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="c1"># Create UI for prefering the decoder.</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefer_decoder</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_boolean_param</span><span class="p">(</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>            <span class="s2">&quot;prefer_decoder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefer_decoder</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Prefer Segmentation Decoder&quot;</span><span class="p">,</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;prefer_decoder&quot;</span><span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>        <span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">_make_collapsible</span><span class="p">(</span><span class="n">setting_values</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Embedding Settings&quot;</span><span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>    <span class="k">def</span> <span class="nf">_validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">        Validates the inputs for the annotation process and returns a dictionary</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">        containing information for message generation, or False if no messages are needed.</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">        This function performs the following checks:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">        - If an `embeddings_save_path` is provided:</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">            - Validates the image data signature by comparing it with the signature</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">            of the image data in the viewer&#39;s selection.</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">            - Checks for existing embeddings at the specified path.</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">                - If existing embeddings are found, it attempts to load parameters</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">                like tile shape, halo, and model type from the Zarr attributes.</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">                - An informational message is generated based on the loaded parameters.</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">                - If loading existing embeddings fails, an error message is generated.</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">                - If no existing embeddings are found, an informational message is generated.</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">        - If no `embeddings_save_path` is provided, the function returns None.</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">        Returns:</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">            bool: True if the computation should be aborted, otherwise False.</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="c1"># Check if we have an existing embedding path.</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="c1"># If yes we check the data signature of these embeddings against the selected image</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="c1"># and we ask the user if they want to load these embeddings.</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">):</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                <span class="c1"># Validate that the embeddings are complete.</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>                <span class="c1"># Note: &#39;input_size&#39; is the last value set in the attrs of f,</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>                <span class="c1"># so we can use it as a proxy to check if the embeddings are fully computed</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="k">if</span> <span class="s2">&quot;input_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The embeddings at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="si">}</span><span class="s2"> are incomplete. &quot;</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                           <span class="s2">&quot;Specify a different path or remove them.&quot;</span><span class="p">)</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                    <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                <span class="c1"># Validate image data signature.</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                <span class="k">if</span> <span class="s2">&quot;data_signature&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>                    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>                    <span class="n">img_signature</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_compute_data_signature</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>                    <span class="k">if</span> <span class="n">img_signature</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;data_signature&quot;</span><span class="p">]:</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The embeddings don&#39;t match with the image: </span><span class="si">{</span><span class="n">img_signature</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_signature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>                        <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>                <span class="c1"># Load existing parameters.</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;model_type&quot;</span><span class="p">])</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>                <span class="k">if</span> <span class="s2">&quot;tile_shape&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tile_shape&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tile_shape&quot;</span><span class="p">]</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;halo&quot;</span><span class="p">]</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>                    <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>                        <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load embeddings for model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2"> with tile shape: &quot;</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="si">}</span><span class="s2"> and halo: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>                    <span class="p">}</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>                    <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>                        <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Load embeddings for model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>                    <span class="p">}</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>                <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>                <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>                    <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to load image embeddings: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>                <span class="p">}</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>                <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="c1"># Otherwise we either don&#39;t have an embedding path or it is empty. We can proceed in both cases.</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="c1"># Validate user inputs.</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_validate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_inputs</span><span class="p">():</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="k">return</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="c1"># Get the image.</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="c1"># Update the image embeddings:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>        <span class="c1"># Reset the state.</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">reset_state</span><span class="p">()</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="c1"># Get image dimensions.</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="n">ndim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>            <span class="n">ndim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        <span class="c1"># Process tile_shape and halo, set other data.</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="n">tile_shape</span><span class="p">,</span> <span class="n">halo</span> <span class="o">=</span> <span class="n">_process_tiling_inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="p">)</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="n">save_path</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        <span class="n">image_data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="c1"># Set up progress bar and signals for using it within a threadworker.</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="nd">@thread_worker</span><span class="p">()</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="k">def</span> <span class="nf">compute_image_embedding</span><span class="p">():</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>            <span class="k">def</span> <span class="nf">pbar_init</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">initialize_predictor</span><span class="p">(</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>                <span class="n">image_data</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span> <span class="n">tile_shape</span><span class="o">=</span><span class="n">tile_shape</span><span class="p">,</span> <span class="n">halo</span><span class="o">=</span><span class="n">halo</span><span class="p">,</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>                <span class="n">prefer_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefer_decoder</span><span class="p">,</span> <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>                <span class="n">pbar_update</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>            <span class="p">)</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">compute_image_embedding</span><span class="p">()</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_model</span><span class="p">)</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="c1">#</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a><span class="c1"># Functionality and widget for nd segmentation.</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="c1">#</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="k">def</span> <span class="nf">_update_lineage</span><span class="p">(</span><span class="n">viewer</span><span class="p">):</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Updated the lineage after recording a division event.</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">    This helper function is needed by &#39;track_object&#39;.</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>    <span class="n">tracking_widget</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>    <span class="n">mother</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>    <span class="k">assert</span> <span class="n">mother</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">lineage</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="p">[</span><span class="n">mother</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>    <span class="n">daughter1</span><span class="p">,</span> <span class="n">daughter2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="p">[</span><span class="n">mother</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">daughter1</span><span class="p">,</span> <span class="n">daughter2</span><span class="p">]</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="p">[</span><span class="n">daughter1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>    <span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="p">[</span><span class="n">daughter2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>    <span class="c1"># Update the choices in the track_id menu so that it contains the new track ids.</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>    <span class="n">track_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>    <span class="n">tracking_widget</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">track_ids</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">property_choices</span><span class="p">[</span><span class="s2">&quot;track_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">track_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">track_id</span> <span class="ow">in</span> <span class="n">track_ids</span><span class="p">]</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>    <span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">property_choices</span><span class="p">[</span><span class="s2">&quot;track_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">track_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">track_id</span> <span class="ow">in</span> <span class="n">track_ids</span><span class="p">]</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="k">class</span> <span class="nc">SegmentNDWidget</span><span class="p">(</span><span class="n">_WidgetBase</span><span class="p">):</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">tracking</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span> <span class="o">=</span> <span class="n">viewer</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="o">=</span> <span class="n">tracking</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="c1"># Add the settings.</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_settings</span><span class="p">()</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        <span class="c1"># Add the run button.</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="n">button_title</span> <span class="o">=</span> <span class="s2">&quot;Segment All Frames [Shift-S]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="k">else</span> <span class="s2">&quot;Segment All Slices [Shift-S]&quot;</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="n">button_title</span><span class="p">)</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>    <span class="k">def</span> <span class="nf">_create_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="n">setting_values</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;settings&quot;</span><span class="p">))</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>        <span class="c1"># Create the UI for the projection modes.</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s2">&quot;points&quot;</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projection_dropdown</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_choice_param</span><span class="p">(</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="n">PROJECTION_MODES</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;projection_dropdown&quot;</span><span class="p">)</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>            <span class="p">)</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>        <span class="c1"># Create the UI element for the IOU threshold.</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>            <span class="s2">&quot;iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;iou_threshold&quot;</span><span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>            <span class="p">)</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>        <span class="c1"># Create the UI element for the box extension.</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span> <span class="o">=</span> <span class="mf">0.05</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_extension_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>            <span class="s2">&quot;box_extension&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;box_extension&quot;</span><span class="p">)</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>            <span class="p">)</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="c1"># Create the UI element for the motion smoothing (if we have the tracking widget).</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span><span class="p">:</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                <span class="s2">&quot;motion_smoothing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;motion_smoothing&quot;</span><span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>                <span class="p">)</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">_make_collapsible</span><span class="p">(</span><span class="n">setting_values</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Segmentation Settings&quot;</span><span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>    <span class="k">def</span> <span class="nf">_run_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="nd">@thread_worker</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="k">def</span> <span class="nf">tracking_impl</span><span class="p">():</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>            <span class="n">shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Track object&quot;</span><span class="p">)</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>            <span class="c1"># Step 1: Segment all slices with prompts.</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">stop_upper</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">segment_slices_with_prompts</span><span class="p">(</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">track_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span><span class="p">,</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>            <span class="p">)</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>            <span class="c1"># Step 2: Track the object starting from the lowest annotated slice.</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">has_division</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">track_from_prompts</span><span class="p">(</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">,</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">stop_upper</span><span class="p">,</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>                <span class="n">motion_smoothing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing</span><span class="p">,</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>                <span class="n">box_extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span><span class="p">,</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>            <span class="p">)</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>            <span class="k">return</span> <span class="n">seg</span><span class="p">,</span> <span class="n">has_division</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">ret_val</span><span class="p">):</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">has_division</span> <span class="o">=</span> <span class="n">ret_val</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>            <span class="c1"># If a division has occurred and it&#39;s the first time it occurred for this track</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>            <span class="c1"># then we need to create the two daughter tracks and update the lineage.</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>            <span class="k">if</span> <span class="n">has_division</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                <span class="n">_update_lineage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>            <span class="c1"># Clear the old track mask.</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="c1"># Set the new object mask.</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">tracking_impl</span><span class="p">()</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>    <span class="k">def</span> <span class="nf">_run_volumetric_segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>        <span class="nd">@thread_worker</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="k">def</span> <span class="nf">volumetric_segmentation_impl</span><span class="p">():</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>            <span class="n">shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Segment object&quot;</span><span class="p">)</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="c1"># Step 1: Segment all slices with prompts.</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">stop_lower</span><span class="p">,</span> <span class="n">stop_upper</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">segment_slices_with_prompts</span><span class="p">(</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>            <span class="p">)</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>            <span class="c1"># Step 2: Segment the rest of the volume based on projecting prompts.</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">segment_mask_in_volume</span><span class="p">(</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>                <span class="n">seg</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>                <span class="n">stop_lower</span><span class="p">,</span> <span class="n">stop_upper</span><span class="p">,</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>                <span class="n">iou_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>                <span class="n">box_extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span><span class="p">,</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>            <span class="p">)</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">z_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="k">return</span> <span class="n">seg</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">seg</span><span class="p">):</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">volumetric_segmentation_impl</span><span class="p">()</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="k">if</span> <span class="n">_validate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">):</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>        <span class="k">if</span> <span class="n">_validate_prompts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">):</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span><span class="p">:</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_tracking</span><span class="p">()</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_volumetric_segmentation</span><span class="p">()</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="c1">#</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="c1"># The functionality and widgets for automatic segmentation.</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="c1">#</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="c1"># Messy amg state handling, would be good to refactor this properly at some point.</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="k">def</span> <span class="nf">_handle_amg_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pbar_init</span><span class="p">,</span> <span class="n">pbar_update</span><span class="p">):</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">amg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>        <span class="n">is_tiled</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">[</span><span class="s2">&quot;input_size&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">amg</span> <span class="o">=</span> <span class="n">instance_segmentation</span><span class="o">.</span><span class="n">get_amg</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="n">is_tiled</span><span class="p">,</span> <span class="n">decoder</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">decoder</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>    <span class="c1"># Further optimization: refactor parts of this so that we can also use it in the automatic 3d segmentation fucnction</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>    <span class="c1"># For 3D we store the amg state in a dict and check if it is computed already.</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>        <span class="k">assert</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span><span class="p">:</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>            <span class="n">amg_state_i</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">amg</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">amg_state_i</span><span class="p">)</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>            <span class="n">dummy_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">amg</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>                <span class="n">dummy_image</span><span class="p">,</span> <span class="n">image_embeddings</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="n">pbar_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span> <span class="n">pbar_update</span><span class="o">=</span><span class="n">pbar_update</span><span class="p">,</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>            <span class="n">amg_state_i</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">amg</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">amg_state_i</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>            <span class="n">cache_folder</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_folder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>            <span class="k">if</span> <span class="n">cache_folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>                <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;state-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">)</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">amg_state_i</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="n">cache_path</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>            <span class="k">if</span> <span class="n">cache_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>                <span class="n">save_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;state-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">cache_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>                    <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">save_key</span><span class="p">)</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>                    <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;foreground&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">amg_state_i</span><span class="p">[</span><span class="s2">&quot;foreground&quot;</span><span class="p">],</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>                    <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;boundary_distances&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">amg_state_i</span><span class="p">[</span><span class="s2">&quot;boundary_distances&quot;</span><span class="p">],</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>                    <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;center_distances&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">amg_state_i</span><span class="p">[</span><span class="s2">&quot;center_distances&quot;</span><span class="p">],</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>    <span class="c1"># Otherwise (2d segmentation) we just check if the amg is initialized or not.</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="k">elif</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">amg</span><span class="o">.</span><span class="n">is_initialized</span><span class="p">:</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>        <span class="k">assert</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="c1"># We don&#39;t need to pass the actual image data here, since the embeddings are passed.</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>        <span class="c1"># (The image data is only used by the amg to compute image embeddings, so not needed here.)</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>        <span class="n">dummy_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">amg</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>            <span class="n">dummy_image</span><span class="p">,</span> <span class="n">image_embeddings</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>            <span class="n">verbose</span><span class="o">=</span><span class="n">pbar_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span> <span class="n">pbar_update</span><span class="o">=</span><span class="n">pbar_update</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>        <span class="p">)</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="k">def</span> <span class="nf">_instance_segmentation_impl</span><span class="p">(</span><span class="n">with_background</span><span class="p">,</span> <span class="n">min_object_size</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pbar_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pbar_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>    <span class="n">_handle_amg_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pbar_init</span><span class="p">,</span> <span class="n">pbar_update</span><span class="p">)</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>    <span class="n">seg</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">amg</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>        <span class="n">shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>        <span class="n">seg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint32&quot;</span><span class="p">)</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>        <span class="n">seg</span> <span class="o">=</span> <span class="n">instance_segmentation</span><span class="o">.</span><span class="n">mask_data_to_segmentation</span><span class="p">(</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">with_background</span><span class="o">=</span><span class="n">with_background</span><span class="p">,</span> <span class="n">min_object_size</span><span class="o">=</span><span class="n">min_object_size</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>        <span class="p">)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>    <span class="k">return</span> <span class="n">seg</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="k">class</span> <span class="nc">AutoSegmentWidget</span><span class="p">(</span><span class="n">_WidgetBase</span><span class="p">):</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">with_decoder</span><span class="p">,</span> <span class="n">volumetric</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span> <span class="o">=</span> <span class="n">viewer</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span> <span class="o">=</span> <span class="n">with_decoder</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span> <span class="o">=</span> <span class="n">volumetric</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_create_widget</span><span class="p">()</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>    <span class="k">def</span> <span class="nf">_create_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="c1"># Add the switch for segmenting the slice vs. the volume if we have a volume.</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span><span class="p">:</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_volumetric_switch</span><span class="p">())</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>        <span class="c1"># Add the nested settings widget.</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_settings</span><span class="p">()</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>        <span class="c1"># Add the run button.</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Automatic Segmentation&quot;</span><span class="p">)</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;run_button&quot;</span><span class="p">))</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>    <span class="k">def</span> <span class="nf">_reset_segmentation_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_decoder</span><span class="p">):</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>        <span class="c1"># If we already have the same segmentation mode we don&#39;t need to do anything.</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="k">if</span> <span class="n">with_decoder</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="k">return</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>        <span class="c1"># Otherwise we change the value of with_decoder.</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span> <span class="o">=</span> <span class="n">with_decoder</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="c1"># Then we clear the whole widget.</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>        <span class="k">while</span> <span class="n">layout</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>            <span class="n">child</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">takeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="p">():</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>                <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        <span class="c1"># And then we reset it.</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_create_widget</span><span class="p">()</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>    <span class="k">def</span> <span class="nf">_create_volumetric_switch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_boolean_param</span><span class="p">(</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>            <span class="s2">&quot;apply_to_volume&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Apply to Volume&quot;</span><span class="p">,</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;apply_to_volume&quot;</span><span class="p">)</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>            <span class="p">)</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>    <span class="k">def</span> <span class="nf">_add_common_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>        <span class="c1"># Create the UI element for min object size.</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="s2">&quot;min_object_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;min_object_size&quot;</span><span class="p">)</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>        <span class="p">)</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="c1"># Create the UI element for with background.</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_boolean_param</span><span class="p">(</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>            <span class="s2">&quot;with_background&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;with_background&quot;</span><span class="p">)</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>            <span class="p">))</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="c1"># Add extra settings for volumetric segmentation: gap_closing and min_extent.</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span><span class="p">:</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gap_closing</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gap_closing_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>                <span class="s2">&quot;gap_closing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap_closing</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>                <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;gap_closing&quot;</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>                <span class="p">)</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>            <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">min_extent</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">min_extent_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>                <span class="s2">&quot;min_extent&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_extent</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>                <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;min_extent&quot;</span><span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>                <span class="p">)</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>            <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>    <span class="k">def</span> <span class="nf">_ais_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        <span class="c1"># Create the UI element for center_distance_threshold.</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>            <span class="s2">&quot;center_distance_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh</span><span class="p">,</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;center_distance_thresh&quot;</span><span class="p">)</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>        <span class="p">)</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="c1"># Create the UI element for boundary_distance_threshold.</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>            <span class="s2">&quot;boundary_distance_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh</span><span class="p">,</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_distance_thresh&quot;</span><span class="p">)</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>        <span class="p">)</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        <span class="c1"># Add min_object_size and with_background</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_common_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>    <span class="k">def</span> <span class="nf">_amg_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="c1"># Create the UI element for pred_iou_thresh.</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh</span> <span class="o">=</span> <span class="mf">0.88</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>            <span class="s2">&quot;pred_iou_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh</span><span class="p">,</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;pred_iou_thresh&quot;</span><span class="p">)</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>            <span class="p">)</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="c1"># Create the UI element for stability score thresh.</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>            <span class="s2">&quot;stability_score_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh</span><span class="p">,</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;stability_score_thresh&quot;</span><span class="p">)</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="p">)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>        <span class="c1"># Create the UI element for box nms thresh.</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh</span> <span class="o">=</span> <span class="mf">0.7</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>            <span class="s2">&quot;box_nms_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh</span><span class="p">,</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;box_nms_thresh&quot;</span><span class="p">)</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>            <span class="p">)</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>        <span class="c1"># Add min_object_size and with_background</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_common_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>    <span class="k">def</span> <span class="nf">_create_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>        <span class="n">setting_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ais_settings</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amg_settings</span><span class="p">()</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">_make_collapsible</span><span class="p">(</span><span class="n">setting_values</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Automatic Segmentation Settings&quot;</span><span class="p">)</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>    <span class="k">def</span> <span class="nf">_empty_segmentation_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The automatic segmentation result does not contain any objects.&quot;</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Setting a smaller value for &#39;min_object_size&#39; may help.&quot;</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Setting smaller values for &#39;pred_iou_thresh&#39; and &#39;stability_score_thresh&#39; may also help.&quot;</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>    <span class="k">def</span> <span class="nf">_run_segmentation_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>        <span class="nd">@thread_worker</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>        <span class="k">def</span> <span class="nf">seg_impl</span><span class="p">():</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>            <span class="k">def</span> <span class="nf">pbar_init</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>            <span class="n">seg</span> <span class="o">=</span> <span class="n">_instance_segmentation_impl</span><span class="p">(</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>                <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>                <span class="n">pbar_update</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>                <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>            <span class="p">)</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>            <span class="k">return</span> <span class="n">seg</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">seg</span><span class="p">):</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>            <span class="n">is_empty</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>            <span class="k">if</span> <span class="n">is_empty</span><span class="p">:</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_empty_segmentation_warning</span><span class="p">()</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">seg_impl</span><span class="p">()</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>    <span class="c1"># We refuse to run 3D segmentation with the AMG unless we have a GPU or all embeddings</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>    <span class="c1"># are precomputed. Otherwise this would take too long.</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>    <span class="k">def</span> <span class="nf">_allow_segment_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="n">predictor</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">predictor</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mps&quot;</span><span class="p">:</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>            <span class="n">n_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="n">embeddings_are_precomputed</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">amg_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">amg_state</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_slices</span><span class="p">)</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">embeddings_are_precomputed</span><span class="p">:</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>    <span class="k">def</span> <span class="nf">_run_segmentation_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>        <span class="n">allow_segment_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_segment_3d</span><span class="p">()</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_segment_3d</span><span class="p">:</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Volumetric segmentation with AMG is only supported if you have a GPU.&quot;</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>            <span class="p">}</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>            <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>        <span class="nd">@thread_worker</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>        <span class="k">def</span> <span class="nf">seg_impl</span><span class="p">():</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>            <span class="n">segmentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>            <span class="k">def</span> <span class="nf">pbar_init</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>            <span class="n">pbar_init</span><span class="p">(</span><span class="n">segmentation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Segment volume&quot;</span><span class="p">)</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>            <span class="c1"># Further optimization: parallelize if state is precomputed for all slices</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">segmentation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>                <span class="n">seg</span> <span class="o">=</span> <span class="n">_instance_segmentation_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>                <span class="n">seg_max</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>                <span class="k">if</span> <span class="n">seg_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>                    <span class="k">continue</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>                <span class="n">seg</span><span class="p">[</span><span class="n">seg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">seg_max</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>                <span class="n">segmentation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_reset</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="n">segmentation</span> <span class="o">=</span> <span class="n">merge_instance_segmentation_3d</span><span class="p">(</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>                <span class="n">segmentation</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">with_background</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>                <span class="n">gap_closing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_closing</span><span class="p">,</span> <span class="n">min_z_extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_extent</span><span class="p">,</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>                <span class="n">pbar_update</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="p">)</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>            <span class="k">return</span> <span class="n">segmentation</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">segmentation</span><span class="p">):</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="n">is_empty</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>            <span class="k">if</span> <span class="n">is_empty</span><span class="p">:</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_empty_segmentation_warning</span><span class="p">()</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">segmentation</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">seg_impl</span><span class="p">()</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>        <span class="k">if</span> <span class="n">_validate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">):</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>                <span class="s2">&quot;center_distance_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh</span><span class="p">,</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>                <span class="s2">&quot;boundary_distance_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh</span><span class="p">,</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>                <span class="s2">&quot;min_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>            <span class="p">}</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>                <span class="s2">&quot;pred_iou_thresh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh</span><span class="p">,</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>                <span class="s2">&quot;stability_score_thresh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh</span><span class="p">,</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>                <span class="s2">&quot;box_nms_thresh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh</span><span class="p">,</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>            <span class="p">}</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span><span class="p">:</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_segmentation_3d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span><span class="p">:</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_segmentation_2d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_segmentation_2d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>        <span class="n">_select_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">,</span> <span class="s2">&quot;auto_segmentation&quot;</span><span class="p">)</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span></pre></div>


            </section>
                <section id="PBarSignals">
                            <input id="PBarSignals-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PBarSignals</span><wbr>(<span class="base">PyQt5.QtCore.QObject</span>):

                <label class="view-source-button" for="PBarSignals-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PBarSignals"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PBarSignals-229"><a href="#PBarSignals-229"><span class="linenos">229</span></a><span class="k">class</span> <span class="nc">PBarSignals</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span><span id="PBarSignals-230"><a href="#PBarSignals-230"><span class="linenos">230</span></a>    <span class="n">pbar_total</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="PBarSignals-231"><a href="#PBarSignals-231"><span class="linenos">231</span></a>    <span class="n">pbar_update</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="PBarSignals-232"><a href="#PBarSignals-232"><span class="linenos">232</span></a>    <span class="n">pbar_description</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="PBarSignals-233"><a href="#PBarSignals-233"><span class="linenos">233</span></a>    <span class="n">pbar_stop</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
</span><span id="PBarSignals-234"><a href="#PBarSignals-234"><span class="linenos">234</span></a>    <span class="n">pbar_reset</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>QObject(parent: typing.Optional[QObject] = None)</p>
</div>


                            <div id="PBarSignals.pbar_total" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pbar_total</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#PBarSignals.pbar_total"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="PBarSignals.pbar_update" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pbar_update</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#PBarSignals.pbar_update"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="PBarSignals.pbar_description" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pbar_description</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#PBarSignals.pbar_description"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="PBarSignals.pbar_stop" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pbar_stop</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#PBarSignals.pbar_stop"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div id="PBarSignals.pbar_reset" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pbar_reset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#PBarSignals.pbar_reset"></a>
    
            <div class="docstring"><p>pyqtSignal(*types, name: str = ..., revision: int = ..., arguments: Sequence = ...) -> PYQT_SIGNAL</p>

<p>types is normally a sequence of individual types.  Each type is either a
type object or a string that is the name of a C++ type.  Alternatively
each type could itself be a sequence of types each describing a different
overloaded signal.
name is the optional C++ name of the signal.  If it is not specified then
the name of the class attribute that is bound to the signal is used.
revision is the optional revision of the signal that is exported to QML.
If it is not specified then 0 is used.
arguments is the optional sequence of the names of the signal's arguments.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>sip.simplewrapper</dt>
                                <dd id="PBarSignals.__init__" class="function">simplewrapper</dd>

            </div>
            <div><dt>PyQt5.QtCore.QObject</dt>
                                <dd id="PBarSignals.blockSignals" class="function">blockSignals</dd>
                <dd id="PBarSignals.childEvent" class="function">childEvent</dd>
                <dd id="PBarSignals.children" class="function">children</dd>
                <dd id="PBarSignals.connectNotify" class="function">connectNotify</dd>
                <dd id="PBarSignals.customEvent" class="function">customEvent</dd>
                <dd id="PBarSignals.deleteLater" class="function">deleteLater</dd>
                <dd id="PBarSignals.disconnect" class="function">disconnect</dd>
                <dd id="PBarSignals.disconnectNotify" class="function">disconnectNotify</dd>
                <dd id="PBarSignals.dumpObjectInfo" class="function">dumpObjectInfo</dd>
                <dd id="PBarSignals.dumpObjectTree" class="function">dumpObjectTree</dd>
                <dd id="PBarSignals.dynamicPropertyNames" class="function">dynamicPropertyNames</dd>
                <dd id="PBarSignals.event" class="function">event</dd>
                <dd id="PBarSignals.eventFilter" class="function">eventFilter</dd>
                <dd id="PBarSignals.findChild" class="function">findChild</dd>
                <dd id="PBarSignals.findChildren" class="function">findChildren</dd>
                <dd id="PBarSignals.inherits" class="function">inherits</dd>
                <dd id="PBarSignals.installEventFilter" class="function">installEventFilter</dd>
                <dd id="PBarSignals.isSignalConnected" class="function">isSignalConnected</dd>
                <dd id="PBarSignals.isWidgetType" class="function">isWidgetType</dd>
                <dd id="PBarSignals.isWindowType" class="function">isWindowType</dd>
                <dd id="PBarSignals.killTimer" class="function">killTimer</dd>
                <dd id="PBarSignals.metaObject" class="function">metaObject</dd>
                <dd id="PBarSignals.moveToThread" class="function">moveToThread</dd>
                <dd id="PBarSignals.objectName" class="function">objectName</dd>
                <dd id="PBarSignals.parent" class="function">parent</dd>
                <dd id="PBarSignals.property" class="function">property</dd>
                <dd id="PBarSignals.pyqtConfigure" class="function">pyqtConfigure</dd>
                <dd id="PBarSignals.receivers" class="function">receivers</dd>
                <dd id="PBarSignals.removeEventFilter" class="function">removeEventFilter</dd>
                <dd id="PBarSignals.sender" class="function">sender</dd>
                <dd id="PBarSignals.senderSignalIndex" class="function">senderSignalIndex</dd>
                <dd id="PBarSignals.setObjectName" class="function">setObjectName</dd>
                <dd id="PBarSignals.setParent" class="function">setParent</dd>
                <dd id="PBarSignals.setProperty" class="function">setProperty</dd>
                <dd id="PBarSignals.signalsBlocked" class="function">signalsBlocked</dd>
                <dd id="PBarSignals.startTimer" class="function">startTimer</dd>
                <dd id="PBarSignals.thread" class="function">thread</dd>
                <dd id="PBarSignals.timerEvent" class="function">timerEvent</dd>
                <dd id="PBarSignals.tr" class="function">tr</dd>
                <dd id="PBarSignals.staticMetaObject" class="variable">staticMetaObject</dd>
                <dd id="PBarSignals.objectNameChanged" class="function">objectNameChanged</dd>
                <dd id="PBarSignals.destroyed" class="function">destroyed</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="InfoDialog">
                            <input id="InfoDialog-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">InfoDialog</span><wbr>(<span class="base">PyQt5.QtWidgets.QDialog</span>):

                <label class="view-source-button" for="InfoDialog-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InfoDialog"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InfoDialog-237"><a href="#InfoDialog-237"><span class="linenos">237</span></a><span class="k">class</span> <span class="nc">InfoDialog</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QDialog</span><span class="p">):</span>
</span><span id="InfoDialog-238"><a href="#InfoDialog-238"><span class="linenos">238</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span id="InfoDialog-239"><a href="#InfoDialog-239"><span class="linenos">239</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="InfoDialog-240"><a href="#InfoDialog-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="InfoDialog-241"><a href="#InfoDialog-241"><span class="linenos">241</span></a>
</span><span id="InfoDialog-242"><a href="#InfoDialog-242"><span class="linenos">242</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="InfoDialog-243"><a href="#InfoDialog-243"><span class="linenos">243</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</span><span id="InfoDialog-244"><a href="#InfoDialog-244"><span class="linenos">244</span></a>
</span><span id="InfoDialog-245"><a href="#InfoDialog-245"><span class="linenos">245</span></a>        <span class="c1"># Add buttons</span>
</span><span id="InfoDialog-246"><a href="#InfoDialog-246"><span class="linenos">246</span></a>        <span class="n">button_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>  <span class="c1"># Use QHBoxLayout for buttons side-by-side</span>
</span><span id="InfoDialog-247"><a href="#InfoDialog-247"><span class="linenos">247</span></a>        <span class="n">accept_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</span><span id="InfoDialog-248"><a href="#InfoDialog-248"><span class="linenos">248</span></a>        <span class="n">accept_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_clicked</span><span class="p">(</span><span class="n">accept_button</span><span class="p">))</span>  <span class="c1"># Connect to clicked signal</span>
</span><span id="InfoDialog-249"><a href="#InfoDialog-249"><span class="linenos">249</span></a>        <span class="n">button_box</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">accept_button</span><span class="p">)</span>
</span><span id="InfoDialog-250"><a href="#InfoDialog-250"><span class="linenos">250</span></a>
</span><span id="InfoDialog-251"><a href="#InfoDialog-251"><span class="linenos">251</span></a>        <span class="n">cancel_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">)</span>
</span><span id="InfoDialog-252"><a href="#InfoDialog-252"><span class="linenos">252</span></a>        <span class="n">cancel_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_clicked</span><span class="p">(</span><span class="n">cancel_button</span><span class="p">))</span>  <span class="c1"># Connect to clicked signal</span>
</span><span id="InfoDialog-253"><a href="#InfoDialog-253"><span class="linenos">253</span></a>        <span class="n">button_box</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">cancel_button</span><span class="p">)</span>
</span><span id="InfoDialog-254"><a href="#InfoDialog-254"><span class="linenos">254</span></a>
</span><span id="InfoDialog-255"><a href="#InfoDialog-255"><span class="linenos">255</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">button_box</span><span class="p">)</span>
</span><span id="InfoDialog-256"><a href="#InfoDialog-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="InfoDialog-257"><a href="#InfoDialog-257"><span class="linenos">257</span></a>
</span><span id="InfoDialog-258"><a href="#InfoDialog-258"><span class="linenos">258</span></a>    <span class="k">def</span> <span class="nf">button_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
</span><span id="InfoDialog-259"><a href="#InfoDialog-259"><span class="linenos">259</span></a>        <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OK&quot;</span><span class="p">:</span>
</span><span id="InfoDialog-260"><a href="#InfoDialog-260"><span class="linenos">260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>  <span class="c1"># Accept the dialog</span>
</span><span id="InfoDialog-261"><a href="#InfoDialog-261"><span class="linenos">261</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="InfoDialog-262"><a href="#InfoDialog-262"><span class="linenos">262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>  <span class="c1"># Reject the dialog (Cancel)</span>
</span></pre></div>


            <div class="docstring"><p>QDialog(parent: typing.Optional[QWidget] = None, flags: Union[Qt.WindowFlags, Qt.WindowType] = Qt.WindowFlags())</p>
</div>


                            <div id="InfoDialog.__init__" class="classattr">
                                        <input id="InfoDialog.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">InfoDialog</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">title</span>, </span><span class="param"><span class="n">message</span></span>)</span>

                <label class="view-source-button" for="InfoDialog.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InfoDialog.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InfoDialog.__init__-238"><a href="#InfoDialog.__init__-238"><span class="linenos">238</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span id="InfoDialog.__init__-239"><a href="#InfoDialog.__init__-239"><span class="linenos">239</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="InfoDialog.__init__-240"><a href="#InfoDialog.__init__-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span id="InfoDialog.__init__-241"><a href="#InfoDialog.__init__-241"><span class="linenos">241</span></a>
</span><span id="InfoDialog.__init__-242"><a href="#InfoDialog.__init__-242"><span class="linenos">242</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="InfoDialog.__init__-243"><a href="#InfoDialog.__init__-243"><span class="linenos">243</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</span><span id="InfoDialog.__init__-244"><a href="#InfoDialog.__init__-244"><span class="linenos">244</span></a>
</span><span id="InfoDialog.__init__-245"><a href="#InfoDialog.__init__-245"><span class="linenos">245</span></a>        <span class="c1"># Add buttons</span>
</span><span id="InfoDialog.__init__-246"><a href="#InfoDialog.__init__-246"><span class="linenos">246</span></a>        <span class="n">button_box</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>  <span class="c1"># Use QHBoxLayout for buttons side-by-side</span>
</span><span id="InfoDialog.__init__-247"><a href="#InfoDialog.__init__-247"><span class="linenos">247</span></a>        <span class="n">accept_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;OK&quot;</span><span class="p">)</span>
</span><span id="InfoDialog.__init__-248"><a href="#InfoDialog.__init__-248"><span class="linenos">248</span></a>        <span class="n">accept_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_clicked</span><span class="p">(</span><span class="n">accept_button</span><span class="p">))</span>  <span class="c1"># Connect to clicked signal</span>
</span><span id="InfoDialog.__init__-249"><a href="#InfoDialog.__init__-249"><span class="linenos">249</span></a>        <span class="n">button_box</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">accept_button</span><span class="p">)</span>
</span><span id="InfoDialog.__init__-250"><a href="#InfoDialog.__init__-250"><span class="linenos">250</span></a>
</span><span id="InfoDialog.__init__-251"><a href="#InfoDialog.__init__-251"><span class="linenos">251</span></a>        <span class="n">cancel_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Cancel&quot;</span><span class="p">)</span>
</span><span id="InfoDialog.__init__-252"><a href="#InfoDialog.__init__-252"><span class="linenos">252</span></a>        <span class="n">cancel_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">button_clicked</span><span class="p">(</span><span class="n">cancel_button</span><span class="p">))</span>  <span class="c1"># Connect to clicked signal</span>
</span><span id="InfoDialog.__init__-253"><a href="#InfoDialog.__init__-253"><span class="linenos">253</span></a>        <span class="n">button_box</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">cancel_button</span><span class="p">)</span>
</span><span id="InfoDialog.__init__-254"><a href="#InfoDialog.__init__-254"><span class="linenos">254</span></a>
</span><span id="InfoDialog.__init__-255"><a href="#InfoDialog.__init__-255"><span class="linenos">255</span></a>        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">button_box</span><span class="p">)</span>
</span><span id="InfoDialog.__init__-256"><a href="#InfoDialog.__init__-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="InfoDialog.button_clicked" class="classattr">
                                        <input id="InfoDialog.button_clicked-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">button_clicked</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">button</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="InfoDialog.button_clicked-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InfoDialog.button_clicked"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InfoDialog.button_clicked-258"><a href="#InfoDialog.button_clicked-258"><span class="linenos">258</span></a>    <span class="k">def</span> <span class="nf">button_clicked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button</span><span class="p">):</span>
</span><span id="InfoDialog.button_clicked-259"><a href="#InfoDialog.button_clicked-259"><span class="linenos">259</span></a>        <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OK&quot;</span><span class="p">:</span>
</span><span id="InfoDialog.button_clicked-260"><a href="#InfoDialog.button_clicked-260"><span class="linenos">260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>  <span class="c1"># Accept the dialog</span>
</span><span id="InfoDialog.button_clicked-261"><a href="#InfoDialog.button_clicked-261"><span class="linenos">261</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="InfoDialog.button_clicked-262"><a href="#InfoDialog.button_clicked-262"><span class="linenos">262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>  <span class="c1"># Reject the dialog (Cancel)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>PyQt5.QtWidgets.QDialog</dt>
                                <dd id="InfoDialog.DialogCode" class="class">DialogCode</dd>
                <dd id="InfoDialog.accept" class="function">accept</dd>
                <dd id="InfoDialog.closeEvent" class="function">closeEvent</dd>
                <dd id="InfoDialog.contextMenuEvent" class="function">contextMenuEvent</dd>
                <dd id="InfoDialog.done" class="function">done</dd>
                <dd id="InfoDialog.eventFilter" class="function">eventFilter</dd>
                <dd id="InfoDialog.exec" class="function">exec</dd>
                <dd id="InfoDialog.exec_" class="function">exec_</dd>
                <dd id="InfoDialog.isSizeGripEnabled" class="function">isSizeGripEnabled</dd>
                <dd id="InfoDialog.keyPressEvent" class="function">keyPressEvent</dd>
                <dd id="InfoDialog.minimumSizeHint" class="function">minimumSizeHint</dd>
                <dd id="InfoDialog.open" class="function">open</dd>
                <dd id="InfoDialog.reject" class="function">reject</dd>
                <dd id="InfoDialog.resizeEvent" class="function">resizeEvent</dd>
                <dd id="InfoDialog.result" class="function">result</dd>
                <dd id="InfoDialog.setModal" class="function">setModal</dd>
                <dd id="InfoDialog.setResult" class="function">setResult</dd>
                <dd id="InfoDialog.setSizeGripEnabled" class="function">setSizeGripEnabled</dd>
                <dd id="InfoDialog.setVisible" class="function">setVisible</dd>
                <dd id="InfoDialog.showEvent" class="function">showEvent</dd>
                <dd id="InfoDialog.sizeHint" class="function">sizeHint</dd>
                <dd id="InfoDialog.Accepted" class="variable">Accepted</dd>
                <dd id="InfoDialog.Rejected" class="variable">Rejected</dd>
                <dd id="InfoDialog.rejected" class="function">rejected</dd>
                <dd id="InfoDialog.finished" class="function">finished</dd>
                <dd id="InfoDialog.accepted" class="function">accepted</dd>

            </div>
            <div><dt>PyQt5.QtWidgets.QWidget</dt>
                                <dd id="InfoDialog.RenderFlag" class="class">RenderFlag</dd>
                <dd id="InfoDialog.RenderFlags" class="class">RenderFlags</dd>
                <dd id="InfoDialog.acceptDrops" class="function">acceptDrops</dd>
                <dd id="InfoDialog.accessibleDescription" class="function">accessibleDescription</dd>
                <dd id="InfoDialog.accessibleName" class="function">accessibleName</dd>
                <dd id="InfoDialog.actionEvent" class="function">actionEvent</dd>
                <dd id="InfoDialog.actions" class="function">actions</dd>
                <dd id="InfoDialog.activateWindow" class="function">activateWindow</dd>
                <dd id="InfoDialog.addAction" class="function">addAction</dd>
                <dd id="InfoDialog.addActions" class="function">addActions</dd>
                <dd id="InfoDialog.adjustSize" class="function">adjustSize</dd>
                <dd id="InfoDialog.autoFillBackground" class="function">autoFillBackground</dd>
                <dd id="InfoDialog.backgroundRole" class="function">backgroundRole</dd>
                <dd id="InfoDialog.baseSize" class="function">baseSize</dd>
                <dd id="InfoDialog.changeEvent" class="function">changeEvent</dd>
                <dd id="InfoDialog.childAt" class="function">childAt</dd>
                <dd id="InfoDialog.childrenRect" class="function">childrenRect</dd>
                <dd id="InfoDialog.childrenRegion" class="function">childrenRegion</dd>
                <dd id="InfoDialog.clearFocus" class="function">clearFocus</dd>
                <dd id="InfoDialog.clearMask" class="function">clearMask</dd>
                <dd id="InfoDialog.close" class="function">close</dd>
                <dd id="InfoDialog.contentsMargins" class="function">contentsMargins</dd>
                <dd id="InfoDialog.contentsRect" class="function">contentsRect</dd>
                <dd id="InfoDialog.contextMenuPolicy" class="function">contextMenuPolicy</dd>
                <dd id="InfoDialog.create" class="function">create</dd>
                <dd id="InfoDialog.createWindowContainer" class="function">createWindowContainer</dd>
                <dd id="InfoDialog.cursor" class="function">cursor</dd>
                <dd id="InfoDialog.destroy" class="function">destroy</dd>
                <dd id="InfoDialog.devType" class="function">devType</dd>
                <dd id="InfoDialog.dragEnterEvent" class="function">dragEnterEvent</dd>
                <dd id="InfoDialog.dragLeaveEvent" class="function">dragLeaveEvent</dd>
                <dd id="InfoDialog.dragMoveEvent" class="function">dragMoveEvent</dd>
                <dd id="InfoDialog.dropEvent" class="function">dropEvent</dd>
                <dd id="InfoDialog.effectiveWinId" class="function">effectiveWinId</dd>
                <dd id="InfoDialog.ensurePolished" class="function">ensurePolished</dd>
                <dd id="InfoDialog.enterEvent" class="function">enterEvent</dd>
                <dd id="InfoDialog.event" class="function">event</dd>
                <dd id="InfoDialog.find" class="function">find</dd>
                <dd id="InfoDialog.focusInEvent" class="function">focusInEvent</dd>
                <dd id="InfoDialog.focusNextChild" class="function">focusNextChild</dd>
                <dd id="InfoDialog.focusNextPrevChild" class="function">focusNextPrevChild</dd>
                <dd id="InfoDialog.focusOutEvent" class="function">focusOutEvent</dd>
                <dd id="InfoDialog.focusPolicy" class="function">focusPolicy</dd>
                <dd id="InfoDialog.focusPreviousChild" class="function">focusPreviousChild</dd>
                <dd id="InfoDialog.focusProxy" class="function">focusProxy</dd>
                <dd id="InfoDialog.focusWidget" class="function">focusWidget</dd>
                <dd id="InfoDialog.font" class="function">font</dd>
                <dd id="InfoDialog.fontInfo" class="function">fontInfo</dd>
                <dd id="InfoDialog.fontMetrics" class="function">fontMetrics</dd>
                <dd id="InfoDialog.foregroundRole" class="function">foregroundRole</dd>
                <dd id="InfoDialog.frameGeometry" class="function">frameGeometry</dd>
                <dd id="InfoDialog.frameSize" class="function">frameSize</dd>
                <dd id="InfoDialog.geometry" class="function">geometry</dd>
                <dd id="InfoDialog.getContentsMargins" class="function">getContentsMargins</dd>
                <dd id="InfoDialog.grab" class="function">grab</dd>
                <dd id="InfoDialog.grabGesture" class="function">grabGesture</dd>
                <dd id="InfoDialog.grabKeyboard" class="function">grabKeyboard</dd>
                <dd id="InfoDialog.grabMouse" class="function">grabMouse</dd>
                <dd id="InfoDialog.grabShortcut" class="function">grabShortcut</dd>
                <dd id="InfoDialog.graphicsEffect" class="function">graphicsEffect</dd>
                <dd id="InfoDialog.graphicsProxyWidget" class="function">graphicsProxyWidget</dd>
                <dd id="InfoDialog.hasFocus" class="function">hasFocus</dd>
                <dd id="InfoDialog.hasHeightForWidth" class="function">hasHeightForWidth</dd>
                <dd id="InfoDialog.hasMouseTracking" class="function">hasMouseTracking</dd>
                <dd id="InfoDialog.hasTabletTracking" class="function">hasTabletTracking</dd>
                <dd id="InfoDialog.height" class="function">height</dd>
                <dd id="InfoDialog.heightForWidth" class="function">heightForWidth</dd>
                <dd id="InfoDialog.hide" class="function">hide</dd>
                <dd id="InfoDialog.hideEvent" class="function">hideEvent</dd>
                <dd id="InfoDialog.initPainter" class="function">initPainter</dd>
                <dd id="InfoDialog.inputMethodEvent" class="function">inputMethodEvent</dd>
                <dd id="InfoDialog.inputMethodHints" class="function">inputMethodHints</dd>
                <dd id="InfoDialog.inputMethodQuery" class="function">inputMethodQuery</dd>
                <dd id="InfoDialog.insertAction" class="function">insertAction</dd>
                <dd id="InfoDialog.insertActions" class="function">insertActions</dd>
                <dd id="InfoDialog.isActiveWindow" class="function">isActiveWindow</dd>
                <dd id="InfoDialog.isAncestorOf" class="function">isAncestorOf</dd>
                <dd id="InfoDialog.isEnabled" class="function">isEnabled</dd>
                <dd id="InfoDialog.isEnabledTo" class="function">isEnabledTo</dd>
                <dd id="InfoDialog.isFullScreen" class="function">isFullScreen</dd>
                <dd id="InfoDialog.isHidden" class="function">isHidden</dd>
                <dd id="InfoDialog.isLeftToRight" class="function">isLeftToRight</dd>
                <dd id="InfoDialog.isMaximized" class="function">isMaximized</dd>
                <dd id="InfoDialog.isMinimized" class="function">isMinimized</dd>
                <dd id="InfoDialog.isModal" class="function">isModal</dd>
                <dd id="InfoDialog.isRightToLeft" class="function">isRightToLeft</dd>
                <dd id="InfoDialog.isVisible" class="function">isVisible</dd>
                <dd id="InfoDialog.isVisibleTo" class="function">isVisibleTo</dd>
                <dd id="InfoDialog.isWindow" class="function">isWindow</dd>
                <dd id="InfoDialog.isWindowModified" class="function">isWindowModified</dd>
                <dd id="InfoDialog.keyReleaseEvent" class="function">keyReleaseEvent</dd>
                <dd id="InfoDialog.keyboardGrabber" class="function">keyboardGrabber</dd>
                <dd id="InfoDialog.layout" class="function">layout</dd>
                <dd id="InfoDialog.layoutDirection" class="function">layoutDirection</dd>
                <dd id="InfoDialog.leaveEvent" class="function">leaveEvent</dd>
                <dd id="InfoDialog.locale" class="function">locale</dd>
                <dd id="InfoDialog.lower" class="function">lower</dd>
                <dd id="InfoDialog.mapFrom" class="function">mapFrom</dd>
                <dd id="InfoDialog.mapFromGlobal" class="function">mapFromGlobal</dd>
                <dd id="InfoDialog.mapFromParent" class="function">mapFromParent</dd>
                <dd id="InfoDialog.mapTo" class="function">mapTo</dd>
                <dd id="InfoDialog.mapToGlobal" class="function">mapToGlobal</dd>
                <dd id="InfoDialog.mapToParent" class="function">mapToParent</dd>
                <dd id="InfoDialog.mask" class="function">mask</dd>
                <dd id="InfoDialog.maximumHeight" class="function">maximumHeight</dd>
                <dd id="InfoDialog.maximumSize" class="function">maximumSize</dd>
                <dd id="InfoDialog.maximumWidth" class="function">maximumWidth</dd>
                <dd id="InfoDialog.metric" class="function">metric</dd>
                <dd id="InfoDialog.minimumHeight" class="function">minimumHeight</dd>
                <dd id="InfoDialog.minimumSize" class="function">minimumSize</dd>
                <dd id="InfoDialog.minimumWidth" class="function">minimumWidth</dd>
                <dd id="InfoDialog.mouseDoubleClickEvent" class="function">mouseDoubleClickEvent</dd>
                <dd id="InfoDialog.mouseGrabber" class="function">mouseGrabber</dd>
                <dd id="InfoDialog.mouseMoveEvent" class="function">mouseMoveEvent</dd>
                <dd id="InfoDialog.mousePressEvent" class="function">mousePressEvent</dd>
                <dd id="InfoDialog.mouseReleaseEvent" class="function">mouseReleaseEvent</dd>
                <dd id="InfoDialog.move" class="function">move</dd>
                <dd id="InfoDialog.moveEvent" class="function">moveEvent</dd>
                <dd id="InfoDialog.nativeEvent" class="function">nativeEvent</dd>
                <dd id="InfoDialog.nativeParentWidget" class="function">nativeParentWidget</dd>
                <dd id="InfoDialog.nextInFocusChain" class="function">nextInFocusChain</dd>
                <dd id="InfoDialog.normalGeometry" class="function">normalGeometry</dd>
                <dd id="InfoDialog.overrideWindowFlags" class="function">overrideWindowFlags</dd>
                <dd id="InfoDialog.overrideWindowState" class="function">overrideWindowState</dd>
                <dd id="InfoDialog.paintEngine" class="function">paintEngine</dd>
                <dd id="InfoDialog.paintEvent" class="function">paintEvent</dd>
                <dd id="InfoDialog.palette" class="function">palette</dd>
                <dd id="InfoDialog.parentWidget" class="function">parentWidget</dd>
                <dd id="InfoDialog.pos" class="function">pos</dd>
                <dd id="InfoDialog.previousInFocusChain" class="function">previousInFocusChain</dd>
                <dd id="InfoDialog.raise_" class="function">raise_</dd>
                <dd id="InfoDialog.rect" class="function">rect</dd>
                <dd id="InfoDialog.releaseKeyboard" class="function">releaseKeyboard</dd>
                <dd id="InfoDialog.releaseMouse" class="function">releaseMouse</dd>
                <dd id="InfoDialog.releaseShortcut" class="function">releaseShortcut</dd>
                <dd id="InfoDialog.removeAction" class="function">removeAction</dd>
                <dd id="InfoDialog.render" class="function">render</dd>
                <dd id="InfoDialog.repaint" class="function">repaint</dd>
                <dd id="InfoDialog.resize" class="function">resize</dd>
                <dd id="InfoDialog.restoreGeometry" class="function">restoreGeometry</dd>
                <dd id="InfoDialog.saveGeometry" class="function">saveGeometry</dd>
                <dd id="InfoDialog.screen" class="function">screen</dd>
                <dd id="InfoDialog.scroll" class="function">scroll</dd>
                <dd id="InfoDialog.setAcceptDrops" class="function">setAcceptDrops</dd>
                <dd id="InfoDialog.setAccessibleDescription" class="function">setAccessibleDescription</dd>
                <dd id="InfoDialog.setAccessibleName" class="function">setAccessibleName</dd>
                <dd id="InfoDialog.setAttribute" class="function">setAttribute</dd>
                <dd id="InfoDialog.setAutoFillBackground" class="function">setAutoFillBackground</dd>
                <dd id="InfoDialog.setBackgroundRole" class="function">setBackgroundRole</dd>
                <dd id="InfoDialog.setBaseSize" class="function">setBaseSize</dd>
                <dd id="InfoDialog.setContentsMargins" class="function">setContentsMargins</dd>
                <dd id="InfoDialog.setContextMenuPolicy" class="function">setContextMenuPolicy</dd>
                <dd id="InfoDialog.setCursor" class="function">setCursor</dd>
                <dd id="InfoDialog.setDisabled" class="function">setDisabled</dd>
                <dd id="InfoDialog.setEnabled" class="function">setEnabled</dd>
                <dd id="InfoDialog.setFixedHeight" class="function">setFixedHeight</dd>
                <dd id="InfoDialog.setFixedSize" class="function">setFixedSize</dd>
                <dd id="InfoDialog.setFixedWidth" class="function">setFixedWidth</dd>
                <dd id="InfoDialog.setFocus" class="function">setFocus</dd>
                <dd id="InfoDialog.setFocusPolicy" class="function">setFocusPolicy</dd>
                <dd id="InfoDialog.setFocusProxy" class="function">setFocusProxy</dd>
                <dd id="InfoDialog.setFont" class="function">setFont</dd>
                <dd id="InfoDialog.setForegroundRole" class="function">setForegroundRole</dd>
                <dd id="InfoDialog.setGeometry" class="function">setGeometry</dd>
                <dd id="InfoDialog.setGraphicsEffect" class="function">setGraphicsEffect</dd>
                <dd id="InfoDialog.setHidden" class="function">setHidden</dd>
                <dd id="InfoDialog.setInputMethodHints" class="function">setInputMethodHints</dd>
                <dd id="InfoDialog.setLayout" class="function">setLayout</dd>
                <dd id="InfoDialog.setLayoutDirection" class="function">setLayoutDirection</dd>
                <dd id="InfoDialog.setLocale" class="function">setLocale</dd>
                <dd id="InfoDialog.setMask" class="function">setMask</dd>
                <dd id="InfoDialog.setMaximumHeight" class="function">setMaximumHeight</dd>
                <dd id="InfoDialog.setMaximumSize" class="function">setMaximumSize</dd>
                <dd id="InfoDialog.setMaximumWidth" class="function">setMaximumWidth</dd>
                <dd id="InfoDialog.setMinimumHeight" class="function">setMinimumHeight</dd>
                <dd id="InfoDialog.setMinimumSize" class="function">setMinimumSize</dd>
                <dd id="InfoDialog.setMinimumWidth" class="function">setMinimumWidth</dd>
                <dd id="InfoDialog.setMouseTracking" class="function">setMouseTracking</dd>
                <dd id="InfoDialog.setPalette" class="function">setPalette</dd>
                <dd id="InfoDialog.setParent" class="function">setParent</dd>
                <dd id="InfoDialog.setShortcutAutoRepeat" class="function">setShortcutAutoRepeat</dd>
                <dd id="InfoDialog.setShortcutEnabled" class="function">setShortcutEnabled</dd>
                <dd id="InfoDialog.setSizeIncrement" class="function">setSizeIncrement</dd>
                <dd id="InfoDialog.setSizePolicy" class="function">setSizePolicy</dd>
                <dd id="InfoDialog.setStatusTip" class="function">setStatusTip</dd>
                <dd id="InfoDialog.setStyle" class="function">setStyle</dd>
                <dd id="InfoDialog.setStyleSheet" class="function">setStyleSheet</dd>
                <dd id="InfoDialog.setTabOrder" class="function">setTabOrder</dd>
                <dd id="InfoDialog.setTabletTracking" class="function">setTabletTracking</dd>
                <dd id="InfoDialog.setToolTip" class="function">setToolTip</dd>
                <dd id="InfoDialog.setToolTipDuration" class="function">setToolTipDuration</dd>
                <dd id="InfoDialog.setUpdatesEnabled" class="function">setUpdatesEnabled</dd>
                <dd id="InfoDialog.setWhatsThis" class="function">setWhatsThis</dd>
                <dd id="InfoDialog.setWindowFilePath" class="function">setWindowFilePath</dd>
                <dd id="InfoDialog.setWindowFlag" class="function">setWindowFlag</dd>
                <dd id="InfoDialog.setWindowFlags" class="function">setWindowFlags</dd>
                <dd id="InfoDialog.setWindowIcon" class="function">setWindowIcon</dd>
                <dd id="InfoDialog.setWindowIconText" class="function">setWindowIconText</dd>
                <dd id="InfoDialog.setWindowModality" class="function">setWindowModality</dd>
                <dd id="InfoDialog.setWindowModified" class="function">setWindowModified</dd>
                <dd id="InfoDialog.setWindowOpacity" class="function">setWindowOpacity</dd>
                <dd id="InfoDialog.setWindowRole" class="function">setWindowRole</dd>
                <dd id="InfoDialog.setWindowState" class="function">setWindowState</dd>
                <dd id="InfoDialog.setWindowTitle" class="function">setWindowTitle</dd>
                <dd id="InfoDialog.sharedPainter" class="function">sharedPainter</dd>
                <dd id="InfoDialog.show" class="function">show</dd>
                <dd id="InfoDialog.showFullScreen" class="function">showFullScreen</dd>
                <dd id="InfoDialog.showMaximized" class="function">showMaximized</dd>
                <dd id="InfoDialog.showMinimized" class="function">showMinimized</dd>
                <dd id="InfoDialog.showNormal" class="function">showNormal</dd>
                <dd id="InfoDialog.size" class="function">size</dd>
                <dd id="InfoDialog.sizeIncrement" class="function">sizeIncrement</dd>
                <dd id="InfoDialog.sizePolicy" class="function">sizePolicy</dd>
                <dd id="InfoDialog.stackUnder" class="function">stackUnder</dd>
                <dd id="InfoDialog.statusTip" class="function">statusTip</dd>
                <dd id="InfoDialog.style" class="function">style</dd>
                <dd id="InfoDialog.styleSheet" class="function">styleSheet</dd>
                <dd id="InfoDialog.tabletEvent" class="function">tabletEvent</dd>
                <dd id="InfoDialog.testAttribute" class="function">testAttribute</dd>
                <dd id="InfoDialog.toolTip" class="function">toolTip</dd>
                <dd id="InfoDialog.toolTipDuration" class="function">toolTipDuration</dd>
                <dd id="InfoDialog.underMouse" class="function">underMouse</dd>
                <dd id="InfoDialog.ungrabGesture" class="function">ungrabGesture</dd>
                <dd id="InfoDialog.unsetCursor" class="function">unsetCursor</dd>
                <dd id="InfoDialog.unsetLayoutDirection" class="function">unsetLayoutDirection</dd>
                <dd id="InfoDialog.unsetLocale" class="function">unsetLocale</dd>
                <dd id="InfoDialog.update" class="function">update</dd>
                <dd id="InfoDialog.updateGeometry" class="function">updateGeometry</dd>
                <dd id="InfoDialog.updateMicroFocus" class="function">updateMicroFocus</dd>
                <dd id="InfoDialog.updatesEnabled" class="function">updatesEnabled</dd>
                <dd id="InfoDialog.visibleRegion" class="function">visibleRegion</dd>
                <dd id="InfoDialog.whatsThis" class="function">whatsThis</dd>
                <dd id="InfoDialog.wheelEvent" class="function">wheelEvent</dd>
                <dd id="InfoDialog.width" class="function">width</dd>
                <dd id="InfoDialog.winId" class="function">winId</dd>
                <dd id="InfoDialog.window" class="function">window</dd>
                <dd id="InfoDialog.windowFilePath" class="function">windowFilePath</dd>
                <dd id="InfoDialog.windowFlags" class="function">windowFlags</dd>
                <dd id="InfoDialog.windowHandle" class="function">windowHandle</dd>
                <dd id="InfoDialog.windowIcon" class="function">windowIcon</dd>
                <dd id="InfoDialog.windowIconText" class="function">windowIconText</dd>
                <dd id="InfoDialog.windowModality" class="function">windowModality</dd>
                <dd id="InfoDialog.windowOpacity" class="function">windowOpacity</dd>
                <dd id="InfoDialog.windowRole" class="function">windowRole</dd>
                <dd id="InfoDialog.windowState" class="function">windowState</dd>
                <dd id="InfoDialog.windowTitle" class="function">windowTitle</dd>
                <dd id="InfoDialog.windowType" class="function">windowType</dd>
                <dd id="InfoDialog.x" class="function">x</dd>
                <dd id="InfoDialog.y" class="function">y</dd>
                <dd id="InfoDialog.DrawChildren" class="variable">DrawChildren</dd>
                <dd id="InfoDialog.DrawWindowBackground" class="variable">DrawWindowBackground</dd>
                <dd id="InfoDialog.IgnoreMask" class="variable">IgnoreMask</dd>
                <dd id="InfoDialog.windowIconTextChanged" class="function">windowIconTextChanged</dd>
                <dd id="InfoDialog.windowIconChanged" class="function">windowIconChanged</dd>
                <dd id="InfoDialog.windowTitleChanged" class="function">windowTitleChanged</dd>
                <dd id="InfoDialog.customContextMenuRequested" class="function">customContextMenuRequested</dd>

            </div>
            <div><dt>PyQt5.QtCore.QObject</dt>
                                <dd id="InfoDialog.blockSignals" class="function">blockSignals</dd>
                <dd id="InfoDialog.childEvent" class="function">childEvent</dd>
                <dd id="InfoDialog.children" class="function">children</dd>
                <dd id="InfoDialog.connectNotify" class="function">connectNotify</dd>
                <dd id="InfoDialog.customEvent" class="function">customEvent</dd>
                <dd id="InfoDialog.deleteLater" class="function">deleteLater</dd>
                <dd id="InfoDialog.disconnect" class="function">disconnect</dd>
                <dd id="InfoDialog.disconnectNotify" class="function">disconnectNotify</dd>
                <dd id="InfoDialog.dumpObjectInfo" class="function">dumpObjectInfo</dd>
                <dd id="InfoDialog.dumpObjectTree" class="function">dumpObjectTree</dd>
                <dd id="InfoDialog.dynamicPropertyNames" class="function">dynamicPropertyNames</dd>
                <dd id="InfoDialog.findChild" class="function">findChild</dd>
                <dd id="InfoDialog.findChildren" class="function">findChildren</dd>
                <dd id="InfoDialog.inherits" class="function">inherits</dd>
                <dd id="InfoDialog.installEventFilter" class="function">installEventFilter</dd>
                <dd id="InfoDialog.isSignalConnected" class="function">isSignalConnected</dd>
                <dd id="InfoDialog.isWidgetType" class="function">isWidgetType</dd>
                <dd id="InfoDialog.isWindowType" class="function">isWindowType</dd>
                <dd id="InfoDialog.killTimer" class="function">killTimer</dd>
                <dd id="InfoDialog.metaObject" class="function">metaObject</dd>
                <dd id="InfoDialog.moveToThread" class="function">moveToThread</dd>
                <dd id="InfoDialog.objectName" class="function">objectName</dd>
                <dd id="InfoDialog.parent" class="function">parent</dd>
                <dd id="InfoDialog.property" class="function">property</dd>
                <dd id="InfoDialog.pyqtConfigure" class="function">pyqtConfigure</dd>
                <dd id="InfoDialog.receivers" class="function">receivers</dd>
                <dd id="InfoDialog.removeEventFilter" class="function">removeEventFilter</dd>
                <dd id="InfoDialog.sender" class="function">sender</dd>
                <dd id="InfoDialog.senderSignalIndex" class="function">senderSignalIndex</dd>
                <dd id="InfoDialog.setObjectName" class="function">setObjectName</dd>
                <dd id="InfoDialog.setProperty" class="function">setProperty</dd>
                <dd id="InfoDialog.signalsBlocked" class="function">signalsBlocked</dd>
                <dd id="InfoDialog.startTimer" class="function">startTimer</dd>
                <dd id="InfoDialog.thread" class="function">thread</dd>
                <dd id="InfoDialog.timerEvent" class="function">timerEvent</dd>
                <dd id="InfoDialog.tr" class="function">tr</dd>
                <dd id="InfoDialog.staticMetaObject" class="variable">staticMetaObject</dd>
                <dd id="InfoDialog.objectNameChanged" class="function">objectNameChanged</dd>
                <dd id="InfoDialog.destroyed" class="function">destroyed</dd>

            </div>
            <div><dt>PyQt5.QtGui.QPaintDevice</dt>
                                <dd id="InfoDialog.PaintDeviceMetric" class="class">PaintDeviceMetric</dd>
                <dd id="InfoDialog.colorCount" class="function">colorCount</dd>
                <dd id="InfoDialog.depth" class="function">depth</dd>
                <dd id="InfoDialog.devicePixelRatio" class="function">devicePixelRatio</dd>
                <dd id="InfoDialog.devicePixelRatioF" class="function">devicePixelRatioF</dd>
                <dd id="InfoDialog.devicePixelRatioFScale" class="function">devicePixelRatioFScale</dd>
                <dd id="InfoDialog.heightMM" class="function">heightMM</dd>
                <dd id="InfoDialog.logicalDpiX" class="function">logicalDpiX</dd>
                <dd id="InfoDialog.logicalDpiY" class="function">logicalDpiY</dd>
                <dd id="InfoDialog.paintingActive" class="function">paintingActive</dd>
                <dd id="InfoDialog.physicalDpiX" class="function">physicalDpiX</dd>
                <dd id="InfoDialog.physicalDpiY" class="function">physicalDpiY</dd>
                <dd id="InfoDialog.widthMM" class="function">widthMM</dd>
                <dd id="InfoDialog.PdmDepth" class="variable">PdmDepth</dd>
                <dd id="InfoDialog.PdmDevicePixelRatio" class="variable">PdmDevicePixelRatio</dd>
                <dd id="InfoDialog.PdmDevicePixelRatioScaled" class="variable">PdmDevicePixelRatioScaled</dd>
                <dd id="InfoDialog.PdmDpiX" class="variable">PdmDpiX</dd>
                <dd id="InfoDialog.PdmDpiY" class="variable">PdmDpiY</dd>
                <dd id="InfoDialog.PdmHeight" class="variable">PdmHeight</dd>
                <dd id="InfoDialog.PdmHeightMM" class="variable">PdmHeightMM</dd>
                <dd id="InfoDialog.PdmNumColors" class="variable">PdmNumColors</dd>
                <dd id="InfoDialog.PdmPhysicalDpiX" class="variable">PdmPhysicalDpiX</dd>
                <dd id="InfoDialog.PdmPhysicalDpiY" class="variable">PdmPhysicalDpiY</dd>
                <dd id="InfoDialog.PdmWidth" class="variable">PdmWidth</dd>
                <dd id="InfoDialog.PdmWidthMM" class="variable">PdmWidthMM</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="clear">
                    <div class="attr variable">
            <span class="name">clear</span>        =
<span class="default_value">MagicFactory(function=&lt;function clear&gt;, call_button=&#39;Clear Annotations [Shift + C]&#39;)</span>

        
    </div>
    <a class="headerlink" href="#clear"></a>
    
            <div class="docstring"><p>Widget for clearing the current annotations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
</ul>
</div>


                </section>
                <section id="clear_volume">
                    <div class="attr variable">
            <span class="name">clear_volume</span>        =
<span class="default_value">MagicFactory(function=&lt;function clear_volume&gt;, call_button=&#39;Clear Annotations [Shift + C]&#39;)</span>

        
    </div>
    <a class="headerlink" href="#clear_volume"></a>
    
            <div class="docstring"><p>Widget for clearing the current annotations in 3D.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
<li><strong>all_slices:</strong>  Choose whether to clear the annotations for all or only the current slice.</li>
</ul>
</div>


                </section>
                <section id="clear_track">
                    <div class="attr variable">
            <span class="name">clear_track</span>        =
<span class="default_value">MagicFactory(function=&lt;function clear_track&gt;, call_button=&#39;Clear Annotations [Shift + C]&#39;)</span>

        
    </div>
    <a class="headerlink" href="#clear_track"></a>
    
            <div class="docstring"><p>Widget for clearing all tracking annotations and state.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
<li><strong>all_frames:</strong>  Choose whether to clear the annotations for all or only the current frame.</li>
</ul>
</div>


                </section>
                <section id="commit">
                    <div class="attr variable">
            <span class="name">commit</span>        =
<input id="commit-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="commit-view-value"></label><span class="default_value">MagicFactory(function=&lt;function commit&gt;, call_button=&#39;Commit [C]&#39;, param_options={&#39;layer&#39;: {&#39;choices&#39;: [&#39;current_object&#39;, &#39;auto_segmentation&#39;]}, &#39;commit_path&#39;: {&#39;mode&#39;: &#39;d&#39;}})</span>

        
    </div>
    <a class="headerlink" href="#commit"></a>
    
            <div class="docstring"><p>Widget for committing the segmented objects from automatic or interactive segmentation.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
<li><strong>layer:</strong>  Select the layer to commit. Can be either 'current_object' to commit interacitve segmentation results.
Or 'auto_segmentation' to commit automatic segmentation results.</li>
<li><strong>preserve_committed:</strong>  If active already committted objects are not over-written by new commits.</li>
<li><strong>commit_path:</strong>  Select a file path where the committed results and prompts will be saved.
This feature is still experimental.</li>
</ul>
</div>


                </section>
                <section id="commit_track">
                    <div class="attr variable">
            <span class="name">commit_track</span>        =
<input id="commit_track-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="commit_track-view-value"></label><span class="default_value">MagicFactory(function=&lt;function commit_track&gt;, call_button=&#39;Commit [C]&#39;, param_options={&#39;layer&#39;: {&#39;choices&#39;: [&#39;current_object&#39;]}, &#39;commit_path&#39;: {&#39;mode&#39;: &#39;d&#39;}})</span>

        
    </div>
    <a class="headerlink" href="#commit_track"></a>
    
            <div class="docstring"><p>Widget for committing the objects from interactive tracking.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
<li><strong>layer:</strong>  Select the layer to commit. Can be either 'current_object' to commit interacitve segmentation results.
Or 'auto_segmentation' to commit automatic segmentation results.</li>
<li><strong>preserve_committed:</strong>  If active already committted objects are not over-written by new commits.</li>
<li><strong>commit_path:</strong>  Select a file path where the committed results and prompts will be saved.
This feature is still experimental.</li>
</ul>
</div>


                </section>
                <section id="create_prompt_menu">
                            <input id="create_prompt_menu-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_prompt_menu</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">points_layer</span>, </span><span class="param"><span class="n">labels</span>, </span><span class="param"><span class="n">menu_name</span><span class="o">=</span><span class="s1">&#39;prompt&#39;</span>, </span><span class="param"><span class="n">label_name</span><span class="o">=</span><span class="s1">&#39;label&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="create_prompt_menu-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_prompt_menu"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_prompt_menu-552"><a href="#create_prompt_menu-552"><span class="linenos">552</span></a><span class="k">def</span> <span class="nf">create_prompt_menu</span><span class="p">(</span><span class="n">points_layer</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">menu_name</span><span class="o">=</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="n">label_name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">):</span>
</span><span id="create_prompt_menu-553"><a href="#create_prompt_menu-553"><span class="linenos">553</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the menu for toggling point prompt labels.&quot;&quot;&quot;</span>
</span><span id="create_prompt_menu-554"><a href="#create_prompt_menu-554"><span class="linenos">554</span></a>    <span class="n">label_menu</span> <span class="o">=</span> <span class="n">ComboBox</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">menu_name</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;prompt_menu&quot;</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">))</span>
</span><span id="create_prompt_menu-555"><a href="#create_prompt_menu-555"><span class="linenos">555</span></a>    <span class="n">label_widget</span> <span class="o">=</span> <span class="n">Container</span><span class="p">(</span><span class="n">widgets</span><span class="o">=</span><span class="p">[</span><span class="n">label_menu</span><span class="p">])</span>
</span><span id="create_prompt_menu-556"><a href="#create_prompt_menu-556"><span class="linenos">556</span></a>
</span><span id="create_prompt_menu-557"><a href="#create_prompt_menu-557"><span class="linenos">557</span></a>    <span class="k">def</span> <span class="nf">update_label_menu</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="create_prompt_menu-558"><a href="#create_prompt_menu-558"><span class="linenos">558</span></a>        <span class="n">new_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">points_layer</span><span class="o">.</span><span class="n">current_properties</span><span class="p">[</span><span class="n">label_name</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="create_prompt_menu-559"><a href="#create_prompt_menu-559"><span class="linenos">559</span></a>        <span class="k">if</span> <span class="n">new_label</span> <span class="o">!=</span> <span class="n">label_menu</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="create_prompt_menu-560"><a href="#create_prompt_menu-560"><span class="linenos">560</span></a>            <span class="n">label_menu</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_label</span>
</span><span id="create_prompt_menu-561"><a href="#create_prompt_menu-561"><span class="linenos">561</span></a>
</span><span id="create_prompt_menu-562"><a href="#create_prompt_menu-562"><span class="linenos">562</span></a>    <span class="n">points_layer</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current_properties</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_label_menu</span><span class="p">)</span>
</span><span id="create_prompt_menu-563"><a href="#create_prompt_menu-563"><span class="linenos">563</span></a>
</span><span id="create_prompt_menu-564"><a href="#create_prompt_menu-564"><span class="linenos">564</span></a>    <span class="k">def</span> <span class="nf">label_changed</span><span class="p">(</span><span class="n">new_label</span><span class="p">):</span>
</span><span id="create_prompt_menu-565"><a href="#create_prompt_menu-565"><span class="linenos">565</span></a>        <span class="n">current_properties</span> <span class="o">=</span> <span class="n">points_layer</span><span class="o">.</span><span class="n">current_properties</span>
</span><span id="create_prompt_menu-566"><a href="#create_prompt_menu-566"><span class="linenos">566</span></a>        <span class="n">current_properties</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_label</span><span class="p">])</span>
</span><span id="create_prompt_menu-567"><a href="#create_prompt_menu-567"><span class="linenos">567</span></a>        <span class="n">points_layer</span><span class="o">.</span><span class="n">current_properties</span> <span class="o">=</span> <span class="n">current_properties</span>
</span><span id="create_prompt_menu-568"><a href="#create_prompt_menu-568"><span class="linenos">568</span></a>        <span class="n">points_layer</span><span class="o">.</span><span class="n">refresh_colors</span><span class="p">()</span>
</span><span id="create_prompt_menu-569"><a href="#create_prompt_menu-569"><span class="linenos">569</span></a>
</span><span id="create_prompt_menu-570"><a href="#create_prompt_menu-570"><span class="linenos">570</span></a>    <span class="n">label_menu</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">label_changed</span><span class="p">)</span>
</span><span id="create_prompt_menu-571"><a href="#create_prompt_menu-571"><span class="linenos">571</span></a>
</span><span id="create_prompt_menu-572"><a href="#create_prompt_menu-572"><span class="linenos">572</span></a>    <span class="k">return</span> <span class="n">label_widget</span>
</span></pre></div>


            <div class="docstring"><p>Create the menu for toggling point prompt labels.</p>
</div>


                </section>
                <section id="settings_widget">
                    <div class="attr variable">
            <span class="name">settings_widget</span>        =
<input id="settings_widget-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="settings_widget-view-value"></label><span class="default_value">MagicFactory(function=&lt;function settings_widget&gt;, call_button=&#39;Update settings&#39;, param_options={&#39;cache_directory&#39;: {&#39;mode&#39;: &#39;d&#39;}})</span>

        
    </div>
    <a class="headerlink" href="#settings_widget"></a>
    
            <div class="docstring"><p>Widget to update global micro_sam settings.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>cache_directory:</strong>  Select the path for the micro_sam cache directory. <code>$HOME/.cache/micro_sam</code>.</li>
</ul>
</div>


                </section>
                <section id="segment">
                    <div class="attr variable">
            <span class="name">segment</span>        =
<span class="default_value">MagicFactory(function=&lt;function segment&gt;, call_button=&#39;Segment Object [S]&#39;)</span>

        
    </div>
    <a class="headerlink" href="#segment"></a>
    
            <div class="docstring"><p>Segment object(s) for the current prompts.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
<li><strong>batched:</strong>  Choose if you want to segment multiple objects with point prompts.</li>
</ul>
</div>


                </section>
                <section id="segment_slice">
                    <div class="attr variable">
            <span class="name">segment_slice</span>        =
<span class="default_value">MagicFactory(function=&lt;function segment_slice&gt;, call_button=&#39;Segment Slice [S]&#39;)</span>

        
    </div>
    <a class="headerlink" href="#segment_slice"></a>
    
            <div class="docstring"><p>Segment object for to the current prompts.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
</ul>
</div>


                </section>
                <section id="segment_frame">
                    <div class="attr variable">
            <span class="name">segment_frame</span>        =
<span class="default_value">MagicFactory(function=&lt;function segment_frame&gt;, call_button=&#39;Segment Frame [S]&#39;)</span>

        
    </div>
    <a class="headerlink" href="#segment_frame"></a>
    
            <div class="docstring"><p>Segment object for the current prompts.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>viewer:</strong>  The napari viewer.</li>
</ul>
</div>


                </section>
                <section id="EmbeddingWidget">
                            <input id="EmbeddingWidget-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EmbeddingWidget</span><wbr>(<span class="base"><a href="#_WidgetBase">_WidgetBase</a></span>):

                <label class="view-source-button" for="EmbeddingWidget-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EmbeddingWidget"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EmbeddingWidget-841"><a href="#EmbeddingWidget-841"><span class="linenos"> 841</span></a><span class="k">class</span> <span class="nc">EmbeddingWidget</span><span class="p">(</span><span class="n">_WidgetBase</span><span class="p">):</span>
</span><span id="EmbeddingWidget-842"><a href="#EmbeddingWidget-842"><span class="linenos"> 842</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="EmbeddingWidget-843"><a href="#EmbeddingWidget-843"><span class="linenos"> 843</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
</span><span id="EmbeddingWidget-844"><a href="#EmbeddingWidget-844"><span class="linenos"> 844</span></a>
</span><span id="EmbeddingWidget-845"><a href="#EmbeddingWidget-845"><span class="linenos"> 845</span></a>        <span class="c1"># Create a nested layout for the sections.</span>
</span><span id="EmbeddingWidget-846"><a href="#EmbeddingWidget-846"><span class="linenos"> 846</span></a>        <span class="c1"># Section 1: Image and Model.</span>
</span><span id="EmbeddingWidget-847"><a href="#EmbeddingWidget-847"><span class="linenos"> 847</span></a>        <span class="n">section1_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="EmbeddingWidget-848"><a href="#EmbeddingWidget-848"><span class="linenos"> 848</span></a>        <span class="n">section1_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_image_section</span><span class="p">())</span>
</span><span id="EmbeddingWidget-849"><a href="#EmbeddingWidget-849"><span class="linenos"> 849</span></a>        <span class="n">section1_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_model_section</span><span class="p">())</span>
</span><span id="EmbeddingWidget-850"><a href="#EmbeddingWidget-850"><span class="linenos"> 850</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">section1_layout</span><span class="p">)</span>
</span><span id="EmbeddingWidget-851"><a href="#EmbeddingWidget-851"><span class="linenos"> 851</span></a>
</span><span id="EmbeddingWidget-852"><a href="#EmbeddingWidget-852"><span class="linenos"> 852</span></a>        <span class="c1"># Section 2: Settings (collapsible).</span>
</span><span id="EmbeddingWidget-853"><a href="#EmbeddingWidget-853"><span class="linenos"> 853</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_settings_widget</span><span class="p">())</span>
</span><span id="EmbeddingWidget-854"><a href="#EmbeddingWidget-854"><span class="linenos"> 854</span></a>
</span><span id="EmbeddingWidget-855"><a href="#EmbeddingWidget-855"><span class="linenos"> 855</span></a>        <span class="c1"># Section 3: The button to trigger the embedding computation.</span>
</span><span id="EmbeddingWidget-856"><a href="#EmbeddingWidget-856"><span class="linenos"> 856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Compute Embeddings&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-857"><a href="#EmbeddingWidget-857"><span class="linenos"> 857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initialize_image</span><span class="p">)</span>
</span><span id="EmbeddingWidget-858"><a href="#EmbeddingWidget-858"><span class="linenos"> 858</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="EmbeddingWidget-859"><a href="#EmbeddingWidget-859"><span class="linenos"> 859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;run_button&quot;</span><span class="p">))</span>
</span><span id="EmbeddingWidget-860"><a href="#EmbeddingWidget-860"><span class="linenos"> 860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span><span id="EmbeddingWidget-861"><a href="#EmbeddingWidget-861"><span class="linenos"> 861</span></a>
</span><span id="EmbeddingWidget-862"><a href="#EmbeddingWidget-862"><span class="linenos"> 862</span></a>    <span class="k">def</span> <span class="nf">_initialize_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EmbeddingWidget-863"><a href="#EmbeddingWidget-863"><span class="linenos"> 863</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="EmbeddingWidget-864"><a href="#EmbeddingWidget-864"><span class="linenos"> 864</span></a>        <span class="n">image_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="EmbeddingWidget-865"><a href="#EmbeddingWidget-865"><span class="linenos"> 865</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">image_shape</span>
</span><span id="EmbeddingWidget-866"><a href="#EmbeddingWidget-866"><span class="linenos"> 866</span></a>
</span><span id="EmbeddingWidget-867"><a href="#EmbeddingWidget-867"><span class="linenos"> 867</span></a>    <span class="k">def</span> <span class="nf">_create_image_section</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EmbeddingWidget-868"><a href="#EmbeddingWidget-868"><span class="linenos"> 868</span></a>        <span class="n">image_section</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="EmbeddingWidget-869"><a href="#EmbeddingWidget-869"><span class="linenos"> 869</span></a>        <span class="n">image_layer_widget</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Image Layer:&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-870"><a href="#EmbeddingWidget-870"><span class="linenos"> 870</span></a>        <span class="c1"># image_layer_widget.setToolTip(get_tooltip(&quot;embedding&quot;, &quot;image&quot;)) #  this adds tooltip to label</span>
</span><span id="EmbeddingWidget-871"><a href="#EmbeddingWidget-871"><span class="linenos"> 871</span></a>        <span class="n">image_section</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">image_layer_widget</span><span class="p">)</span>
</span><span id="EmbeddingWidget-872"><a href="#EmbeddingWidget-872"><span class="linenos"> 872</span></a>
</span><span id="EmbeddingWidget-873"><a href="#EmbeddingWidget-873"><span class="linenos"> 873</span></a>        <span class="c1"># Setting a napari layer in QT, see:</span>
</span><span id="EmbeddingWidget-874"><a href="#EmbeddingWidget-874"><span class="linenos"> 874</span></a>        <span class="c1"># https://github.com/pyapp-kit/magicgui/blob/main/docs/examples/napari/napari_combine_qt.py</span>
</span><span id="EmbeddingWidget-875"><a href="#EmbeddingWidget-875"><span class="linenos"> 875</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span> <span class="o">=</span> <span class="n">create_widget</span><span class="p">(</span><span class="n">annotation</span><span class="o">=</span><span class="n">napari</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
</span><span id="EmbeddingWidget-876"><a href="#EmbeddingWidget-876"><span class="linenos"> 876</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">native</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">))</span>
</span><span id="EmbeddingWidget-877"><a href="#EmbeddingWidget-877"><span class="linenos"> 877</span></a>        <span class="n">image_section</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">native</span><span class="p">)</span>
</span><span id="EmbeddingWidget-878"><a href="#EmbeddingWidget-878"><span class="linenos"> 878</span></a>
</span><span id="EmbeddingWidget-879"><a href="#EmbeddingWidget-879"><span class="linenos"> 879</span></a>        <span class="k">return</span> <span class="n">image_section</span>
</span><span id="EmbeddingWidget-880"><a href="#EmbeddingWidget-880"><span class="linenos"> 880</span></a>
</span><span id="EmbeddingWidget-881"><a href="#EmbeddingWidget-881"><span class="linenos"> 881</span></a>    <span class="k">def</span> <span class="nf">_update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EmbeddingWidget-882"><a href="#EmbeddingWidget-882"><span class="linenos"> 882</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computed embeddings for&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">)</span>
</span><span id="EmbeddingWidget-883"><a href="#EmbeddingWidget-883"><span class="linenos"> 883</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="EmbeddingWidget-884"><a href="#EmbeddingWidget-884"><span class="linenos"> 884</span></a>        <span class="c1"># Update the widget itself. This is necessary because we may have loaded</span>
</span><span id="EmbeddingWidget-885"><a href="#EmbeddingWidget-885"><span class="linenos"> 885</span></a>        <span class="c1"># some settings from the embedding file and have to reflect them in the widget.</span>
</span><span id="EmbeddingWidget-886"><a href="#EmbeddingWidget-886"><span class="linenos"> 886</span></a>        <span class="n">vutil</span><span class="o">.</span><span class="n">_sync_embedding_widget</span><span class="p">(</span>
</span><span id="EmbeddingWidget-887"><a href="#EmbeddingWidget-887"><span class="linenos"> 887</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="EmbeddingWidget-888"><a href="#EmbeddingWidget-888"><span class="linenos"> 888</span></a>            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
</span><span id="EmbeddingWidget-889"><a href="#EmbeddingWidget-889"><span class="linenos"> 889</span></a>            <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">,</span>
</span><span id="EmbeddingWidget-890"><a href="#EmbeddingWidget-890"><span class="linenos"> 890</span></a>            <span class="n">checkpoint_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span>
</span><span id="EmbeddingWidget-891"><a href="#EmbeddingWidget-891"><span class="linenos"> 891</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="EmbeddingWidget-892"><a href="#EmbeddingWidget-892"><span class="linenos"> 892</span></a>            <span class="n">tile_shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="p">],</span>
</span><span id="EmbeddingWidget-893"><a href="#EmbeddingWidget-893"><span class="linenos"> 893</span></a>            <span class="n">halo</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="p">]</span>
</span><span id="EmbeddingWidget-894"><a href="#EmbeddingWidget-894"><span class="linenos"> 894</span></a>        <span class="p">)</span>
</span><span id="EmbeddingWidget-895"><a href="#EmbeddingWidget-895"><span class="linenos"> 895</span></a>
</span><span id="EmbeddingWidget-896"><a href="#EmbeddingWidget-896"><span class="linenos"> 896</span></a>        <span class="c1"># Set the default settings for this model in the autosegment widget if it is part of</span>
</span><span id="EmbeddingWidget-897"><a href="#EmbeddingWidget-897"><span class="linenos"> 897</span></a>        <span class="c1"># the currently used plugin.</span>
</span><span id="EmbeddingWidget-898"><a href="#EmbeddingWidget-898"><span class="linenos"> 898</span></a>        <span class="k">if</span> <span class="s2">&quot;autosegment&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">:</span>
</span><span id="EmbeddingWidget-899"><a href="#EmbeddingWidget-899"><span class="linenos"> 899</span></a>            <span class="n">with_decoder</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="EmbeddingWidget-900"><a href="#EmbeddingWidget-900"><span class="linenos"> 900</span></a>            <span class="n">vutil</span><span class="o">.</span><span class="n">_sync_autosegment_widget</span><span class="p">(</span>
</span><span id="EmbeddingWidget-901"><a href="#EmbeddingWidget-901"><span class="linenos"> 901</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;autosegment&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span> <span class="n">update_decoder</span><span class="o">=</span><span class="n">with_decoder</span>
</span><span id="EmbeddingWidget-902"><a href="#EmbeddingWidget-902"><span class="linenos"> 902</span></a>            <span class="p">)</span>
</span><span id="EmbeddingWidget-903"><a href="#EmbeddingWidget-903"><span class="linenos"> 903</span></a>            <span class="c1"># Load the AMG/AIS state if we have a 3d segmentation plugin.</span>
</span><span id="EmbeddingWidget-904"><a href="#EmbeddingWidget-904"><span class="linenos"> 904</span></a>            <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;autosegment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="n">with_decoder</span><span class="p">:</span>
</span><span id="EmbeddingWidget-905"><a href="#EmbeddingWidget-905"><span class="linenos"> 905</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">_load_is_state</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">embedding_path</span><span class="p">)</span>
</span><span id="EmbeddingWidget-906"><a href="#EmbeddingWidget-906"><span class="linenos"> 906</span></a>            <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;autosegment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">with_decoder</span><span class="p">:</span>
</span><span id="EmbeddingWidget-907"><a href="#EmbeddingWidget-907"><span class="linenos"> 907</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">amg_state</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">_load_amg_state</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">embedding_path</span><span class="p">)</span>
</span><span id="EmbeddingWidget-908"><a href="#EmbeddingWidget-908"><span class="linenos"> 908</span></a>
</span><span id="EmbeddingWidget-909"><a href="#EmbeddingWidget-909"><span class="linenos"> 909</span></a>        <span class="c1"># Set the default settings for this model in the nd-segmentation widget if it is part of</span>
</span><span id="EmbeddingWidget-910"><a href="#EmbeddingWidget-910"><span class="linenos"> 910</span></a>        <span class="c1"># the currently used plugin.</span>
</span><span id="EmbeddingWidget-911"><a href="#EmbeddingWidget-911"><span class="linenos"> 911</span></a>        <span class="k">if</span> <span class="s2">&quot;segment_nd&quot;</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">:</span>
</span><span id="EmbeddingWidget-912"><a href="#EmbeddingWidget-912"><span class="linenos"> 912</span></a>            <span class="n">vutil</span><span class="o">.</span><span class="n">_sync_ndsegment_widget</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">widgets</span><span class="p">[</span><span class="s2">&quot;segment_nd&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">)</span>
</span><span id="EmbeddingWidget-913"><a href="#EmbeddingWidget-913"><span class="linenos"> 913</span></a>
</span><span id="EmbeddingWidget-914"><a href="#EmbeddingWidget-914"><span class="linenos"> 914</span></a>    <span class="k">def</span> <span class="nf">_create_model_section</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EmbeddingWidget-915"><a href="#EmbeddingWidget-915"><span class="linenos"> 915</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_DEFAULT_MODEL</span>
</span><span id="EmbeddingWidget-916"><a href="#EmbeddingWidget-916"><span class="linenos"> 916</span></a>
</span><span id="EmbeddingWidget-917"><a href="#EmbeddingWidget-917"><span class="linenos"> 917</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">models</span><span class="p">()</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="EmbeddingWidget-918"><a href="#EmbeddingWidget-918"><span class="linenos"> 918</span></a>        <span class="c1"># Filter out the decoders from the model list.</span>
</span><span id="EmbeddingWidget-919"><a href="#EmbeddingWidget-919"><span class="linenos"> 919</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;decoder&quot;</span><span class="p">)]</span>
</span><span id="EmbeddingWidget-920"><a href="#EmbeddingWidget-920"><span class="linenos"> 920</span></a>
</span><span id="EmbeddingWidget-921"><a href="#EmbeddingWidget-921"><span class="linenos"> 921</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
</span><span id="EmbeddingWidget-922"><a href="#EmbeddingWidget-922"><span class="linenos"> 922</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_dropdown</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_choice_param</span><span class="p">(</span>
</span><span id="EmbeddingWidget-923"><a href="#EmbeddingWidget-923"><span class="linenos"> 923</span></a>            <span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_options</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Model:&quot;</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
</span><span id="EmbeddingWidget-924"><a href="#EmbeddingWidget-924"><span class="linenos"> 924</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-925"><a href="#EmbeddingWidget-925"><span class="linenos"> 925</span></a>        <span class="p">)</span>
</span><span id="EmbeddingWidget-926"><a href="#EmbeddingWidget-926"><span class="linenos"> 926</span></a>        <span class="k">return</span> <span class="n">layout</span>
</span><span id="EmbeddingWidget-927"><a href="#EmbeddingWidget-927"><span class="linenos"> 927</span></a>
</span><span id="EmbeddingWidget-928"><a href="#EmbeddingWidget-928"><span class="linenos"> 928</span></a>    <span class="k">def</span> <span class="nf">_create_settings_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EmbeddingWidget-929"><a href="#EmbeddingWidget-929"><span class="linenos"> 929</span></a>        <span class="n">setting_values</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="EmbeddingWidget-930"><a href="#EmbeddingWidget-930"><span class="linenos"> 930</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;settings&quot;</span><span class="p">))</span>
</span><span id="EmbeddingWidget-931"><a href="#EmbeddingWidget-931"><span class="linenos"> 931</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="EmbeddingWidget-932"><a href="#EmbeddingWidget-932"><span class="linenos"> 932</span></a>
</span><span id="EmbeddingWidget-933"><a href="#EmbeddingWidget-933"><span class="linenos"> 933</span></a>        <span class="c1"># Create UI for the device.</span>
</span><span id="EmbeddingWidget-934"><a href="#EmbeddingWidget-934"><span class="linenos"> 934</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="EmbeddingWidget-935"><a href="#EmbeddingWidget-935"><span class="linenos"> 935</span></a>        <span class="n">device_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">_available_devices</span><span class="p">()</span>
</span><span id="EmbeddingWidget-936"><a href="#EmbeddingWidget-936"><span class="linenos"> 936</span></a>
</span><span id="EmbeddingWidget-937"><a href="#EmbeddingWidget-937"><span class="linenos"> 937</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device_dropdown</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_choice_param</span><span class="p">(</span><span class="s2">&quot;device&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">device_options</span><span class="p">,</span>
</span><span id="EmbeddingWidget-938"><a href="#EmbeddingWidget-938"><span class="linenos"> 938</span></a>                                                              <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;device&quot;</span><span class="p">))</span>
</span><span id="EmbeddingWidget-939"><a href="#EmbeddingWidget-939"><span class="linenos"> 939</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="EmbeddingWidget-940"><a href="#EmbeddingWidget-940"><span class="linenos"> 940</span></a>
</span><span id="EmbeddingWidget-941"><a href="#EmbeddingWidget-941"><span class="linenos"> 941</span></a>        <span class="c1"># Create UI for the save path.</span>
</span><span id="EmbeddingWidget-942"><a href="#EmbeddingWidget-942"><span class="linenos"> 942</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EmbeddingWidget-943"><a href="#EmbeddingWidget-943"><span class="linenos"> 943</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_path_param</span><span class="p">(</span>
</span><span id="EmbeddingWidget-944"><a href="#EmbeddingWidget-944"><span class="linenos"> 944</span></a>            <span class="s2">&quot;embeddings_save_path&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">,</span> <span class="s2">&quot;directory&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;embeddings save path:&quot;</span><span class="p">,</span>
</span><span id="EmbeddingWidget-945"><a href="#EmbeddingWidget-945"><span class="linenos"> 945</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;embeddings_save_path&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-946"><a href="#EmbeddingWidget-946"><span class="linenos"> 946</span></a>        <span class="p">)</span>
</span><span id="EmbeddingWidget-947"><a href="#EmbeddingWidget-947"><span class="linenos"> 947</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="EmbeddingWidget-948"><a href="#EmbeddingWidget-948"><span class="linenos"> 948</span></a>
</span><span id="EmbeddingWidget-949"><a href="#EmbeddingWidget-949"><span class="linenos"> 949</span></a>        <span class="c1"># Create UI for the custom weights.</span>
</span><span id="EmbeddingWidget-950"><a href="#EmbeddingWidget-950"><span class="linenos"> 950</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="EmbeddingWidget-951"><a href="#EmbeddingWidget-951"><span class="linenos"> 951</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_path_param</span><span class="p">(</span>
</span><span id="EmbeddingWidget-952"><a href="#EmbeddingWidget-952"><span class="linenos"> 952</span></a>            <span class="s2">&quot;custom_weights&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;custom weights path:&quot;</span><span class="p">,</span>
</span><span id="EmbeddingWidget-953"><a href="#EmbeddingWidget-953"><span class="linenos"> 953</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;custom_weights&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-954"><a href="#EmbeddingWidget-954"><span class="linenos"> 954</span></a>        <span class="p">)</span>
</span><span id="EmbeddingWidget-955"><a href="#EmbeddingWidget-955"><span class="linenos"> 955</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="EmbeddingWidget-956"><a href="#EmbeddingWidget-956"><span class="linenos"> 956</span></a>
</span><span id="EmbeddingWidget-957"><a href="#EmbeddingWidget-957"><span class="linenos"> 957</span></a>        <span class="c1"># Create UI for the tile shape.</span>
</span><span id="EmbeddingWidget-958"><a href="#EmbeddingWidget-958"><span class="linenos"> 958</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="EmbeddingWidget-959"><a href="#EmbeddingWidget-959"><span class="linenos"> 959</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tile_x_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_shape_param</span><span class="p">(</span>
</span><span id="EmbeddingWidget-960"><a href="#EmbeddingWidget-960"><span class="linenos"> 960</span></a>            <span class="p">(</span><span class="s2">&quot;tile_x&quot;</span><span class="p">,</span> <span class="s2">&quot;tile_y&quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="p">),</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
</span><span id="EmbeddingWidget-961"><a href="#EmbeddingWidget-961"><span class="linenos"> 961</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;tiling&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-962"><a href="#EmbeddingWidget-962"><span class="linenos"> 962</span></a>        <span class="p">)</span>
</span><span id="EmbeddingWidget-963"><a href="#EmbeddingWidget-963"><span class="linenos"> 963</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="EmbeddingWidget-964"><a href="#EmbeddingWidget-964"><span class="linenos"> 964</span></a>
</span><span id="EmbeddingWidget-965"><a href="#EmbeddingWidget-965"><span class="linenos"> 965</span></a>        <span class="c1"># Create UI for the halo.</span>
</span><span id="EmbeddingWidget-966"><a href="#EmbeddingWidget-966"><span class="linenos"> 966</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="EmbeddingWidget-967"><a href="#EmbeddingWidget-967"><span class="linenos"> 967</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">halo_x_param</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_shape_param</span><span class="p">(</span>
</span><span id="EmbeddingWidget-968"><a href="#EmbeddingWidget-968"><span class="linenos"> 968</span></a>            <span class="p">(</span><span class="s2">&quot;halo_x&quot;</span><span class="p">,</span> <span class="s2">&quot;halo_y&quot;</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="p">),</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span><span id="EmbeddingWidget-969"><a href="#EmbeddingWidget-969"><span class="linenos"> 969</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;halo&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-970"><a href="#EmbeddingWidget-970"><span class="linenos"> 970</span></a>        <span class="p">)</span>
</span><span id="EmbeddingWidget-971"><a href="#EmbeddingWidget-971"><span class="linenos"> 971</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="EmbeddingWidget-972"><a href="#EmbeddingWidget-972"><span class="linenos"> 972</span></a>
</span><span id="EmbeddingWidget-973"><a href="#EmbeddingWidget-973"><span class="linenos"> 973</span></a>        <span class="c1"># Create UI for prefering the decoder.</span>
</span><span id="EmbeddingWidget-974"><a href="#EmbeddingWidget-974"><span class="linenos"> 974</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefer_decoder</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="EmbeddingWidget-975"><a href="#EmbeddingWidget-975"><span class="linenos"> 975</span></a>        <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_boolean_param</span><span class="p">(</span>
</span><span id="EmbeddingWidget-976"><a href="#EmbeddingWidget-976"><span class="linenos"> 976</span></a>            <span class="s2">&quot;prefer_decoder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefer_decoder</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Prefer Segmentation Decoder&quot;</span><span class="p">,</span>
</span><span id="EmbeddingWidget-977"><a href="#EmbeddingWidget-977"><span class="linenos"> 977</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;prefer_decoder&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-978"><a href="#EmbeddingWidget-978"><span class="linenos"> 978</span></a>        <span class="p">)</span>
</span><span id="EmbeddingWidget-979"><a href="#EmbeddingWidget-979"><span class="linenos"> 979</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
</span><span id="EmbeddingWidget-980"><a href="#EmbeddingWidget-980"><span class="linenos"> 980</span></a>
</span><span id="EmbeddingWidget-981"><a href="#EmbeddingWidget-981"><span class="linenos"> 981</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">_make_collapsible</span><span class="p">(</span><span class="n">setting_values</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Embedding Settings&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-982"><a href="#EmbeddingWidget-982"><span class="linenos"> 982</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="EmbeddingWidget-983"><a href="#EmbeddingWidget-983"><span class="linenos"> 983</span></a>
</span><span id="EmbeddingWidget-984"><a href="#EmbeddingWidget-984"><span class="linenos"> 984</span></a>    <span class="k">def</span> <span class="nf">_validate_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EmbeddingWidget-985"><a href="#EmbeddingWidget-985"><span class="linenos"> 985</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EmbeddingWidget-986"><a href="#EmbeddingWidget-986"><span class="linenos"> 986</span></a><span class="sd">        Validates the inputs for the annotation process and returns a dictionary</span>
</span><span id="EmbeddingWidget-987"><a href="#EmbeddingWidget-987"><span class="linenos"> 987</span></a><span class="sd">        containing information for message generation, or False if no messages are needed.</span>
</span><span id="EmbeddingWidget-988"><a href="#EmbeddingWidget-988"><span class="linenos"> 988</span></a>
</span><span id="EmbeddingWidget-989"><a href="#EmbeddingWidget-989"><span class="linenos"> 989</span></a><span class="sd">        This function performs the following checks:</span>
</span><span id="EmbeddingWidget-990"><a href="#EmbeddingWidget-990"><span class="linenos"> 990</span></a>
</span><span id="EmbeddingWidget-991"><a href="#EmbeddingWidget-991"><span class="linenos"> 991</span></a><span class="sd">        - If an `embeddings_save_path` is provided:</span>
</span><span id="EmbeddingWidget-992"><a href="#EmbeddingWidget-992"><span class="linenos"> 992</span></a><span class="sd">            - Validates the image data signature by comparing it with the signature</span>
</span><span id="EmbeddingWidget-993"><a href="#EmbeddingWidget-993"><span class="linenos"> 993</span></a><span class="sd">            of the image data in the viewer&#39;s selection.</span>
</span><span id="EmbeddingWidget-994"><a href="#EmbeddingWidget-994"><span class="linenos"> 994</span></a><span class="sd">            - Checks for existing embeddings at the specified path.</span>
</span><span id="EmbeddingWidget-995"><a href="#EmbeddingWidget-995"><span class="linenos"> 995</span></a><span class="sd">                - If existing embeddings are found, it attempts to load parameters</span>
</span><span id="EmbeddingWidget-996"><a href="#EmbeddingWidget-996"><span class="linenos"> 996</span></a><span class="sd">                like tile shape, halo, and model type from the Zarr attributes.</span>
</span><span id="EmbeddingWidget-997"><a href="#EmbeddingWidget-997"><span class="linenos"> 997</span></a><span class="sd">                - An informational message is generated based on the loaded parameters.</span>
</span><span id="EmbeddingWidget-998"><a href="#EmbeddingWidget-998"><span class="linenos"> 998</span></a><span class="sd">                - If loading existing embeddings fails, an error message is generated.</span>
</span><span id="EmbeddingWidget-999"><a href="#EmbeddingWidget-999"><span class="linenos"> 999</span></a><span class="sd">                - If no existing embeddings are found, an informational message is generated.</span>
</span><span id="EmbeddingWidget-1000"><a href="#EmbeddingWidget-1000"><span class="linenos">1000</span></a><span class="sd">        - If no `embeddings_save_path` is provided, the function returns None.</span>
</span><span id="EmbeddingWidget-1001"><a href="#EmbeddingWidget-1001"><span class="linenos">1001</span></a>
</span><span id="EmbeddingWidget-1002"><a href="#EmbeddingWidget-1002"><span class="linenos">1002</span></a><span class="sd">        Returns:</span>
</span><span id="EmbeddingWidget-1003"><a href="#EmbeddingWidget-1003"><span class="linenos">1003</span></a><span class="sd">            bool: True if the computation should be aborted, otherwise False.</span>
</span><span id="EmbeddingWidget-1004"><a href="#EmbeddingWidget-1004"><span class="linenos">1004</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EmbeddingWidget-1005"><a href="#EmbeddingWidget-1005"><span class="linenos">1005</span></a>
</span><span id="EmbeddingWidget-1006"><a href="#EmbeddingWidget-1006"><span class="linenos">1006</span></a>        <span class="c1"># Check if we have an existing embedding path.</span>
</span><span id="EmbeddingWidget-1007"><a href="#EmbeddingWidget-1007"><span class="linenos">1007</span></a>        <span class="c1"># If yes we check the data signature of these embeddings against the selected image</span>
</span><span id="EmbeddingWidget-1008"><a href="#EmbeddingWidget-1008"><span class="linenos">1008</span></a>        <span class="c1"># and we ask the user if they want to load these embeddings.</span>
</span><span id="EmbeddingWidget-1009"><a href="#EmbeddingWidget-1009"><span class="linenos">1009</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">):</span>
</span><span id="EmbeddingWidget-1010"><a href="#EmbeddingWidget-1010"><span class="linenos">1010</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1011"><a href="#EmbeddingWidget-1011"><span class="linenos">1011</span></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1012"><a href="#EmbeddingWidget-1012"><span class="linenos">1012</span></a>
</span><span id="EmbeddingWidget-1013"><a href="#EmbeddingWidget-1013"><span class="linenos">1013</span></a>                <span class="c1"># Validate that the embeddings are complete.</span>
</span><span id="EmbeddingWidget-1014"><a href="#EmbeddingWidget-1014"><span class="linenos">1014</span></a>                <span class="c1"># Note: &#39;input_size&#39; is the last value set in the attrs of f,</span>
</span><span id="EmbeddingWidget-1015"><a href="#EmbeddingWidget-1015"><span class="linenos">1015</span></a>                <span class="c1"># so we can use it as a proxy to check if the embeddings are fully computed</span>
</span><span id="EmbeddingWidget-1016"><a href="#EmbeddingWidget-1016"><span class="linenos">1016</span></a>                <span class="k">if</span> <span class="s2">&quot;input_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1017"><a href="#EmbeddingWidget-1017"><span class="linenos">1017</span></a>                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The embeddings at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span><span class="si">}</span><span class="s2"> are incomplete. &quot;</span>
</span><span id="EmbeddingWidget-1018"><a href="#EmbeddingWidget-1018"><span class="linenos">1018</span></a>                           <span class="s2">&quot;Specify a different path or remove them.&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1019"><a href="#EmbeddingWidget-1019"><span class="linenos">1019</span></a>                    <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1020"><a href="#EmbeddingWidget-1020"><span class="linenos">1020</span></a>
</span><span id="EmbeddingWidget-1021"><a href="#EmbeddingWidget-1021"><span class="linenos">1021</span></a>                <span class="c1"># Validate image data signature.</span>
</span><span id="EmbeddingWidget-1022"><a href="#EmbeddingWidget-1022"><span class="linenos">1022</span></a>                <span class="k">if</span> <span class="s2">&quot;data_signature&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1023"><a href="#EmbeddingWidget-1023"><span class="linenos">1023</span></a>                    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1024"><a href="#EmbeddingWidget-1024"><span class="linenos">1024</span></a>                    <span class="n">img_signature</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">_compute_data_signature</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1025"><a href="#EmbeddingWidget-1025"><span class="linenos">1025</span></a>                    <span class="k">if</span> <span class="n">img_signature</span> <span class="o">!=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;data_signature&quot;</span><span class="p">]:</span>
</span><span id="EmbeddingWidget-1026"><a href="#EmbeddingWidget-1026"><span class="linenos">1026</span></a>                        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The embeddings don&#39;t match with the image: </span><span class="si">{</span><span class="n">img_signature</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_signature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="EmbeddingWidget-1027"><a href="#EmbeddingWidget-1027"><span class="linenos">1027</span></a>                        <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1028"><a href="#EmbeddingWidget-1028"><span class="linenos">1028</span></a>
</span><span id="EmbeddingWidget-1029"><a href="#EmbeddingWidget-1029"><span class="linenos">1029</span></a>                <span class="c1"># Load existing parameters.</span>
</span><span id="EmbeddingWidget-1030"><a href="#EmbeddingWidget-1030"><span class="linenos">1030</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;model_type&quot;</span><span class="p">])</span>
</span><span id="EmbeddingWidget-1031"><a href="#EmbeddingWidget-1031"><span class="linenos">1031</span></a>                <span class="k">if</span> <span class="s2">&quot;tile_shape&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tile_shape&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1032"><a href="#EmbeddingWidget-1032"><span class="linenos">1032</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;tile_shape&quot;</span><span class="p">]</span>
</span><span id="EmbeddingWidget-1033"><a href="#EmbeddingWidget-1033"><span class="linenos">1033</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;halo&quot;</span><span class="p">]</span>
</span><span id="EmbeddingWidget-1034"><a href="#EmbeddingWidget-1034"><span class="linenos">1034</span></a>                    <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="EmbeddingWidget-1035"><a href="#EmbeddingWidget-1035"><span class="linenos">1035</span></a>                        <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
</span><span id="EmbeddingWidget-1036"><a href="#EmbeddingWidget-1036"><span class="linenos">1036</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load embeddings for model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2"> with tile shape: &quot;</span>
</span><span id="EmbeddingWidget-1037"><a href="#EmbeddingWidget-1037"><span class="linenos">1037</span></a>                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="si">}</span><span class="s2"> and halo: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1038"><a href="#EmbeddingWidget-1038"><span class="linenos">1038</span></a>                    <span class="p">}</span>
</span><span id="EmbeddingWidget-1039"><a href="#EmbeddingWidget-1039"><span class="linenos">1039</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1040"><a href="#EmbeddingWidget-1040"><span class="linenos">1040</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="EmbeddingWidget-1041"><a href="#EmbeddingWidget-1041"><span class="linenos">1041</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="EmbeddingWidget-1042"><a href="#EmbeddingWidget-1042"><span class="linenos">1042</span></a>                    <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="EmbeddingWidget-1043"><a href="#EmbeddingWidget-1043"><span class="linenos">1043</span></a>                        <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
</span><span id="EmbeddingWidget-1044"><a href="#EmbeddingWidget-1044"><span class="linenos">1044</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Load embeddings for model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="EmbeddingWidget-1045"><a href="#EmbeddingWidget-1045"><span class="linenos">1045</span></a>                    <span class="p">}</span>
</span><span id="EmbeddingWidget-1046"><a href="#EmbeddingWidget-1046"><span class="linenos">1046</span></a>
</span><span id="EmbeddingWidget-1047"><a href="#EmbeddingWidget-1047"><span class="linenos">1047</span></a>                <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="EmbeddingWidget-1048"><a href="#EmbeddingWidget-1048"><span class="linenos">1048</span></a>
</span><span id="EmbeddingWidget-1049"><a href="#EmbeddingWidget-1049"><span class="linenos">1049</span></a>            <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1050"><a href="#EmbeddingWidget-1050"><span class="linenos">1050</span></a>                <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="EmbeddingWidget-1051"><a href="#EmbeddingWidget-1051"><span class="linenos">1051</span></a>                    <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="EmbeddingWidget-1052"><a href="#EmbeddingWidget-1052"><span class="linenos">1052</span></a>                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to load image embeddings: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="EmbeddingWidget-1053"><a href="#EmbeddingWidget-1053"><span class="linenos">1053</span></a>                <span class="p">}</span>
</span><span id="EmbeddingWidget-1054"><a href="#EmbeddingWidget-1054"><span class="linenos">1054</span></a>                <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="EmbeddingWidget-1055"><a href="#EmbeddingWidget-1055"><span class="linenos">1055</span></a>
</span><span id="EmbeddingWidget-1056"><a href="#EmbeddingWidget-1056"><span class="linenos">1056</span></a>        <span class="c1"># Otherwise we either don&#39;t have an embedding path or it is empty. We can proceed in both cases.</span>
</span><span id="EmbeddingWidget-1057"><a href="#EmbeddingWidget-1057"><span class="linenos">1057</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="EmbeddingWidget-1058"><a href="#EmbeddingWidget-1058"><span class="linenos">1058</span></a>
</span><span id="EmbeddingWidget-1059"><a href="#EmbeddingWidget-1059"><span class="linenos">1059</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="EmbeddingWidget-1060"><a href="#EmbeddingWidget-1060"><span class="linenos">1060</span></a>        <span class="c1"># Validate user inputs.</span>
</span><span id="EmbeddingWidget-1061"><a href="#EmbeddingWidget-1061"><span class="linenos">1061</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_validate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_inputs</span><span class="p">():</span>
</span><span id="EmbeddingWidget-1062"><a href="#EmbeddingWidget-1062"><span class="linenos">1062</span></a>            <span class="k">return</span>
</span><span id="EmbeddingWidget-1063"><a href="#EmbeddingWidget-1063"><span class="linenos">1063</span></a>
</span><span id="EmbeddingWidget-1064"><a href="#EmbeddingWidget-1064"><span class="linenos">1064</span></a>        <span class="c1"># Get the image.</span>
</span><span id="EmbeddingWidget-1065"><a href="#EmbeddingWidget-1065"><span class="linenos">1065</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_selection</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1066"><a href="#EmbeddingWidget-1066"><span class="linenos">1066</span></a>
</span><span id="EmbeddingWidget-1067"><a href="#EmbeddingWidget-1067"><span class="linenos">1067</span></a>        <span class="c1"># Update the image embeddings:</span>
</span><span id="EmbeddingWidget-1068"><a href="#EmbeddingWidget-1068"><span class="linenos">1068</span></a>        <span class="c1"># Reset the state.</span>
</span><span id="EmbeddingWidget-1069"><a href="#EmbeddingWidget-1069"><span class="linenos">1069</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1070"><a href="#EmbeddingWidget-1070"><span class="linenos">1070</span></a>        <span class="n">state</span><span class="o">.</span><span class="n">reset_state</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1071"><a href="#EmbeddingWidget-1071"><span class="linenos">1071</span></a>
</span><span id="EmbeddingWidget-1072"><a href="#EmbeddingWidget-1072"><span class="linenos">1072</span></a>        <span class="c1"># Get image dimensions.</span>
</span><span id="EmbeddingWidget-1073"><a href="#EmbeddingWidget-1073"><span class="linenos">1073</span></a>        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1074"><a href="#EmbeddingWidget-1074"><span class="linenos">1074</span></a>            <span class="n">ndim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="EmbeddingWidget-1075"><a href="#EmbeddingWidget-1075"><span class="linenos">1075</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="EmbeddingWidget-1076"><a href="#EmbeddingWidget-1076"><span class="linenos">1076</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="EmbeddingWidget-1077"><a href="#EmbeddingWidget-1077"><span class="linenos">1077</span></a>            <span class="n">ndim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
</span><span id="EmbeddingWidget-1078"><a href="#EmbeddingWidget-1078"><span class="linenos">1078</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</span><span id="EmbeddingWidget-1079"><a href="#EmbeddingWidget-1079"><span class="linenos">1079</span></a>
</span><span id="EmbeddingWidget-1080"><a href="#EmbeddingWidget-1080"><span class="linenos">1080</span></a>        <span class="c1"># Process tile_shape and halo, set other data.</span>
</span><span id="EmbeddingWidget-1081"><a href="#EmbeddingWidget-1081"><span class="linenos">1081</span></a>        <span class="n">tile_shape</span><span class="p">,</span> <span class="n">halo</span> <span class="o">=</span> <span class="n">_process_tiling_inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">halo_y</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1082"><a href="#EmbeddingWidget-1082"><span class="linenos">1082</span></a>        <span class="n">save_path</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings_save_path</span>
</span><span id="EmbeddingWidget-1083"><a href="#EmbeddingWidget-1083"><span class="linenos">1083</span></a>        <span class="n">image_data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span>
</span><span id="EmbeddingWidget-1084"><a href="#EmbeddingWidget-1084"><span class="linenos">1084</span></a>
</span><span id="EmbeddingWidget-1085"><a href="#EmbeddingWidget-1085"><span class="linenos">1085</span></a>        <span class="c1"># Set up progress bar and signals for using it within a threadworker.</span>
</span><span id="EmbeddingWidget-1086"><a href="#EmbeddingWidget-1086"><span class="linenos">1086</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1087"><a href="#EmbeddingWidget-1087"><span class="linenos">1087</span></a>
</span><span id="EmbeddingWidget-1088"><a href="#EmbeddingWidget-1088"><span class="linenos">1088</span></a>        <span class="nd">@thread_worker</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1089"><a href="#EmbeddingWidget-1089"><span class="linenos">1089</span></a>        <span class="k">def</span> <span class="nf">compute_image_embedding</span><span class="p">():</span>
</span><span id="EmbeddingWidget-1090"><a href="#EmbeddingWidget-1090"><span class="linenos">1090</span></a>
</span><span id="EmbeddingWidget-1091"><a href="#EmbeddingWidget-1091"><span class="linenos">1091</span></a>            <span class="k">def</span> <span class="nf">pbar_init</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
</span><span id="EmbeddingWidget-1092"><a href="#EmbeddingWidget-1092"><span class="linenos">1092</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1093"><a href="#EmbeddingWidget-1093"><span class="linenos">1093</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1094"><a href="#EmbeddingWidget-1094"><span class="linenos">1094</span></a>
</span><span id="EmbeddingWidget-1095"><a href="#EmbeddingWidget-1095"><span class="linenos">1095</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">initialize_predictor</span><span class="p">(</span>
</span><span id="EmbeddingWidget-1096"><a href="#EmbeddingWidget-1096"><span class="linenos">1096</span></a>                <span class="n">image_data</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="n">ndim</span><span class="p">,</span>
</span><span id="EmbeddingWidget-1097"><a href="#EmbeddingWidget-1097"><span class="linenos">1097</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_weights</span><span class="p">,</span> <span class="n">tile_shape</span><span class="o">=</span><span class="n">tile_shape</span><span class="p">,</span> <span class="n">halo</span><span class="o">=</span><span class="n">halo</span><span class="p">,</span>
</span><span id="EmbeddingWidget-1098"><a href="#EmbeddingWidget-1098"><span class="linenos">1098</span></a>                <span class="n">prefer_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefer_decoder</span><span class="p">,</span> <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span>
</span><span id="EmbeddingWidget-1099"><a href="#EmbeddingWidget-1099"><span class="linenos">1099</span></a>                <span class="n">pbar_update</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="EmbeddingWidget-1100"><a href="#EmbeddingWidget-1100"><span class="linenos">1100</span></a>            <span class="p">)</span>
</span><span id="EmbeddingWidget-1101"><a href="#EmbeddingWidget-1101"><span class="linenos">1101</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1102"><a href="#EmbeddingWidget-1102"><span class="linenos">1102</span></a>
</span><span id="EmbeddingWidget-1103"><a href="#EmbeddingWidget-1103"><span class="linenos">1103</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">compute_image_embedding</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1104"><a href="#EmbeddingWidget-1104"><span class="linenos">1104</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_model</span><span class="p">)</span>
</span><span id="EmbeddingWidget-1105"><a href="#EmbeddingWidget-1105"><span class="linenos">1105</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="EmbeddingWidget-1106"><a href="#EmbeddingWidget-1106"><span class="linenos">1106</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span></pre></div>


            <div class="docstring"><p>QWidget(parent: typing.Optional[QWidget] = None, flags: Union[Qt.WindowFlags, Qt.WindowType] = Qt.WindowFlags())</p>
</div>


                            <div id="EmbeddingWidget.__init__" class="classattr">
                                        <input id="EmbeddingWidget.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EmbeddingWidget</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">parent</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="EmbeddingWidget.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EmbeddingWidget.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EmbeddingWidget.__init__-842"><a href="#EmbeddingWidget.__init__-842"><span class="linenos">842</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="EmbeddingWidget.__init__-843"><a href="#EmbeddingWidget.__init__-843"><span class="linenos">843</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
</span><span id="EmbeddingWidget.__init__-844"><a href="#EmbeddingWidget.__init__-844"><span class="linenos">844</span></a>
</span><span id="EmbeddingWidget.__init__-845"><a href="#EmbeddingWidget.__init__-845"><span class="linenos">845</span></a>        <span class="c1"># Create a nested layout for the sections.</span>
</span><span id="EmbeddingWidget.__init__-846"><a href="#EmbeddingWidget.__init__-846"><span class="linenos">846</span></a>        <span class="c1"># Section 1: Image and Model.</span>
</span><span id="EmbeddingWidget.__init__-847"><a href="#EmbeddingWidget.__init__-847"><span class="linenos">847</span></a>        <span class="n">section1_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
</span><span id="EmbeddingWidget.__init__-848"><a href="#EmbeddingWidget.__init__-848"><span class="linenos">848</span></a>        <span class="n">section1_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_image_section</span><span class="p">())</span>
</span><span id="EmbeddingWidget.__init__-849"><a href="#EmbeddingWidget.__init__-849"><span class="linenos">849</span></a>        <span class="n">section1_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_model_section</span><span class="p">())</span>
</span><span id="EmbeddingWidget.__init__-850"><a href="#EmbeddingWidget.__init__-850"><span class="linenos">850</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">section1_layout</span><span class="p">)</span>
</span><span id="EmbeddingWidget.__init__-851"><a href="#EmbeddingWidget.__init__-851"><span class="linenos">851</span></a>
</span><span id="EmbeddingWidget.__init__-852"><a href="#EmbeddingWidget.__init__-852"><span class="linenos">852</span></a>        <span class="c1"># Section 2: Settings (collapsible).</span>
</span><span id="EmbeddingWidget.__init__-853"><a href="#EmbeddingWidget.__init__-853"><span class="linenos">853</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_settings_widget</span><span class="p">())</span>
</span><span id="EmbeddingWidget.__init__-854"><a href="#EmbeddingWidget.__init__-854"><span class="linenos">854</span></a>
</span><span id="EmbeddingWidget.__init__-855"><a href="#EmbeddingWidget.__init__-855"><span class="linenos">855</span></a>        <span class="c1"># Section 3: The button to trigger the embedding computation.</span>
</span><span id="EmbeddingWidget.__init__-856"><a href="#EmbeddingWidget.__init__-856"><span class="linenos">856</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Compute Embeddings&quot;</span><span class="p">)</span>
</span><span id="EmbeddingWidget.__init__-857"><a href="#EmbeddingWidget.__init__-857"><span class="linenos">857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initialize_image</span><span class="p">)</span>
</span><span id="EmbeddingWidget.__init__-858"><a href="#EmbeddingWidget.__init__-858"><span class="linenos">858</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="EmbeddingWidget.__init__-859"><a href="#EmbeddingWidget.__init__-859"><span class="linenos">859</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;embedding&quot;</span><span class="p">,</span> <span class="s2">&quot;run_button&quot;</span><span class="p">))</span>
</span><span id="EmbeddingWidget.__init__-860"><a href="#EmbeddingWidget.__init__-860"><span class="linenos">860</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="EmbeddingWidget.run_button" class="classattr">
                                <div class="attr variable">
            <span class="name">run_button</span>

        
    </div>
    <a class="headerlink" href="#EmbeddingWidget.run_button"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>PyQt5.QtWidgets.QWidget</dt>
                                <dd id="EmbeddingWidget.RenderFlag" class="class">RenderFlag</dd>
                <dd id="EmbeddingWidget.RenderFlags" class="class">RenderFlags</dd>
                <dd id="EmbeddingWidget.acceptDrops" class="function">acceptDrops</dd>
                <dd id="EmbeddingWidget.accessibleDescription" class="function">accessibleDescription</dd>
                <dd id="EmbeddingWidget.accessibleName" class="function">accessibleName</dd>
                <dd id="EmbeddingWidget.actionEvent" class="function">actionEvent</dd>
                <dd id="EmbeddingWidget.actions" class="function">actions</dd>
                <dd id="EmbeddingWidget.activateWindow" class="function">activateWindow</dd>
                <dd id="EmbeddingWidget.addAction" class="function">addAction</dd>
                <dd id="EmbeddingWidget.addActions" class="function">addActions</dd>
                <dd id="EmbeddingWidget.adjustSize" class="function">adjustSize</dd>
                <dd id="EmbeddingWidget.autoFillBackground" class="function">autoFillBackground</dd>
                <dd id="EmbeddingWidget.backgroundRole" class="function">backgroundRole</dd>
                <dd id="EmbeddingWidget.baseSize" class="function">baseSize</dd>
                <dd id="EmbeddingWidget.changeEvent" class="function">changeEvent</dd>
                <dd id="EmbeddingWidget.childAt" class="function">childAt</dd>
                <dd id="EmbeddingWidget.childrenRect" class="function">childrenRect</dd>
                <dd id="EmbeddingWidget.childrenRegion" class="function">childrenRegion</dd>
                <dd id="EmbeddingWidget.clearFocus" class="function">clearFocus</dd>
                <dd id="EmbeddingWidget.clearMask" class="function">clearMask</dd>
                <dd id="EmbeddingWidget.close" class="function">close</dd>
                <dd id="EmbeddingWidget.closeEvent" class="function">closeEvent</dd>
                <dd id="EmbeddingWidget.contentsMargins" class="function">contentsMargins</dd>
                <dd id="EmbeddingWidget.contentsRect" class="function">contentsRect</dd>
                <dd id="EmbeddingWidget.contextMenuEvent" class="function">contextMenuEvent</dd>
                <dd id="EmbeddingWidget.contextMenuPolicy" class="function">contextMenuPolicy</dd>
                <dd id="EmbeddingWidget.create" class="function">create</dd>
                <dd id="EmbeddingWidget.createWindowContainer" class="function">createWindowContainer</dd>
                <dd id="EmbeddingWidget.cursor" class="function">cursor</dd>
                <dd id="EmbeddingWidget.destroy" class="function">destroy</dd>
                <dd id="EmbeddingWidget.devType" class="function">devType</dd>
                <dd id="EmbeddingWidget.dragEnterEvent" class="function">dragEnterEvent</dd>
                <dd id="EmbeddingWidget.dragLeaveEvent" class="function">dragLeaveEvent</dd>
                <dd id="EmbeddingWidget.dragMoveEvent" class="function">dragMoveEvent</dd>
                <dd id="EmbeddingWidget.dropEvent" class="function">dropEvent</dd>
                <dd id="EmbeddingWidget.effectiveWinId" class="function">effectiveWinId</dd>
                <dd id="EmbeddingWidget.ensurePolished" class="function">ensurePolished</dd>
                <dd id="EmbeddingWidget.enterEvent" class="function">enterEvent</dd>
                <dd id="EmbeddingWidget.event" class="function">event</dd>
                <dd id="EmbeddingWidget.find" class="function">find</dd>
                <dd id="EmbeddingWidget.focusInEvent" class="function">focusInEvent</dd>
                <dd id="EmbeddingWidget.focusNextChild" class="function">focusNextChild</dd>
                <dd id="EmbeddingWidget.focusNextPrevChild" class="function">focusNextPrevChild</dd>
                <dd id="EmbeddingWidget.focusOutEvent" class="function">focusOutEvent</dd>
                <dd id="EmbeddingWidget.focusPolicy" class="function">focusPolicy</dd>
                <dd id="EmbeddingWidget.focusPreviousChild" class="function">focusPreviousChild</dd>
                <dd id="EmbeddingWidget.focusProxy" class="function">focusProxy</dd>
                <dd id="EmbeddingWidget.focusWidget" class="function">focusWidget</dd>
                <dd id="EmbeddingWidget.font" class="function">font</dd>
                <dd id="EmbeddingWidget.fontInfo" class="function">fontInfo</dd>
                <dd id="EmbeddingWidget.fontMetrics" class="function">fontMetrics</dd>
                <dd id="EmbeddingWidget.foregroundRole" class="function">foregroundRole</dd>
                <dd id="EmbeddingWidget.frameGeometry" class="function">frameGeometry</dd>
                <dd id="EmbeddingWidget.frameSize" class="function">frameSize</dd>
                <dd id="EmbeddingWidget.geometry" class="function">geometry</dd>
                <dd id="EmbeddingWidget.getContentsMargins" class="function">getContentsMargins</dd>
                <dd id="EmbeddingWidget.grab" class="function">grab</dd>
                <dd id="EmbeddingWidget.grabGesture" class="function">grabGesture</dd>
                <dd id="EmbeddingWidget.grabKeyboard" class="function">grabKeyboard</dd>
                <dd id="EmbeddingWidget.grabMouse" class="function">grabMouse</dd>
                <dd id="EmbeddingWidget.grabShortcut" class="function">grabShortcut</dd>
                <dd id="EmbeddingWidget.graphicsEffect" class="function">graphicsEffect</dd>
                <dd id="EmbeddingWidget.graphicsProxyWidget" class="function">graphicsProxyWidget</dd>
                <dd id="EmbeddingWidget.hasFocus" class="function">hasFocus</dd>
                <dd id="EmbeddingWidget.hasHeightForWidth" class="function">hasHeightForWidth</dd>
                <dd id="EmbeddingWidget.hasMouseTracking" class="function">hasMouseTracking</dd>
                <dd id="EmbeddingWidget.hasTabletTracking" class="function">hasTabletTracking</dd>
                <dd id="EmbeddingWidget.height" class="function">height</dd>
                <dd id="EmbeddingWidget.heightForWidth" class="function">heightForWidth</dd>
                <dd id="EmbeddingWidget.hide" class="function">hide</dd>
                <dd id="EmbeddingWidget.hideEvent" class="function">hideEvent</dd>
                <dd id="EmbeddingWidget.initPainter" class="function">initPainter</dd>
                <dd id="EmbeddingWidget.inputMethodEvent" class="function">inputMethodEvent</dd>
                <dd id="EmbeddingWidget.inputMethodHints" class="function">inputMethodHints</dd>
                <dd id="EmbeddingWidget.inputMethodQuery" class="function">inputMethodQuery</dd>
                <dd id="EmbeddingWidget.insertAction" class="function">insertAction</dd>
                <dd id="EmbeddingWidget.insertActions" class="function">insertActions</dd>
                <dd id="EmbeddingWidget.isActiveWindow" class="function">isActiveWindow</dd>
                <dd id="EmbeddingWidget.isAncestorOf" class="function">isAncestorOf</dd>
                <dd id="EmbeddingWidget.isEnabled" class="function">isEnabled</dd>
                <dd id="EmbeddingWidget.isEnabledTo" class="function">isEnabledTo</dd>
                <dd id="EmbeddingWidget.isFullScreen" class="function">isFullScreen</dd>
                <dd id="EmbeddingWidget.isHidden" class="function">isHidden</dd>
                <dd id="EmbeddingWidget.isLeftToRight" class="function">isLeftToRight</dd>
                <dd id="EmbeddingWidget.isMaximized" class="function">isMaximized</dd>
                <dd id="EmbeddingWidget.isMinimized" class="function">isMinimized</dd>
                <dd id="EmbeddingWidget.isModal" class="function">isModal</dd>
                <dd id="EmbeddingWidget.isRightToLeft" class="function">isRightToLeft</dd>
                <dd id="EmbeddingWidget.isVisible" class="function">isVisible</dd>
                <dd id="EmbeddingWidget.isVisibleTo" class="function">isVisibleTo</dd>
                <dd id="EmbeddingWidget.isWindow" class="function">isWindow</dd>
                <dd id="EmbeddingWidget.isWindowModified" class="function">isWindowModified</dd>
                <dd id="EmbeddingWidget.keyPressEvent" class="function">keyPressEvent</dd>
                <dd id="EmbeddingWidget.keyReleaseEvent" class="function">keyReleaseEvent</dd>
                <dd id="EmbeddingWidget.keyboardGrabber" class="function">keyboardGrabber</dd>
                <dd id="EmbeddingWidget.layout" class="function">layout</dd>
                <dd id="EmbeddingWidget.layoutDirection" class="function">layoutDirection</dd>
                <dd id="EmbeddingWidget.leaveEvent" class="function">leaveEvent</dd>
                <dd id="EmbeddingWidget.locale" class="function">locale</dd>
                <dd id="EmbeddingWidget.lower" class="function">lower</dd>
                <dd id="EmbeddingWidget.mapFrom" class="function">mapFrom</dd>
                <dd id="EmbeddingWidget.mapFromGlobal" class="function">mapFromGlobal</dd>
                <dd id="EmbeddingWidget.mapFromParent" class="function">mapFromParent</dd>
                <dd id="EmbeddingWidget.mapTo" class="function">mapTo</dd>
                <dd id="EmbeddingWidget.mapToGlobal" class="function">mapToGlobal</dd>
                <dd id="EmbeddingWidget.mapToParent" class="function">mapToParent</dd>
                <dd id="EmbeddingWidget.mask" class="function">mask</dd>
                <dd id="EmbeddingWidget.maximumHeight" class="function">maximumHeight</dd>
                <dd id="EmbeddingWidget.maximumSize" class="function">maximumSize</dd>
                <dd id="EmbeddingWidget.maximumWidth" class="function">maximumWidth</dd>
                <dd id="EmbeddingWidget.metric" class="function">metric</dd>
                <dd id="EmbeddingWidget.minimumHeight" class="function">minimumHeight</dd>
                <dd id="EmbeddingWidget.minimumSize" class="function">minimumSize</dd>
                <dd id="EmbeddingWidget.minimumSizeHint" class="function">minimumSizeHint</dd>
                <dd id="EmbeddingWidget.minimumWidth" class="function">minimumWidth</dd>
                <dd id="EmbeddingWidget.mouseDoubleClickEvent" class="function">mouseDoubleClickEvent</dd>
                <dd id="EmbeddingWidget.mouseGrabber" class="function">mouseGrabber</dd>
                <dd id="EmbeddingWidget.mouseMoveEvent" class="function">mouseMoveEvent</dd>
                <dd id="EmbeddingWidget.mousePressEvent" class="function">mousePressEvent</dd>
                <dd id="EmbeddingWidget.mouseReleaseEvent" class="function">mouseReleaseEvent</dd>
                <dd id="EmbeddingWidget.move" class="function">move</dd>
                <dd id="EmbeddingWidget.moveEvent" class="function">moveEvent</dd>
                <dd id="EmbeddingWidget.nativeEvent" class="function">nativeEvent</dd>
                <dd id="EmbeddingWidget.nativeParentWidget" class="function">nativeParentWidget</dd>
                <dd id="EmbeddingWidget.nextInFocusChain" class="function">nextInFocusChain</dd>
                <dd id="EmbeddingWidget.normalGeometry" class="function">normalGeometry</dd>
                <dd id="EmbeddingWidget.overrideWindowFlags" class="function">overrideWindowFlags</dd>
                <dd id="EmbeddingWidget.overrideWindowState" class="function">overrideWindowState</dd>
                <dd id="EmbeddingWidget.paintEngine" class="function">paintEngine</dd>
                <dd id="EmbeddingWidget.paintEvent" class="function">paintEvent</dd>
                <dd id="EmbeddingWidget.palette" class="function">palette</dd>
                <dd id="EmbeddingWidget.parentWidget" class="function">parentWidget</dd>
                <dd id="EmbeddingWidget.pos" class="function">pos</dd>
                <dd id="EmbeddingWidget.previousInFocusChain" class="function">previousInFocusChain</dd>
                <dd id="EmbeddingWidget.raise_" class="function">raise_</dd>
                <dd id="EmbeddingWidget.rect" class="function">rect</dd>
                <dd id="EmbeddingWidget.releaseKeyboard" class="function">releaseKeyboard</dd>
                <dd id="EmbeddingWidget.releaseMouse" class="function">releaseMouse</dd>
                <dd id="EmbeddingWidget.releaseShortcut" class="function">releaseShortcut</dd>
                <dd id="EmbeddingWidget.removeAction" class="function">removeAction</dd>
                <dd id="EmbeddingWidget.render" class="function">render</dd>
                <dd id="EmbeddingWidget.repaint" class="function">repaint</dd>
                <dd id="EmbeddingWidget.resize" class="function">resize</dd>
                <dd id="EmbeddingWidget.resizeEvent" class="function">resizeEvent</dd>
                <dd id="EmbeddingWidget.restoreGeometry" class="function">restoreGeometry</dd>
                <dd id="EmbeddingWidget.saveGeometry" class="function">saveGeometry</dd>
                <dd id="EmbeddingWidget.screen" class="function">screen</dd>
                <dd id="EmbeddingWidget.scroll" class="function">scroll</dd>
                <dd id="EmbeddingWidget.setAcceptDrops" class="function">setAcceptDrops</dd>
                <dd id="EmbeddingWidget.setAccessibleDescription" class="function">setAccessibleDescription</dd>
                <dd id="EmbeddingWidget.setAccessibleName" class="function">setAccessibleName</dd>
                <dd id="EmbeddingWidget.setAttribute" class="function">setAttribute</dd>
                <dd id="EmbeddingWidget.setAutoFillBackground" class="function">setAutoFillBackground</dd>
                <dd id="EmbeddingWidget.setBackgroundRole" class="function">setBackgroundRole</dd>
                <dd id="EmbeddingWidget.setBaseSize" class="function">setBaseSize</dd>
                <dd id="EmbeddingWidget.setContentsMargins" class="function">setContentsMargins</dd>
                <dd id="EmbeddingWidget.setContextMenuPolicy" class="function">setContextMenuPolicy</dd>
                <dd id="EmbeddingWidget.setCursor" class="function">setCursor</dd>
                <dd id="EmbeddingWidget.setDisabled" class="function">setDisabled</dd>
                <dd id="EmbeddingWidget.setEnabled" class="function">setEnabled</dd>
                <dd id="EmbeddingWidget.setFixedHeight" class="function">setFixedHeight</dd>
                <dd id="EmbeddingWidget.setFixedSize" class="function">setFixedSize</dd>
                <dd id="EmbeddingWidget.setFixedWidth" class="function">setFixedWidth</dd>
                <dd id="EmbeddingWidget.setFocus" class="function">setFocus</dd>
                <dd id="EmbeddingWidget.setFocusPolicy" class="function">setFocusPolicy</dd>
                <dd id="EmbeddingWidget.setFocusProxy" class="function">setFocusProxy</dd>
                <dd id="EmbeddingWidget.setFont" class="function">setFont</dd>
                <dd id="EmbeddingWidget.setForegroundRole" class="function">setForegroundRole</dd>
                <dd id="EmbeddingWidget.setGeometry" class="function">setGeometry</dd>
                <dd id="EmbeddingWidget.setGraphicsEffect" class="function">setGraphicsEffect</dd>
                <dd id="EmbeddingWidget.setHidden" class="function">setHidden</dd>
                <dd id="EmbeddingWidget.setInputMethodHints" class="function">setInputMethodHints</dd>
                <dd id="EmbeddingWidget.setLayout" class="function">setLayout</dd>
                <dd id="EmbeddingWidget.setLayoutDirection" class="function">setLayoutDirection</dd>
                <dd id="EmbeddingWidget.setLocale" class="function">setLocale</dd>
                <dd id="EmbeddingWidget.setMask" class="function">setMask</dd>
                <dd id="EmbeddingWidget.setMaximumHeight" class="function">setMaximumHeight</dd>
                <dd id="EmbeddingWidget.setMaximumSize" class="function">setMaximumSize</dd>
                <dd id="EmbeddingWidget.setMaximumWidth" class="function">setMaximumWidth</dd>
                <dd id="EmbeddingWidget.setMinimumHeight" class="function">setMinimumHeight</dd>
                <dd id="EmbeddingWidget.setMinimumSize" class="function">setMinimumSize</dd>
                <dd id="EmbeddingWidget.setMinimumWidth" class="function">setMinimumWidth</dd>
                <dd id="EmbeddingWidget.setMouseTracking" class="function">setMouseTracking</dd>
                <dd id="EmbeddingWidget.setPalette" class="function">setPalette</dd>
                <dd id="EmbeddingWidget.setParent" class="function">setParent</dd>
                <dd id="EmbeddingWidget.setShortcutAutoRepeat" class="function">setShortcutAutoRepeat</dd>
                <dd id="EmbeddingWidget.setShortcutEnabled" class="function">setShortcutEnabled</dd>
                <dd id="EmbeddingWidget.setSizeIncrement" class="function">setSizeIncrement</dd>
                <dd id="EmbeddingWidget.setSizePolicy" class="function">setSizePolicy</dd>
                <dd id="EmbeddingWidget.setStatusTip" class="function">setStatusTip</dd>
                <dd id="EmbeddingWidget.setStyle" class="function">setStyle</dd>
                <dd id="EmbeddingWidget.setStyleSheet" class="function">setStyleSheet</dd>
                <dd id="EmbeddingWidget.setTabOrder" class="function">setTabOrder</dd>
                <dd id="EmbeddingWidget.setTabletTracking" class="function">setTabletTracking</dd>
                <dd id="EmbeddingWidget.setToolTip" class="function">setToolTip</dd>
                <dd id="EmbeddingWidget.setToolTipDuration" class="function">setToolTipDuration</dd>
                <dd id="EmbeddingWidget.setUpdatesEnabled" class="function">setUpdatesEnabled</dd>
                <dd id="EmbeddingWidget.setVisible" class="function">setVisible</dd>
                <dd id="EmbeddingWidget.setWhatsThis" class="function">setWhatsThis</dd>
                <dd id="EmbeddingWidget.setWindowFilePath" class="function">setWindowFilePath</dd>
                <dd id="EmbeddingWidget.setWindowFlag" class="function">setWindowFlag</dd>
                <dd id="EmbeddingWidget.setWindowFlags" class="function">setWindowFlags</dd>
                <dd id="EmbeddingWidget.setWindowIcon" class="function">setWindowIcon</dd>
                <dd id="EmbeddingWidget.setWindowIconText" class="function">setWindowIconText</dd>
                <dd id="EmbeddingWidget.setWindowModality" class="function">setWindowModality</dd>
                <dd id="EmbeddingWidget.setWindowModified" class="function">setWindowModified</dd>
                <dd id="EmbeddingWidget.setWindowOpacity" class="function">setWindowOpacity</dd>
                <dd id="EmbeddingWidget.setWindowRole" class="function">setWindowRole</dd>
                <dd id="EmbeddingWidget.setWindowState" class="function">setWindowState</dd>
                <dd id="EmbeddingWidget.setWindowTitle" class="function">setWindowTitle</dd>
                <dd id="EmbeddingWidget.sharedPainter" class="function">sharedPainter</dd>
                <dd id="EmbeddingWidget.show" class="function">show</dd>
                <dd id="EmbeddingWidget.showEvent" class="function">showEvent</dd>
                <dd id="EmbeddingWidget.showFullScreen" class="function">showFullScreen</dd>
                <dd id="EmbeddingWidget.showMaximized" class="function">showMaximized</dd>
                <dd id="EmbeddingWidget.showMinimized" class="function">showMinimized</dd>
                <dd id="EmbeddingWidget.showNormal" class="function">showNormal</dd>
                <dd id="EmbeddingWidget.size" class="function">size</dd>
                <dd id="EmbeddingWidget.sizeHint" class="function">sizeHint</dd>
                <dd id="EmbeddingWidget.sizeIncrement" class="function">sizeIncrement</dd>
                <dd id="EmbeddingWidget.sizePolicy" class="function">sizePolicy</dd>
                <dd id="EmbeddingWidget.stackUnder" class="function">stackUnder</dd>
                <dd id="EmbeddingWidget.statusTip" class="function">statusTip</dd>
                <dd id="EmbeddingWidget.style" class="function">style</dd>
                <dd id="EmbeddingWidget.styleSheet" class="function">styleSheet</dd>
                <dd id="EmbeddingWidget.tabletEvent" class="function">tabletEvent</dd>
                <dd id="EmbeddingWidget.testAttribute" class="function">testAttribute</dd>
                <dd id="EmbeddingWidget.toolTip" class="function">toolTip</dd>
                <dd id="EmbeddingWidget.toolTipDuration" class="function">toolTipDuration</dd>
                <dd id="EmbeddingWidget.underMouse" class="function">underMouse</dd>
                <dd id="EmbeddingWidget.ungrabGesture" class="function">ungrabGesture</dd>
                <dd id="EmbeddingWidget.unsetCursor" class="function">unsetCursor</dd>
                <dd id="EmbeddingWidget.unsetLayoutDirection" class="function">unsetLayoutDirection</dd>
                <dd id="EmbeddingWidget.unsetLocale" class="function">unsetLocale</dd>
                <dd id="EmbeddingWidget.update" class="function">update</dd>
                <dd id="EmbeddingWidget.updateGeometry" class="function">updateGeometry</dd>
                <dd id="EmbeddingWidget.updateMicroFocus" class="function">updateMicroFocus</dd>
                <dd id="EmbeddingWidget.updatesEnabled" class="function">updatesEnabled</dd>
                <dd id="EmbeddingWidget.visibleRegion" class="function">visibleRegion</dd>
                <dd id="EmbeddingWidget.whatsThis" class="function">whatsThis</dd>
                <dd id="EmbeddingWidget.wheelEvent" class="function">wheelEvent</dd>
                <dd id="EmbeddingWidget.width" class="function">width</dd>
                <dd id="EmbeddingWidget.winId" class="function">winId</dd>
                <dd id="EmbeddingWidget.window" class="function">window</dd>
                <dd id="EmbeddingWidget.windowFilePath" class="function">windowFilePath</dd>
                <dd id="EmbeddingWidget.windowFlags" class="function">windowFlags</dd>
                <dd id="EmbeddingWidget.windowHandle" class="function">windowHandle</dd>
                <dd id="EmbeddingWidget.windowIcon" class="function">windowIcon</dd>
                <dd id="EmbeddingWidget.windowIconText" class="function">windowIconText</dd>
                <dd id="EmbeddingWidget.windowModality" class="function">windowModality</dd>
                <dd id="EmbeddingWidget.windowOpacity" class="function">windowOpacity</dd>
                <dd id="EmbeddingWidget.windowRole" class="function">windowRole</dd>
                <dd id="EmbeddingWidget.windowState" class="function">windowState</dd>
                <dd id="EmbeddingWidget.windowTitle" class="function">windowTitle</dd>
                <dd id="EmbeddingWidget.windowType" class="function">windowType</dd>
                <dd id="EmbeddingWidget.x" class="function">x</dd>
                <dd id="EmbeddingWidget.y" class="function">y</dd>
                <dd id="EmbeddingWidget.DrawChildren" class="variable">DrawChildren</dd>
                <dd id="EmbeddingWidget.DrawWindowBackground" class="variable">DrawWindowBackground</dd>
                <dd id="EmbeddingWidget.IgnoreMask" class="variable">IgnoreMask</dd>
                <dd id="EmbeddingWidget.windowIconTextChanged" class="function">windowIconTextChanged</dd>
                <dd id="EmbeddingWidget.windowIconChanged" class="function">windowIconChanged</dd>
                <dd id="EmbeddingWidget.windowTitleChanged" class="function">windowTitleChanged</dd>
                <dd id="EmbeddingWidget.customContextMenuRequested" class="function">customContextMenuRequested</dd>

            </div>
            <div><dt>PyQt5.QtCore.QObject</dt>
                                <dd id="EmbeddingWidget.blockSignals" class="function">blockSignals</dd>
                <dd id="EmbeddingWidget.childEvent" class="function">childEvent</dd>
                <dd id="EmbeddingWidget.children" class="function">children</dd>
                <dd id="EmbeddingWidget.connectNotify" class="function">connectNotify</dd>
                <dd id="EmbeddingWidget.customEvent" class="function">customEvent</dd>
                <dd id="EmbeddingWidget.deleteLater" class="function">deleteLater</dd>
                <dd id="EmbeddingWidget.disconnect" class="function">disconnect</dd>
                <dd id="EmbeddingWidget.disconnectNotify" class="function">disconnectNotify</dd>
                <dd id="EmbeddingWidget.dumpObjectInfo" class="function">dumpObjectInfo</dd>
                <dd id="EmbeddingWidget.dumpObjectTree" class="function">dumpObjectTree</dd>
                <dd id="EmbeddingWidget.dynamicPropertyNames" class="function">dynamicPropertyNames</dd>
                <dd id="EmbeddingWidget.eventFilter" class="function">eventFilter</dd>
                <dd id="EmbeddingWidget.findChild" class="function">findChild</dd>
                <dd id="EmbeddingWidget.findChildren" class="function">findChildren</dd>
                <dd id="EmbeddingWidget.inherits" class="function">inherits</dd>
                <dd id="EmbeddingWidget.installEventFilter" class="function">installEventFilter</dd>
                <dd id="EmbeddingWidget.isSignalConnected" class="function">isSignalConnected</dd>
                <dd id="EmbeddingWidget.isWidgetType" class="function">isWidgetType</dd>
                <dd id="EmbeddingWidget.isWindowType" class="function">isWindowType</dd>
                <dd id="EmbeddingWidget.killTimer" class="function">killTimer</dd>
                <dd id="EmbeddingWidget.metaObject" class="function">metaObject</dd>
                <dd id="EmbeddingWidget.moveToThread" class="function">moveToThread</dd>
                <dd id="EmbeddingWidget.objectName" class="function">objectName</dd>
                <dd id="EmbeddingWidget.parent" class="function">parent</dd>
                <dd id="EmbeddingWidget.property" class="function">property</dd>
                <dd id="EmbeddingWidget.pyqtConfigure" class="function">pyqtConfigure</dd>
                <dd id="EmbeddingWidget.receivers" class="function">receivers</dd>
                <dd id="EmbeddingWidget.removeEventFilter" class="function">removeEventFilter</dd>
                <dd id="EmbeddingWidget.sender" class="function">sender</dd>
                <dd id="EmbeddingWidget.senderSignalIndex" class="function">senderSignalIndex</dd>
                <dd id="EmbeddingWidget.setObjectName" class="function">setObjectName</dd>
                <dd id="EmbeddingWidget.setProperty" class="function">setProperty</dd>
                <dd id="EmbeddingWidget.signalsBlocked" class="function">signalsBlocked</dd>
                <dd id="EmbeddingWidget.startTimer" class="function">startTimer</dd>
                <dd id="EmbeddingWidget.thread" class="function">thread</dd>
                <dd id="EmbeddingWidget.timerEvent" class="function">timerEvent</dd>
                <dd id="EmbeddingWidget.tr" class="function">tr</dd>
                <dd id="EmbeddingWidget.staticMetaObject" class="variable">staticMetaObject</dd>
                <dd id="EmbeddingWidget.objectNameChanged" class="function">objectNameChanged</dd>
                <dd id="EmbeddingWidget.destroyed" class="function">destroyed</dd>

            </div>
            <div><dt>PyQt5.QtGui.QPaintDevice</dt>
                                <dd id="EmbeddingWidget.PaintDeviceMetric" class="class">PaintDeviceMetric</dd>
                <dd id="EmbeddingWidget.colorCount" class="function">colorCount</dd>
                <dd id="EmbeddingWidget.depth" class="function">depth</dd>
                <dd id="EmbeddingWidget.devicePixelRatio" class="function">devicePixelRatio</dd>
                <dd id="EmbeddingWidget.devicePixelRatioF" class="function">devicePixelRatioF</dd>
                <dd id="EmbeddingWidget.devicePixelRatioFScale" class="function">devicePixelRatioFScale</dd>
                <dd id="EmbeddingWidget.heightMM" class="function">heightMM</dd>
                <dd id="EmbeddingWidget.logicalDpiX" class="function">logicalDpiX</dd>
                <dd id="EmbeddingWidget.logicalDpiY" class="function">logicalDpiY</dd>
                <dd id="EmbeddingWidget.paintingActive" class="function">paintingActive</dd>
                <dd id="EmbeddingWidget.physicalDpiX" class="function">physicalDpiX</dd>
                <dd id="EmbeddingWidget.physicalDpiY" class="function">physicalDpiY</dd>
                <dd id="EmbeddingWidget.widthMM" class="function">widthMM</dd>
                <dd id="EmbeddingWidget.PdmDepth" class="variable">PdmDepth</dd>
                <dd id="EmbeddingWidget.PdmDevicePixelRatio" class="variable">PdmDevicePixelRatio</dd>
                <dd id="EmbeddingWidget.PdmDevicePixelRatioScaled" class="variable">PdmDevicePixelRatioScaled</dd>
                <dd id="EmbeddingWidget.PdmDpiX" class="variable">PdmDpiX</dd>
                <dd id="EmbeddingWidget.PdmDpiY" class="variable">PdmDpiY</dd>
                <dd id="EmbeddingWidget.PdmHeight" class="variable">PdmHeight</dd>
                <dd id="EmbeddingWidget.PdmHeightMM" class="variable">PdmHeightMM</dd>
                <dd id="EmbeddingWidget.PdmNumColors" class="variable">PdmNumColors</dd>
                <dd id="EmbeddingWidget.PdmPhysicalDpiX" class="variable">PdmPhysicalDpiX</dd>
                <dd id="EmbeddingWidget.PdmPhysicalDpiY" class="variable">PdmPhysicalDpiY</dd>
                <dd id="EmbeddingWidget.PdmWidth" class="variable">PdmWidth</dd>
                <dd id="EmbeddingWidget.PdmWidthMM" class="variable">PdmWidthMM</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SegmentNDWidget">
                            <input id="SegmentNDWidget-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SegmentNDWidget</span><wbr>(<span class="base"><a href="#_WidgetBase">_WidgetBase</a></span>):

                <label class="view-source-button" for="SegmentNDWidget-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SegmentNDWidget"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SegmentNDWidget-1138"><a href="#SegmentNDWidget-1138"><span class="linenos">1138</span></a><span class="k">class</span> <span class="nc">SegmentNDWidget</span><span class="p">(</span><span class="n">_WidgetBase</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1139"><a href="#SegmentNDWidget-1139"><span class="linenos">1139</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">tracking</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1140"><a href="#SegmentNDWidget-1140"><span class="linenos">1140</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1141"><a href="#SegmentNDWidget-1141"><span class="linenos">1141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span> <span class="o">=</span> <span class="n">viewer</span>
</span><span id="SegmentNDWidget-1142"><a href="#SegmentNDWidget-1142"><span class="linenos">1142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="o">=</span> <span class="n">tracking</span>
</span><span id="SegmentNDWidget-1143"><a href="#SegmentNDWidget-1143"><span class="linenos">1143</span></a>
</span><span id="SegmentNDWidget-1144"><a href="#SegmentNDWidget-1144"><span class="linenos">1144</span></a>        <span class="c1"># Add the settings.</span>
</span><span id="SegmentNDWidget-1145"><a href="#SegmentNDWidget-1145"><span class="linenos">1145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_settings</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1146"><a href="#SegmentNDWidget-1146"><span class="linenos">1146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1147"><a href="#SegmentNDWidget-1147"><span class="linenos">1147</span></a>
</span><span id="SegmentNDWidget-1148"><a href="#SegmentNDWidget-1148"><span class="linenos">1148</span></a>        <span class="c1"># Add the run button.</span>
</span><span id="SegmentNDWidget-1149"><a href="#SegmentNDWidget-1149"><span class="linenos">1149</span></a>        <span class="n">button_title</span> <span class="o">=</span> <span class="s2">&quot;Segment All Frames [Shift-S]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="k">else</span> <span class="s2">&quot;Segment All Slices [Shift-S]&quot;</span>
</span><span id="SegmentNDWidget-1150"><a href="#SegmentNDWidget-1150"><span class="linenos">1150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="n">button_title</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1151"><a href="#SegmentNDWidget-1151"><span class="linenos">1151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1152"><a href="#SegmentNDWidget-1152"><span class="linenos">1152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1153"><a href="#SegmentNDWidget-1153"><span class="linenos">1153</span></a>
</span><span id="SegmentNDWidget-1154"><a href="#SegmentNDWidget-1154"><span class="linenos">1154</span></a>    <span class="k">def</span> <span class="nf">_create_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1155"><a href="#SegmentNDWidget-1155"><span class="linenos">1155</span></a>        <span class="n">setting_values</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1156"><a href="#SegmentNDWidget-1156"><span class="linenos">1156</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;settings&quot;</span><span class="p">))</span>
</span><span id="SegmentNDWidget-1157"><a href="#SegmentNDWidget-1157"><span class="linenos">1157</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="SegmentNDWidget-1158"><a href="#SegmentNDWidget-1158"><span class="linenos">1158</span></a>
</span><span id="SegmentNDWidget-1159"><a href="#SegmentNDWidget-1159"><span class="linenos">1159</span></a>        <span class="c1"># Create the UI for the projection modes.</span>
</span><span id="SegmentNDWidget-1160"><a href="#SegmentNDWidget-1160"><span class="linenos">1160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projection</span> <span class="o">=</span> <span class="s2">&quot;points&quot;</span>
</span><span id="SegmentNDWidget-1161"><a href="#SegmentNDWidget-1161"><span class="linenos">1161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projection_dropdown</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_choice_param</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1162"><a href="#SegmentNDWidget-1162"><span class="linenos">1162</span></a>            <span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span> <span class="n">PROJECTION_MODES</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;projection_dropdown&quot;</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1163"><a href="#SegmentNDWidget-1163"><span class="linenos">1163</span></a>            <span class="p">)</span>
</span><span id="SegmentNDWidget-1164"><a href="#SegmentNDWidget-1164"><span class="linenos">1164</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1165"><a href="#SegmentNDWidget-1165"><span class="linenos">1165</span></a>
</span><span id="SegmentNDWidget-1166"><a href="#SegmentNDWidget-1166"><span class="linenos">1166</span></a>        <span class="c1"># Create the UI element for the IOU threshold.</span>
</span><span id="SegmentNDWidget-1167"><a href="#SegmentNDWidget-1167"><span class="linenos">1167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="SegmentNDWidget-1168"><a href="#SegmentNDWidget-1168"><span class="linenos">1168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1169"><a href="#SegmentNDWidget-1169"><span class="linenos">1169</span></a>            <span class="s2">&quot;iou_threshold&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;iou_threshold&quot;</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1170"><a href="#SegmentNDWidget-1170"><span class="linenos">1170</span></a>            <span class="p">)</span>
</span><span id="SegmentNDWidget-1171"><a href="#SegmentNDWidget-1171"><span class="linenos">1171</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1172"><a href="#SegmentNDWidget-1172"><span class="linenos">1172</span></a>
</span><span id="SegmentNDWidget-1173"><a href="#SegmentNDWidget-1173"><span class="linenos">1173</span></a>        <span class="c1"># Create the UI element for the box extension.</span>
</span><span id="SegmentNDWidget-1174"><a href="#SegmentNDWidget-1174"><span class="linenos">1174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span> <span class="o">=</span> <span class="mf">0.05</span>
</span><span id="SegmentNDWidget-1175"><a href="#SegmentNDWidget-1175"><span class="linenos">1175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_extension_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1176"><a href="#SegmentNDWidget-1176"><span class="linenos">1176</span></a>            <span class="s2">&quot;box_extension&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;box_extension&quot;</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1177"><a href="#SegmentNDWidget-1177"><span class="linenos">1177</span></a>            <span class="p">)</span>
</span><span id="SegmentNDWidget-1178"><a href="#SegmentNDWidget-1178"><span class="linenos">1178</span></a>        <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1179"><a href="#SegmentNDWidget-1179"><span class="linenos">1179</span></a>
</span><span id="SegmentNDWidget-1180"><a href="#SegmentNDWidget-1180"><span class="linenos">1180</span></a>        <span class="c1"># Create the UI element for the motion smoothing (if we have the tracking widget).</span>
</span><span id="SegmentNDWidget-1181"><a href="#SegmentNDWidget-1181"><span class="linenos">1181</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span><span class="p">:</span>
</span><span id="SegmentNDWidget-1182"><a href="#SegmentNDWidget-1182"><span class="linenos">1182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="SegmentNDWidget-1183"><a href="#SegmentNDWidget-1183"><span class="linenos">1183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1184"><a href="#SegmentNDWidget-1184"><span class="linenos">1184</span></a>                <span class="s2">&quot;motion_smoothing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing</span><span class="p">,</span> <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;segmentnd&quot;</span><span class="p">,</span> <span class="s2">&quot;motion_smoothing&quot;</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1185"><a href="#SegmentNDWidget-1185"><span class="linenos">1185</span></a>                <span class="p">)</span>
</span><span id="SegmentNDWidget-1186"><a href="#SegmentNDWidget-1186"><span class="linenos">1186</span></a>            <span class="n">setting_values</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1187"><a href="#SegmentNDWidget-1187"><span class="linenos">1187</span></a>
</span><span id="SegmentNDWidget-1188"><a href="#SegmentNDWidget-1188"><span class="linenos">1188</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">_make_collapsible</span><span class="p">(</span><span class="n">setting_values</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Segmentation Settings&quot;</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1189"><a href="#SegmentNDWidget-1189"><span class="linenos">1189</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="SegmentNDWidget-1190"><a href="#SegmentNDWidget-1190"><span class="linenos">1190</span></a>
</span><span id="SegmentNDWidget-1191"><a href="#SegmentNDWidget-1191"><span class="linenos">1191</span></a>    <span class="k">def</span> <span class="nf">_run_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1192"><a href="#SegmentNDWidget-1192"><span class="linenos">1192</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1193"><a href="#SegmentNDWidget-1193"><span class="linenos">1193</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1194"><a href="#SegmentNDWidget-1194"><span class="linenos">1194</span></a>
</span><span id="SegmentNDWidget-1195"><a href="#SegmentNDWidget-1195"><span class="linenos">1195</span></a>        <span class="nd">@thread_worker</span>
</span><span id="SegmentNDWidget-1196"><a href="#SegmentNDWidget-1196"><span class="linenos">1196</span></a>        <span class="k">def</span> <span class="nf">tracking_impl</span><span class="p">():</span>
</span><span id="SegmentNDWidget-1197"><a href="#SegmentNDWidget-1197"><span class="linenos">1197</span></a>            <span class="n">shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span>
</span><span id="SegmentNDWidget-1198"><a href="#SegmentNDWidget-1198"><span class="linenos">1198</span></a>
</span><span id="SegmentNDWidget-1199"><a href="#SegmentNDWidget-1199"><span class="linenos">1199</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SegmentNDWidget-1200"><a href="#SegmentNDWidget-1200"><span class="linenos">1200</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Track object&quot;</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1201"><a href="#SegmentNDWidget-1201"><span class="linenos">1201</span></a>
</span><span id="SegmentNDWidget-1202"><a href="#SegmentNDWidget-1202"><span class="linenos">1202</span></a>            <span class="c1"># Step 1: Segment all slices with prompts.</span>
</span><span id="SegmentNDWidget-1203"><a href="#SegmentNDWidget-1203"><span class="linenos">1203</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">stop_upper</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">segment_slices_with_prompts</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1204"><a href="#SegmentNDWidget-1204"><span class="linenos">1204</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span>
</span><span id="SegmentNDWidget-1205"><a href="#SegmentNDWidget-1205"><span class="linenos">1205</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">track_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1206"><a href="#SegmentNDWidget-1206"><span class="linenos">1206</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="SegmentNDWidget-1207"><a href="#SegmentNDWidget-1207"><span class="linenos">1207</span></a>            <span class="p">)</span>
</span><span id="SegmentNDWidget-1208"><a href="#SegmentNDWidget-1208"><span class="linenos">1208</span></a>
</span><span id="SegmentNDWidget-1209"><a href="#SegmentNDWidget-1209"><span class="linenos">1209</span></a>            <span class="c1"># Step 2: Track the object starting from the lowest annotated slice.</span>
</span><span id="SegmentNDWidget-1210"><a href="#SegmentNDWidget-1210"><span class="linenos">1210</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">has_division</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">track_from_prompts</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1211"><a href="#SegmentNDWidget-1211"><span class="linenos">1211</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span> <span class="n">seg</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1212"><a href="#SegmentNDWidget-1212"><span class="linenos">1212</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">stop_upper</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1213"><a href="#SegmentNDWidget-1213"><span class="linenos">1213</span></a>                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1214"><a href="#SegmentNDWidget-1214"><span class="linenos">1214</span></a>                <span class="n">motion_smoothing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">motion_smoothing</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1215"><a href="#SegmentNDWidget-1215"><span class="linenos">1215</span></a>                <span class="n">box_extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1216"><a href="#SegmentNDWidget-1216"><span class="linenos">1216</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="SegmentNDWidget-1217"><a href="#SegmentNDWidget-1217"><span class="linenos">1217</span></a>            <span class="p">)</span>
</span><span id="SegmentNDWidget-1218"><a href="#SegmentNDWidget-1218"><span class="linenos">1218</span></a>
</span><span id="SegmentNDWidget-1219"><a href="#SegmentNDWidget-1219"><span class="linenos">1219</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1220"><a href="#SegmentNDWidget-1220"><span class="linenos">1220</span></a>            <span class="k">return</span> <span class="n">seg</span><span class="p">,</span> <span class="n">has_division</span>
</span><span id="SegmentNDWidget-1221"><a href="#SegmentNDWidget-1221"><span class="linenos">1221</span></a>
</span><span id="SegmentNDWidget-1222"><a href="#SegmentNDWidget-1222"><span class="linenos">1222</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">ret_val</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1223"><a href="#SegmentNDWidget-1223"><span class="linenos">1223</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">has_division</span> <span class="o">=</span> <span class="n">ret_val</span>
</span><span id="SegmentNDWidget-1224"><a href="#SegmentNDWidget-1224"><span class="linenos">1224</span></a>            <span class="c1"># If a division has occurred and it&#39;s the first time it occurred for this track</span>
</span><span id="SegmentNDWidget-1225"><a href="#SegmentNDWidget-1225"><span class="linenos">1225</span></a>            <span class="c1"># then we need to create the two daughter tracks and update the lineage.</span>
</span><span id="SegmentNDWidget-1226"><a href="#SegmentNDWidget-1226"><span class="linenos">1226</span></a>            <span class="k">if</span> <span class="n">has_division</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">lineage</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1227"><a href="#SegmentNDWidget-1227"><span class="linenos">1227</span></a>                <span class="n">_update_lineage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1228"><a href="#SegmentNDWidget-1228"><span class="linenos">1228</span></a>
</span><span id="SegmentNDWidget-1229"><a href="#SegmentNDWidget-1229"><span class="linenos">1229</span></a>            <span class="c1"># Clear the old track mask.</span>
</span><span id="SegmentNDWidget-1230"><a href="#SegmentNDWidget-1230"><span class="linenos">1230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
</span><span id="SegmentNDWidget-1231"><a href="#SegmentNDWidget-1231"><span class="linenos">1231</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span>
</span><span id="SegmentNDWidget-1232"><a href="#SegmentNDWidget-1232"><span class="linenos">1232</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SegmentNDWidget-1233"><a href="#SegmentNDWidget-1233"><span class="linenos">1233</span></a>            <span class="c1"># Set the new object mask.</span>
</span><span id="SegmentNDWidget-1234"><a href="#SegmentNDWidget-1234"><span class="linenos">1234</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">seg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_track_id</span>
</span><span id="SegmentNDWidget-1235"><a href="#SegmentNDWidget-1235"><span class="linenos">1235</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1236"><a href="#SegmentNDWidget-1236"><span class="linenos">1236</span></a>
</span><span id="SegmentNDWidget-1237"><a href="#SegmentNDWidget-1237"><span class="linenos">1237</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">tracking_impl</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1238"><a href="#SegmentNDWidget-1238"><span class="linenos">1238</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1239"><a href="#SegmentNDWidget-1239"><span class="linenos">1239</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1240"><a href="#SegmentNDWidget-1240"><span class="linenos">1240</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="SegmentNDWidget-1241"><a href="#SegmentNDWidget-1241"><span class="linenos">1241</span></a>
</span><span id="SegmentNDWidget-1242"><a href="#SegmentNDWidget-1242"><span class="linenos">1242</span></a>    <span class="k">def</span> <span class="nf">_run_volumetric_segmentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1243"><a href="#SegmentNDWidget-1243"><span class="linenos">1243</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1244"><a href="#SegmentNDWidget-1244"><span class="linenos">1244</span></a>
</span><span id="SegmentNDWidget-1245"><a href="#SegmentNDWidget-1245"><span class="linenos">1245</span></a>        <span class="nd">@thread_worker</span>
</span><span id="SegmentNDWidget-1246"><a href="#SegmentNDWidget-1246"><span class="linenos">1246</span></a>        <span class="k">def</span> <span class="nf">volumetric_segmentation_impl</span><span class="p">():</span>
</span><span id="SegmentNDWidget-1247"><a href="#SegmentNDWidget-1247"><span class="linenos">1247</span></a>            <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1248"><a href="#SegmentNDWidget-1248"><span class="linenos">1248</span></a>            <span class="n">shape</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">image_shape</span>
</span><span id="SegmentNDWidget-1249"><a href="#SegmentNDWidget-1249"><span class="linenos">1249</span></a>
</span><span id="SegmentNDWidget-1250"><a href="#SegmentNDWidget-1250"><span class="linenos">1250</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SegmentNDWidget-1251"><a href="#SegmentNDWidget-1251"><span class="linenos">1251</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;Segment object&quot;</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1252"><a href="#SegmentNDWidget-1252"><span class="linenos">1252</span></a>
</span><span id="SegmentNDWidget-1253"><a href="#SegmentNDWidget-1253"><span class="linenos">1253</span></a>            <span class="c1"># Step 1: Segment all slices with prompts.</span>
</span><span id="SegmentNDWidget-1254"><a href="#SegmentNDWidget-1254"><span class="linenos">1254</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">stop_lower</span><span class="p">,</span> <span class="n">stop_upper</span> <span class="o">=</span> <span class="n">vutil</span><span class="o">.</span><span class="n">segment_slices_with_prompts</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1255"><a href="#SegmentNDWidget-1255"><span class="linenos">1255</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;point_prompts&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span>
</span><span id="SegmentNDWidget-1256"><a href="#SegmentNDWidget-1256"><span class="linenos">1256</span></a>                <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1257"><a href="#SegmentNDWidget-1257"><span class="linenos">1257</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="SegmentNDWidget-1258"><a href="#SegmentNDWidget-1258"><span class="linenos">1258</span></a>            <span class="p">)</span>
</span><span id="SegmentNDWidget-1259"><a href="#SegmentNDWidget-1259"><span class="linenos">1259</span></a>
</span><span id="SegmentNDWidget-1260"><a href="#SegmentNDWidget-1260"><span class="linenos">1260</span></a>            <span class="c1"># Step 2: Segment the rest of the volume based on projecting prompts.</span>
</span><span id="SegmentNDWidget-1261"><a href="#SegmentNDWidget-1261"><span class="linenos">1261</span></a>            <span class="n">seg</span><span class="p">,</span> <span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">segment_mask_in_volume</span><span class="p">(</span>
</span><span id="SegmentNDWidget-1262"><a href="#SegmentNDWidget-1262"><span class="linenos">1262</span></a>                <span class="n">seg</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">predictor</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">image_embeddings</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1263"><a href="#SegmentNDWidget-1263"><span class="linenos">1263</span></a>                <span class="n">stop_lower</span><span class="p">,</span> <span class="n">stop_upper</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1264"><a href="#SegmentNDWidget-1264"><span class="linenos">1264</span></a>                <span class="n">iou_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1265"><a href="#SegmentNDWidget-1265"><span class="linenos">1265</span></a>                <span class="n">box_extension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">box_extension</span><span class="p">,</span>
</span><span id="SegmentNDWidget-1266"><a href="#SegmentNDWidget-1266"><span class="linenos">1266</span></a>                <span class="n">update_progress</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="SegmentNDWidget-1267"><a href="#SegmentNDWidget-1267"><span class="linenos">1267</span></a>            <span class="p">)</span>
</span><span id="SegmentNDWidget-1268"><a href="#SegmentNDWidget-1268"><span class="linenos">1268</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1269"><a href="#SegmentNDWidget-1269"><span class="linenos">1269</span></a>
</span><span id="SegmentNDWidget-1270"><a href="#SegmentNDWidget-1270"><span class="linenos">1270</span></a>            <span class="n">state</span><span class="o">.</span><span class="n">z_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1271"><a href="#SegmentNDWidget-1271"><span class="linenos">1271</span></a>            <span class="k">return</span> <span class="n">seg</span>
</span><span id="SegmentNDWidget-1272"><a href="#SegmentNDWidget-1272"><span class="linenos">1272</span></a>
</span><span id="SegmentNDWidget-1273"><a href="#SegmentNDWidget-1273"><span class="linenos">1273</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">seg</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1274"><a href="#SegmentNDWidget-1274"><span class="linenos">1274</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="SegmentNDWidget-1275"><a href="#SegmentNDWidget-1275"><span class="linenos">1275</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;current_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1276"><a href="#SegmentNDWidget-1276"><span class="linenos">1276</span></a>
</span><span id="SegmentNDWidget-1277"><a href="#SegmentNDWidget-1277"><span class="linenos">1277</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">volumetric_segmentation_impl</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1278"><a href="#SegmentNDWidget-1278"><span class="linenos">1278</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="SegmentNDWidget-1279"><a href="#SegmentNDWidget-1279"><span class="linenos">1279</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1280"><a href="#SegmentNDWidget-1280"><span class="linenos">1280</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="SegmentNDWidget-1281"><a href="#SegmentNDWidget-1281"><span class="linenos">1281</span></a>
</span><span id="SegmentNDWidget-1282"><a href="#SegmentNDWidget-1282"><span class="linenos">1282</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1283"><a href="#SegmentNDWidget-1283"><span class="linenos">1283</span></a>        <span class="k">if</span> <span class="n">_validate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1284"><a href="#SegmentNDWidget-1284"><span class="linenos">1284</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="SegmentNDWidget-1285"><a href="#SegmentNDWidget-1285"><span class="linenos">1285</span></a>        <span class="k">if</span> <span class="n">_validate_prompts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">):</span>
</span><span id="SegmentNDWidget-1286"><a href="#SegmentNDWidget-1286"><span class="linenos">1286</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="SegmentNDWidget-1287"><a href="#SegmentNDWidget-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span><span class="p">:</span>
</span><span id="SegmentNDWidget-1288"><a href="#SegmentNDWidget-1288"><span class="linenos">1288</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_tracking</span><span class="p">()</span>
</span><span id="SegmentNDWidget-1289"><a href="#SegmentNDWidget-1289"><span class="linenos">1289</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SegmentNDWidget-1290"><a href="#SegmentNDWidget-1290"><span class="linenos">1290</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_volumetric_segmentation</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>QWidget(parent: typing.Optional[QWidget] = None, flags: Union[Qt.WindowFlags, Qt.WindowType] = Qt.WindowFlags())</p>
</div>


                            <div id="SegmentNDWidget.__init__" class="classattr">
                                        <input id="SegmentNDWidget.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SegmentNDWidget</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">viewer</span>, </span><span class="param"><span class="n">tracking</span>, </span><span class="param"><span class="n">parent</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="SegmentNDWidget.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SegmentNDWidget.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SegmentNDWidget.__init__-1139"><a href="#SegmentNDWidget.__init__-1139"><span class="linenos">1139</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">tracking</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="SegmentNDWidget.__init__-1140"><a href="#SegmentNDWidget.__init__-1140"><span class="linenos">1140</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
</span><span id="SegmentNDWidget.__init__-1141"><a href="#SegmentNDWidget.__init__-1141"><span class="linenos">1141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span> <span class="o">=</span> <span class="n">viewer</span>
</span><span id="SegmentNDWidget.__init__-1142"><a href="#SegmentNDWidget.__init__-1142"><span class="linenos">1142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="o">=</span> <span class="n">tracking</span>
</span><span id="SegmentNDWidget.__init__-1143"><a href="#SegmentNDWidget.__init__-1143"><span class="linenos">1143</span></a>
</span><span id="SegmentNDWidget.__init__-1144"><a href="#SegmentNDWidget.__init__-1144"><span class="linenos">1144</span></a>        <span class="c1"># Add the settings.</span>
</span><span id="SegmentNDWidget.__init__-1145"><a href="#SegmentNDWidget.__init__-1145"><span class="linenos">1145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_settings</span><span class="p">()</span>
</span><span id="SegmentNDWidget.__init__-1146"><a href="#SegmentNDWidget.__init__-1146"><span class="linenos">1146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
</span><span id="SegmentNDWidget.__init__-1147"><a href="#SegmentNDWidget.__init__-1147"><span class="linenos">1147</span></a>
</span><span id="SegmentNDWidget.__init__-1148"><a href="#SegmentNDWidget.__init__-1148"><span class="linenos">1148</span></a>        <span class="c1"># Add the run button.</span>
</span><span id="SegmentNDWidget.__init__-1149"><a href="#SegmentNDWidget.__init__-1149"><span class="linenos">1149</span></a>        <span class="n">button_title</span> <span class="o">=</span> <span class="s2">&quot;Segment All Frames [Shift-S]&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracking</span> <span class="k">else</span> <span class="s2">&quot;Segment All Slices [Shift-S]&quot;</span>
</span><span id="SegmentNDWidget.__init__-1150"><a href="#SegmentNDWidget.__init__-1150"><span class="linenos">1150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="n">button_title</span><span class="p">)</span>
</span><span id="SegmentNDWidget.__init__-1151"><a href="#SegmentNDWidget.__init__-1151"><span class="linenos">1151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="SegmentNDWidget.__init__-1152"><a href="#SegmentNDWidget.__init__-1152"><span class="linenos">1152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="SegmentNDWidget.tracking" class="classattr">
                                <div class="attr variable">
            <span class="name">tracking</span>

        
    </div>
    <a class="headerlink" href="#SegmentNDWidget.tracking"></a>
    
    

                            </div>
                            <div id="SegmentNDWidget.settings" class="classattr">
                                <div class="attr variable">
            <span class="name">settings</span>

        
    </div>
    <a class="headerlink" href="#SegmentNDWidget.settings"></a>
    
    

                            </div>
                            <div id="SegmentNDWidget.run_button" class="classattr">
                                <div class="attr variable">
            <span class="name">run_button</span>

        
    </div>
    <a class="headerlink" href="#SegmentNDWidget.run_button"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>PyQt5.QtWidgets.QWidget</dt>
                                <dd id="SegmentNDWidget.RenderFlag" class="class">RenderFlag</dd>
                <dd id="SegmentNDWidget.RenderFlags" class="class">RenderFlags</dd>
                <dd id="SegmentNDWidget.acceptDrops" class="function">acceptDrops</dd>
                <dd id="SegmentNDWidget.accessibleDescription" class="function">accessibleDescription</dd>
                <dd id="SegmentNDWidget.accessibleName" class="function">accessibleName</dd>
                <dd id="SegmentNDWidget.actionEvent" class="function">actionEvent</dd>
                <dd id="SegmentNDWidget.actions" class="function">actions</dd>
                <dd id="SegmentNDWidget.activateWindow" class="function">activateWindow</dd>
                <dd id="SegmentNDWidget.addAction" class="function">addAction</dd>
                <dd id="SegmentNDWidget.addActions" class="function">addActions</dd>
                <dd id="SegmentNDWidget.adjustSize" class="function">adjustSize</dd>
                <dd id="SegmentNDWidget.autoFillBackground" class="function">autoFillBackground</dd>
                <dd id="SegmentNDWidget.backgroundRole" class="function">backgroundRole</dd>
                <dd id="SegmentNDWidget.baseSize" class="function">baseSize</dd>
                <dd id="SegmentNDWidget.changeEvent" class="function">changeEvent</dd>
                <dd id="SegmentNDWidget.childAt" class="function">childAt</dd>
                <dd id="SegmentNDWidget.childrenRect" class="function">childrenRect</dd>
                <dd id="SegmentNDWidget.childrenRegion" class="function">childrenRegion</dd>
                <dd id="SegmentNDWidget.clearFocus" class="function">clearFocus</dd>
                <dd id="SegmentNDWidget.clearMask" class="function">clearMask</dd>
                <dd id="SegmentNDWidget.close" class="function">close</dd>
                <dd id="SegmentNDWidget.closeEvent" class="function">closeEvent</dd>
                <dd id="SegmentNDWidget.contentsMargins" class="function">contentsMargins</dd>
                <dd id="SegmentNDWidget.contentsRect" class="function">contentsRect</dd>
                <dd id="SegmentNDWidget.contextMenuEvent" class="function">contextMenuEvent</dd>
                <dd id="SegmentNDWidget.contextMenuPolicy" class="function">contextMenuPolicy</dd>
                <dd id="SegmentNDWidget.create" class="function">create</dd>
                <dd id="SegmentNDWidget.createWindowContainer" class="function">createWindowContainer</dd>
                <dd id="SegmentNDWidget.cursor" class="function">cursor</dd>
                <dd id="SegmentNDWidget.destroy" class="function">destroy</dd>
                <dd id="SegmentNDWidget.devType" class="function">devType</dd>
                <dd id="SegmentNDWidget.dragEnterEvent" class="function">dragEnterEvent</dd>
                <dd id="SegmentNDWidget.dragLeaveEvent" class="function">dragLeaveEvent</dd>
                <dd id="SegmentNDWidget.dragMoveEvent" class="function">dragMoveEvent</dd>
                <dd id="SegmentNDWidget.dropEvent" class="function">dropEvent</dd>
                <dd id="SegmentNDWidget.effectiveWinId" class="function">effectiveWinId</dd>
                <dd id="SegmentNDWidget.ensurePolished" class="function">ensurePolished</dd>
                <dd id="SegmentNDWidget.enterEvent" class="function">enterEvent</dd>
                <dd id="SegmentNDWidget.event" class="function">event</dd>
                <dd id="SegmentNDWidget.find" class="function">find</dd>
                <dd id="SegmentNDWidget.focusInEvent" class="function">focusInEvent</dd>
                <dd id="SegmentNDWidget.focusNextChild" class="function">focusNextChild</dd>
                <dd id="SegmentNDWidget.focusNextPrevChild" class="function">focusNextPrevChild</dd>
                <dd id="SegmentNDWidget.focusOutEvent" class="function">focusOutEvent</dd>
                <dd id="SegmentNDWidget.focusPolicy" class="function">focusPolicy</dd>
                <dd id="SegmentNDWidget.focusPreviousChild" class="function">focusPreviousChild</dd>
                <dd id="SegmentNDWidget.focusProxy" class="function">focusProxy</dd>
                <dd id="SegmentNDWidget.focusWidget" class="function">focusWidget</dd>
                <dd id="SegmentNDWidget.font" class="function">font</dd>
                <dd id="SegmentNDWidget.fontInfo" class="function">fontInfo</dd>
                <dd id="SegmentNDWidget.fontMetrics" class="function">fontMetrics</dd>
                <dd id="SegmentNDWidget.foregroundRole" class="function">foregroundRole</dd>
                <dd id="SegmentNDWidget.frameGeometry" class="function">frameGeometry</dd>
                <dd id="SegmentNDWidget.frameSize" class="function">frameSize</dd>
                <dd id="SegmentNDWidget.geometry" class="function">geometry</dd>
                <dd id="SegmentNDWidget.getContentsMargins" class="function">getContentsMargins</dd>
                <dd id="SegmentNDWidget.grab" class="function">grab</dd>
                <dd id="SegmentNDWidget.grabGesture" class="function">grabGesture</dd>
                <dd id="SegmentNDWidget.grabKeyboard" class="function">grabKeyboard</dd>
                <dd id="SegmentNDWidget.grabMouse" class="function">grabMouse</dd>
                <dd id="SegmentNDWidget.grabShortcut" class="function">grabShortcut</dd>
                <dd id="SegmentNDWidget.graphicsEffect" class="function">graphicsEffect</dd>
                <dd id="SegmentNDWidget.graphicsProxyWidget" class="function">graphicsProxyWidget</dd>
                <dd id="SegmentNDWidget.hasFocus" class="function">hasFocus</dd>
                <dd id="SegmentNDWidget.hasHeightForWidth" class="function">hasHeightForWidth</dd>
                <dd id="SegmentNDWidget.hasMouseTracking" class="function">hasMouseTracking</dd>
                <dd id="SegmentNDWidget.hasTabletTracking" class="function">hasTabletTracking</dd>
                <dd id="SegmentNDWidget.height" class="function">height</dd>
                <dd id="SegmentNDWidget.heightForWidth" class="function">heightForWidth</dd>
                <dd id="SegmentNDWidget.hide" class="function">hide</dd>
                <dd id="SegmentNDWidget.hideEvent" class="function">hideEvent</dd>
                <dd id="SegmentNDWidget.initPainter" class="function">initPainter</dd>
                <dd id="SegmentNDWidget.inputMethodEvent" class="function">inputMethodEvent</dd>
                <dd id="SegmentNDWidget.inputMethodHints" class="function">inputMethodHints</dd>
                <dd id="SegmentNDWidget.inputMethodQuery" class="function">inputMethodQuery</dd>
                <dd id="SegmentNDWidget.insertAction" class="function">insertAction</dd>
                <dd id="SegmentNDWidget.insertActions" class="function">insertActions</dd>
                <dd id="SegmentNDWidget.isActiveWindow" class="function">isActiveWindow</dd>
                <dd id="SegmentNDWidget.isAncestorOf" class="function">isAncestorOf</dd>
                <dd id="SegmentNDWidget.isEnabled" class="function">isEnabled</dd>
                <dd id="SegmentNDWidget.isEnabledTo" class="function">isEnabledTo</dd>
                <dd id="SegmentNDWidget.isFullScreen" class="function">isFullScreen</dd>
                <dd id="SegmentNDWidget.isHidden" class="function">isHidden</dd>
                <dd id="SegmentNDWidget.isLeftToRight" class="function">isLeftToRight</dd>
                <dd id="SegmentNDWidget.isMaximized" class="function">isMaximized</dd>
                <dd id="SegmentNDWidget.isMinimized" class="function">isMinimized</dd>
                <dd id="SegmentNDWidget.isModal" class="function">isModal</dd>
                <dd id="SegmentNDWidget.isRightToLeft" class="function">isRightToLeft</dd>
                <dd id="SegmentNDWidget.isVisible" class="function">isVisible</dd>
                <dd id="SegmentNDWidget.isVisibleTo" class="function">isVisibleTo</dd>
                <dd id="SegmentNDWidget.isWindow" class="function">isWindow</dd>
                <dd id="SegmentNDWidget.isWindowModified" class="function">isWindowModified</dd>
                <dd id="SegmentNDWidget.keyPressEvent" class="function">keyPressEvent</dd>
                <dd id="SegmentNDWidget.keyReleaseEvent" class="function">keyReleaseEvent</dd>
                <dd id="SegmentNDWidget.keyboardGrabber" class="function">keyboardGrabber</dd>
                <dd id="SegmentNDWidget.layout" class="function">layout</dd>
                <dd id="SegmentNDWidget.layoutDirection" class="function">layoutDirection</dd>
                <dd id="SegmentNDWidget.leaveEvent" class="function">leaveEvent</dd>
                <dd id="SegmentNDWidget.locale" class="function">locale</dd>
                <dd id="SegmentNDWidget.lower" class="function">lower</dd>
                <dd id="SegmentNDWidget.mapFrom" class="function">mapFrom</dd>
                <dd id="SegmentNDWidget.mapFromGlobal" class="function">mapFromGlobal</dd>
                <dd id="SegmentNDWidget.mapFromParent" class="function">mapFromParent</dd>
                <dd id="SegmentNDWidget.mapTo" class="function">mapTo</dd>
                <dd id="SegmentNDWidget.mapToGlobal" class="function">mapToGlobal</dd>
                <dd id="SegmentNDWidget.mapToParent" class="function">mapToParent</dd>
                <dd id="SegmentNDWidget.mask" class="function">mask</dd>
                <dd id="SegmentNDWidget.maximumHeight" class="function">maximumHeight</dd>
                <dd id="SegmentNDWidget.maximumSize" class="function">maximumSize</dd>
                <dd id="SegmentNDWidget.maximumWidth" class="function">maximumWidth</dd>
                <dd id="SegmentNDWidget.metric" class="function">metric</dd>
                <dd id="SegmentNDWidget.minimumHeight" class="function">minimumHeight</dd>
                <dd id="SegmentNDWidget.minimumSize" class="function">minimumSize</dd>
                <dd id="SegmentNDWidget.minimumSizeHint" class="function">minimumSizeHint</dd>
                <dd id="SegmentNDWidget.minimumWidth" class="function">minimumWidth</dd>
                <dd id="SegmentNDWidget.mouseDoubleClickEvent" class="function">mouseDoubleClickEvent</dd>
                <dd id="SegmentNDWidget.mouseGrabber" class="function">mouseGrabber</dd>
                <dd id="SegmentNDWidget.mouseMoveEvent" class="function">mouseMoveEvent</dd>
                <dd id="SegmentNDWidget.mousePressEvent" class="function">mousePressEvent</dd>
                <dd id="SegmentNDWidget.mouseReleaseEvent" class="function">mouseReleaseEvent</dd>
                <dd id="SegmentNDWidget.move" class="function">move</dd>
                <dd id="SegmentNDWidget.moveEvent" class="function">moveEvent</dd>
                <dd id="SegmentNDWidget.nativeEvent" class="function">nativeEvent</dd>
                <dd id="SegmentNDWidget.nativeParentWidget" class="function">nativeParentWidget</dd>
                <dd id="SegmentNDWidget.nextInFocusChain" class="function">nextInFocusChain</dd>
                <dd id="SegmentNDWidget.normalGeometry" class="function">normalGeometry</dd>
                <dd id="SegmentNDWidget.overrideWindowFlags" class="function">overrideWindowFlags</dd>
                <dd id="SegmentNDWidget.overrideWindowState" class="function">overrideWindowState</dd>
                <dd id="SegmentNDWidget.paintEngine" class="function">paintEngine</dd>
                <dd id="SegmentNDWidget.paintEvent" class="function">paintEvent</dd>
                <dd id="SegmentNDWidget.palette" class="function">palette</dd>
                <dd id="SegmentNDWidget.parentWidget" class="function">parentWidget</dd>
                <dd id="SegmentNDWidget.pos" class="function">pos</dd>
                <dd id="SegmentNDWidget.previousInFocusChain" class="function">previousInFocusChain</dd>
                <dd id="SegmentNDWidget.raise_" class="function">raise_</dd>
                <dd id="SegmentNDWidget.rect" class="function">rect</dd>
                <dd id="SegmentNDWidget.releaseKeyboard" class="function">releaseKeyboard</dd>
                <dd id="SegmentNDWidget.releaseMouse" class="function">releaseMouse</dd>
                <dd id="SegmentNDWidget.releaseShortcut" class="function">releaseShortcut</dd>
                <dd id="SegmentNDWidget.removeAction" class="function">removeAction</dd>
                <dd id="SegmentNDWidget.render" class="function">render</dd>
                <dd id="SegmentNDWidget.repaint" class="function">repaint</dd>
                <dd id="SegmentNDWidget.resize" class="function">resize</dd>
                <dd id="SegmentNDWidget.resizeEvent" class="function">resizeEvent</dd>
                <dd id="SegmentNDWidget.restoreGeometry" class="function">restoreGeometry</dd>
                <dd id="SegmentNDWidget.saveGeometry" class="function">saveGeometry</dd>
                <dd id="SegmentNDWidget.screen" class="function">screen</dd>
                <dd id="SegmentNDWidget.scroll" class="function">scroll</dd>
                <dd id="SegmentNDWidget.setAcceptDrops" class="function">setAcceptDrops</dd>
                <dd id="SegmentNDWidget.setAccessibleDescription" class="function">setAccessibleDescription</dd>
                <dd id="SegmentNDWidget.setAccessibleName" class="function">setAccessibleName</dd>
                <dd id="SegmentNDWidget.setAttribute" class="function">setAttribute</dd>
                <dd id="SegmentNDWidget.setAutoFillBackground" class="function">setAutoFillBackground</dd>
                <dd id="SegmentNDWidget.setBackgroundRole" class="function">setBackgroundRole</dd>
                <dd id="SegmentNDWidget.setBaseSize" class="function">setBaseSize</dd>
                <dd id="SegmentNDWidget.setContentsMargins" class="function">setContentsMargins</dd>
                <dd id="SegmentNDWidget.setContextMenuPolicy" class="function">setContextMenuPolicy</dd>
                <dd id="SegmentNDWidget.setCursor" class="function">setCursor</dd>
                <dd id="SegmentNDWidget.setDisabled" class="function">setDisabled</dd>
                <dd id="SegmentNDWidget.setEnabled" class="function">setEnabled</dd>
                <dd id="SegmentNDWidget.setFixedHeight" class="function">setFixedHeight</dd>
                <dd id="SegmentNDWidget.setFixedSize" class="function">setFixedSize</dd>
                <dd id="SegmentNDWidget.setFixedWidth" class="function">setFixedWidth</dd>
                <dd id="SegmentNDWidget.setFocus" class="function">setFocus</dd>
                <dd id="SegmentNDWidget.setFocusPolicy" class="function">setFocusPolicy</dd>
                <dd id="SegmentNDWidget.setFocusProxy" class="function">setFocusProxy</dd>
                <dd id="SegmentNDWidget.setFont" class="function">setFont</dd>
                <dd id="SegmentNDWidget.setForegroundRole" class="function">setForegroundRole</dd>
                <dd id="SegmentNDWidget.setGeometry" class="function">setGeometry</dd>
                <dd id="SegmentNDWidget.setGraphicsEffect" class="function">setGraphicsEffect</dd>
                <dd id="SegmentNDWidget.setHidden" class="function">setHidden</dd>
                <dd id="SegmentNDWidget.setInputMethodHints" class="function">setInputMethodHints</dd>
                <dd id="SegmentNDWidget.setLayout" class="function">setLayout</dd>
                <dd id="SegmentNDWidget.setLayoutDirection" class="function">setLayoutDirection</dd>
                <dd id="SegmentNDWidget.setLocale" class="function">setLocale</dd>
                <dd id="SegmentNDWidget.setMask" class="function">setMask</dd>
                <dd id="SegmentNDWidget.setMaximumHeight" class="function">setMaximumHeight</dd>
                <dd id="SegmentNDWidget.setMaximumSize" class="function">setMaximumSize</dd>
                <dd id="SegmentNDWidget.setMaximumWidth" class="function">setMaximumWidth</dd>
                <dd id="SegmentNDWidget.setMinimumHeight" class="function">setMinimumHeight</dd>
                <dd id="SegmentNDWidget.setMinimumSize" class="function">setMinimumSize</dd>
                <dd id="SegmentNDWidget.setMinimumWidth" class="function">setMinimumWidth</dd>
                <dd id="SegmentNDWidget.setMouseTracking" class="function">setMouseTracking</dd>
                <dd id="SegmentNDWidget.setPalette" class="function">setPalette</dd>
                <dd id="SegmentNDWidget.setParent" class="function">setParent</dd>
                <dd id="SegmentNDWidget.setShortcutAutoRepeat" class="function">setShortcutAutoRepeat</dd>
                <dd id="SegmentNDWidget.setShortcutEnabled" class="function">setShortcutEnabled</dd>
                <dd id="SegmentNDWidget.setSizeIncrement" class="function">setSizeIncrement</dd>
                <dd id="SegmentNDWidget.setSizePolicy" class="function">setSizePolicy</dd>
                <dd id="SegmentNDWidget.setStatusTip" class="function">setStatusTip</dd>
                <dd id="SegmentNDWidget.setStyle" class="function">setStyle</dd>
                <dd id="SegmentNDWidget.setStyleSheet" class="function">setStyleSheet</dd>
                <dd id="SegmentNDWidget.setTabOrder" class="function">setTabOrder</dd>
                <dd id="SegmentNDWidget.setTabletTracking" class="function">setTabletTracking</dd>
                <dd id="SegmentNDWidget.setToolTip" class="function">setToolTip</dd>
                <dd id="SegmentNDWidget.setToolTipDuration" class="function">setToolTipDuration</dd>
                <dd id="SegmentNDWidget.setUpdatesEnabled" class="function">setUpdatesEnabled</dd>
                <dd id="SegmentNDWidget.setVisible" class="function">setVisible</dd>
                <dd id="SegmentNDWidget.setWhatsThis" class="function">setWhatsThis</dd>
                <dd id="SegmentNDWidget.setWindowFilePath" class="function">setWindowFilePath</dd>
                <dd id="SegmentNDWidget.setWindowFlag" class="function">setWindowFlag</dd>
                <dd id="SegmentNDWidget.setWindowFlags" class="function">setWindowFlags</dd>
                <dd id="SegmentNDWidget.setWindowIcon" class="function">setWindowIcon</dd>
                <dd id="SegmentNDWidget.setWindowIconText" class="function">setWindowIconText</dd>
                <dd id="SegmentNDWidget.setWindowModality" class="function">setWindowModality</dd>
                <dd id="SegmentNDWidget.setWindowModified" class="function">setWindowModified</dd>
                <dd id="SegmentNDWidget.setWindowOpacity" class="function">setWindowOpacity</dd>
                <dd id="SegmentNDWidget.setWindowRole" class="function">setWindowRole</dd>
                <dd id="SegmentNDWidget.setWindowState" class="function">setWindowState</dd>
                <dd id="SegmentNDWidget.setWindowTitle" class="function">setWindowTitle</dd>
                <dd id="SegmentNDWidget.sharedPainter" class="function">sharedPainter</dd>
                <dd id="SegmentNDWidget.show" class="function">show</dd>
                <dd id="SegmentNDWidget.showEvent" class="function">showEvent</dd>
                <dd id="SegmentNDWidget.showFullScreen" class="function">showFullScreen</dd>
                <dd id="SegmentNDWidget.showMaximized" class="function">showMaximized</dd>
                <dd id="SegmentNDWidget.showMinimized" class="function">showMinimized</dd>
                <dd id="SegmentNDWidget.showNormal" class="function">showNormal</dd>
                <dd id="SegmentNDWidget.size" class="function">size</dd>
                <dd id="SegmentNDWidget.sizeHint" class="function">sizeHint</dd>
                <dd id="SegmentNDWidget.sizeIncrement" class="function">sizeIncrement</dd>
                <dd id="SegmentNDWidget.sizePolicy" class="function">sizePolicy</dd>
                <dd id="SegmentNDWidget.stackUnder" class="function">stackUnder</dd>
                <dd id="SegmentNDWidget.statusTip" class="function">statusTip</dd>
                <dd id="SegmentNDWidget.style" class="function">style</dd>
                <dd id="SegmentNDWidget.styleSheet" class="function">styleSheet</dd>
                <dd id="SegmentNDWidget.tabletEvent" class="function">tabletEvent</dd>
                <dd id="SegmentNDWidget.testAttribute" class="function">testAttribute</dd>
                <dd id="SegmentNDWidget.toolTip" class="function">toolTip</dd>
                <dd id="SegmentNDWidget.toolTipDuration" class="function">toolTipDuration</dd>
                <dd id="SegmentNDWidget.underMouse" class="function">underMouse</dd>
                <dd id="SegmentNDWidget.ungrabGesture" class="function">ungrabGesture</dd>
                <dd id="SegmentNDWidget.unsetCursor" class="function">unsetCursor</dd>
                <dd id="SegmentNDWidget.unsetLayoutDirection" class="function">unsetLayoutDirection</dd>
                <dd id="SegmentNDWidget.unsetLocale" class="function">unsetLocale</dd>
                <dd id="SegmentNDWidget.update" class="function">update</dd>
                <dd id="SegmentNDWidget.updateGeometry" class="function">updateGeometry</dd>
                <dd id="SegmentNDWidget.updateMicroFocus" class="function">updateMicroFocus</dd>
                <dd id="SegmentNDWidget.updatesEnabled" class="function">updatesEnabled</dd>
                <dd id="SegmentNDWidget.visibleRegion" class="function">visibleRegion</dd>
                <dd id="SegmentNDWidget.whatsThis" class="function">whatsThis</dd>
                <dd id="SegmentNDWidget.wheelEvent" class="function">wheelEvent</dd>
                <dd id="SegmentNDWidget.width" class="function">width</dd>
                <dd id="SegmentNDWidget.winId" class="function">winId</dd>
                <dd id="SegmentNDWidget.window" class="function">window</dd>
                <dd id="SegmentNDWidget.windowFilePath" class="function">windowFilePath</dd>
                <dd id="SegmentNDWidget.windowFlags" class="function">windowFlags</dd>
                <dd id="SegmentNDWidget.windowHandle" class="function">windowHandle</dd>
                <dd id="SegmentNDWidget.windowIcon" class="function">windowIcon</dd>
                <dd id="SegmentNDWidget.windowIconText" class="function">windowIconText</dd>
                <dd id="SegmentNDWidget.windowModality" class="function">windowModality</dd>
                <dd id="SegmentNDWidget.windowOpacity" class="function">windowOpacity</dd>
                <dd id="SegmentNDWidget.windowRole" class="function">windowRole</dd>
                <dd id="SegmentNDWidget.windowState" class="function">windowState</dd>
                <dd id="SegmentNDWidget.windowTitle" class="function">windowTitle</dd>
                <dd id="SegmentNDWidget.windowType" class="function">windowType</dd>
                <dd id="SegmentNDWidget.x" class="function">x</dd>
                <dd id="SegmentNDWidget.y" class="function">y</dd>
                <dd id="SegmentNDWidget.DrawChildren" class="variable">DrawChildren</dd>
                <dd id="SegmentNDWidget.DrawWindowBackground" class="variable">DrawWindowBackground</dd>
                <dd id="SegmentNDWidget.IgnoreMask" class="variable">IgnoreMask</dd>
                <dd id="SegmentNDWidget.windowIconTextChanged" class="function">windowIconTextChanged</dd>
                <dd id="SegmentNDWidget.windowIconChanged" class="function">windowIconChanged</dd>
                <dd id="SegmentNDWidget.windowTitleChanged" class="function">windowTitleChanged</dd>
                <dd id="SegmentNDWidget.customContextMenuRequested" class="function">customContextMenuRequested</dd>

            </div>
            <div><dt>PyQt5.QtCore.QObject</dt>
                                <dd id="SegmentNDWidget.blockSignals" class="function">blockSignals</dd>
                <dd id="SegmentNDWidget.childEvent" class="function">childEvent</dd>
                <dd id="SegmentNDWidget.children" class="function">children</dd>
                <dd id="SegmentNDWidget.connectNotify" class="function">connectNotify</dd>
                <dd id="SegmentNDWidget.customEvent" class="function">customEvent</dd>
                <dd id="SegmentNDWidget.deleteLater" class="function">deleteLater</dd>
                <dd id="SegmentNDWidget.disconnect" class="function">disconnect</dd>
                <dd id="SegmentNDWidget.disconnectNotify" class="function">disconnectNotify</dd>
                <dd id="SegmentNDWidget.dumpObjectInfo" class="function">dumpObjectInfo</dd>
                <dd id="SegmentNDWidget.dumpObjectTree" class="function">dumpObjectTree</dd>
                <dd id="SegmentNDWidget.dynamicPropertyNames" class="function">dynamicPropertyNames</dd>
                <dd id="SegmentNDWidget.eventFilter" class="function">eventFilter</dd>
                <dd id="SegmentNDWidget.findChild" class="function">findChild</dd>
                <dd id="SegmentNDWidget.findChildren" class="function">findChildren</dd>
                <dd id="SegmentNDWidget.inherits" class="function">inherits</dd>
                <dd id="SegmentNDWidget.installEventFilter" class="function">installEventFilter</dd>
                <dd id="SegmentNDWidget.isSignalConnected" class="function">isSignalConnected</dd>
                <dd id="SegmentNDWidget.isWidgetType" class="function">isWidgetType</dd>
                <dd id="SegmentNDWidget.isWindowType" class="function">isWindowType</dd>
                <dd id="SegmentNDWidget.killTimer" class="function">killTimer</dd>
                <dd id="SegmentNDWidget.metaObject" class="function">metaObject</dd>
                <dd id="SegmentNDWidget.moveToThread" class="function">moveToThread</dd>
                <dd id="SegmentNDWidget.objectName" class="function">objectName</dd>
                <dd id="SegmentNDWidget.parent" class="function">parent</dd>
                <dd id="SegmentNDWidget.property" class="function">property</dd>
                <dd id="SegmentNDWidget.pyqtConfigure" class="function">pyqtConfigure</dd>
                <dd id="SegmentNDWidget.receivers" class="function">receivers</dd>
                <dd id="SegmentNDWidget.removeEventFilter" class="function">removeEventFilter</dd>
                <dd id="SegmentNDWidget.sender" class="function">sender</dd>
                <dd id="SegmentNDWidget.senderSignalIndex" class="function">senderSignalIndex</dd>
                <dd id="SegmentNDWidget.setObjectName" class="function">setObjectName</dd>
                <dd id="SegmentNDWidget.setProperty" class="function">setProperty</dd>
                <dd id="SegmentNDWidget.signalsBlocked" class="function">signalsBlocked</dd>
                <dd id="SegmentNDWidget.startTimer" class="function">startTimer</dd>
                <dd id="SegmentNDWidget.thread" class="function">thread</dd>
                <dd id="SegmentNDWidget.timerEvent" class="function">timerEvent</dd>
                <dd id="SegmentNDWidget.tr" class="function">tr</dd>
                <dd id="SegmentNDWidget.staticMetaObject" class="variable">staticMetaObject</dd>
                <dd id="SegmentNDWidget.objectNameChanged" class="function">objectNameChanged</dd>
                <dd id="SegmentNDWidget.destroyed" class="function">destroyed</dd>

            </div>
            <div><dt>PyQt5.QtGui.QPaintDevice</dt>
                                <dd id="SegmentNDWidget.PaintDeviceMetric" class="class">PaintDeviceMetric</dd>
                <dd id="SegmentNDWidget.colorCount" class="function">colorCount</dd>
                <dd id="SegmentNDWidget.depth" class="function">depth</dd>
                <dd id="SegmentNDWidget.devicePixelRatio" class="function">devicePixelRatio</dd>
                <dd id="SegmentNDWidget.devicePixelRatioF" class="function">devicePixelRatioF</dd>
                <dd id="SegmentNDWidget.devicePixelRatioFScale" class="function">devicePixelRatioFScale</dd>
                <dd id="SegmentNDWidget.heightMM" class="function">heightMM</dd>
                <dd id="SegmentNDWidget.logicalDpiX" class="function">logicalDpiX</dd>
                <dd id="SegmentNDWidget.logicalDpiY" class="function">logicalDpiY</dd>
                <dd id="SegmentNDWidget.paintingActive" class="function">paintingActive</dd>
                <dd id="SegmentNDWidget.physicalDpiX" class="function">physicalDpiX</dd>
                <dd id="SegmentNDWidget.physicalDpiY" class="function">physicalDpiY</dd>
                <dd id="SegmentNDWidget.widthMM" class="function">widthMM</dd>
                <dd id="SegmentNDWidget.PdmDepth" class="variable">PdmDepth</dd>
                <dd id="SegmentNDWidget.PdmDevicePixelRatio" class="variable">PdmDevicePixelRatio</dd>
                <dd id="SegmentNDWidget.PdmDevicePixelRatioScaled" class="variable">PdmDevicePixelRatioScaled</dd>
                <dd id="SegmentNDWidget.PdmDpiX" class="variable">PdmDpiX</dd>
                <dd id="SegmentNDWidget.PdmDpiY" class="variable">PdmDpiY</dd>
                <dd id="SegmentNDWidget.PdmHeight" class="variable">PdmHeight</dd>
                <dd id="SegmentNDWidget.PdmHeightMM" class="variable">PdmHeightMM</dd>
                <dd id="SegmentNDWidget.PdmNumColors" class="variable">PdmNumColors</dd>
                <dd id="SegmentNDWidget.PdmPhysicalDpiX" class="variable">PdmPhysicalDpiX</dd>
                <dd id="SegmentNDWidget.PdmPhysicalDpiY" class="variable">PdmPhysicalDpiY</dd>
                <dd id="SegmentNDWidget.PdmWidth" class="variable">PdmWidth</dd>
                <dd id="SegmentNDWidget.PdmWidthMM" class="variable">PdmWidthMM</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="AutoSegmentWidget">
                            <input id="AutoSegmentWidget-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AutoSegmentWidget</span><wbr>(<span class="base"><a href="#_WidgetBase">_WidgetBase</a></span>):

                <label class="view-source-button" for="AutoSegmentWidget-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AutoSegmentWidget"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AutoSegmentWidget-1367"><a href="#AutoSegmentWidget-1367"><span class="linenos">1367</span></a><span class="k">class</span> <span class="nc">AutoSegmentWidget</span><span class="p">(</span><span class="n">_WidgetBase</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1368"><a href="#AutoSegmentWidget-1368"><span class="linenos">1368</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">with_decoder</span><span class="p">,</span> <span class="n">volumetric</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1369"><a href="#AutoSegmentWidget-1369"><span class="linenos">1369</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1370"><a href="#AutoSegmentWidget-1370"><span class="linenos">1370</span></a>
</span><span id="AutoSegmentWidget-1371"><a href="#AutoSegmentWidget-1371"><span class="linenos">1371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span> <span class="o">=</span> <span class="n">viewer</span>
</span><span id="AutoSegmentWidget-1372"><a href="#AutoSegmentWidget-1372"><span class="linenos">1372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span> <span class="o">=</span> <span class="n">with_decoder</span>
</span><span id="AutoSegmentWidget-1373"><a href="#AutoSegmentWidget-1373"><span class="linenos">1373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span> <span class="o">=</span> <span class="n">volumetric</span>
</span><span id="AutoSegmentWidget-1374"><a href="#AutoSegmentWidget-1374"><span class="linenos">1374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_create_widget</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1375"><a href="#AutoSegmentWidget-1375"><span class="linenos">1375</span></a>
</span><span id="AutoSegmentWidget-1376"><a href="#AutoSegmentWidget-1376"><span class="linenos">1376</span></a>    <span class="k">def</span> <span class="nf">_create_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1377"><a href="#AutoSegmentWidget-1377"><span class="linenos">1377</span></a>        <span class="c1"># Add the switch for segmenting the slice vs. the volume if we have a volume.</span>
</span><span id="AutoSegmentWidget-1378"><a href="#AutoSegmentWidget-1378"><span class="linenos">1378</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1379"><a href="#AutoSegmentWidget-1379"><span class="linenos">1379</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_volumetric_switch</span><span class="p">())</span>
</span><span id="AutoSegmentWidget-1380"><a href="#AutoSegmentWidget-1380"><span class="linenos">1380</span></a>
</span><span id="AutoSegmentWidget-1381"><a href="#AutoSegmentWidget-1381"><span class="linenos">1381</span></a>        <span class="c1"># Add the nested settings widget.</span>
</span><span id="AutoSegmentWidget-1382"><a href="#AutoSegmentWidget-1382"><span class="linenos">1382</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_settings</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1383"><a href="#AutoSegmentWidget-1383"><span class="linenos">1383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1384"><a href="#AutoSegmentWidget-1384"><span class="linenos">1384</span></a>
</span><span id="AutoSegmentWidget-1385"><a href="#AutoSegmentWidget-1385"><span class="linenos">1385</span></a>        <span class="c1"># Add the run button.</span>
</span><span id="AutoSegmentWidget-1386"><a href="#AutoSegmentWidget-1386"><span class="linenos">1386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Automatic Segmentation&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1387"><a href="#AutoSegmentWidget-1387"><span class="linenos">1387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1388"><a href="#AutoSegmentWidget-1388"><span class="linenos">1388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;run_button&quot;</span><span class="p">))</span>
</span><span id="AutoSegmentWidget-1389"><a href="#AutoSegmentWidget-1389"><span class="linenos">1389</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_button</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1390"><a href="#AutoSegmentWidget-1390"><span class="linenos">1390</span></a>
</span><span id="AutoSegmentWidget-1391"><a href="#AutoSegmentWidget-1391"><span class="linenos">1391</span></a>    <span class="k">def</span> <span class="nf">_reset_segmentation_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_decoder</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1392"><a href="#AutoSegmentWidget-1392"><span class="linenos">1392</span></a>        <span class="c1"># If we already have the same segmentation mode we don&#39;t need to do anything.</span>
</span><span id="AutoSegmentWidget-1393"><a href="#AutoSegmentWidget-1393"><span class="linenos">1393</span></a>        <span class="k">if</span> <span class="n">with_decoder</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1394"><a href="#AutoSegmentWidget-1394"><span class="linenos">1394</span></a>            <span class="k">return</span>
</span><span id="AutoSegmentWidget-1395"><a href="#AutoSegmentWidget-1395"><span class="linenos">1395</span></a>
</span><span id="AutoSegmentWidget-1396"><a href="#AutoSegmentWidget-1396"><span class="linenos">1396</span></a>        <span class="c1"># Otherwise we change the value of with_decoder.</span>
</span><span id="AutoSegmentWidget-1397"><a href="#AutoSegmentWidget-1397"><span class="linenos">1397</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span> <span class="o">=</span> <span class="n">with_decoder</span>
</span><span id="AutoSegmentWidget-1398"><a href="#AutoSegmentWidget-1398"><span class="linenos">1398</span></a>
</span><span id="AutoSegmentWidget-1399"><a href="#AutoSegmentWidget-1399"><span class="linenos">1399</span></a>        <span class="c1"># Then we clear the whole widget.</span>
</span><span id="AutoSegmentWidget-1400"><a href="#AutoSegmentWidget-1400"><span class="linenos">1400</span></a>        <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1401"><a href="#AutoSegmentWidget-1401"><span class="linenos">1401</span></a>        <span class="k">while</span> <span class="n">layout</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
</span><span id="AutoSegmentWidget-1402"><a href="#AutoSegmentWidget-1402"><span class="linenos">1402</span></a>            <span class="n">child</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">takeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1403"><a href="#AutoSegmentWidget-1403"><span class="linenos">1403</span></a>            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="p">():</span>
</span><span id="AutoSegmentWidget-1404"><a href="#AutoSegmentWidget-1404"><span class="linenos">1404</span></a>                <span class="n">child</span><span class="o">.</span><span class="n">widget</span><span class="p">()</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1405"><a href="#AutoSegmentWidget-1405"><span class="linenos">1405</span></a>
</span><span id="AutoSegmentWidget-1406"><a href="#AutoSegmentWidget-1406"><span class="linenos">1406</span></a>        <span class="c1"># And then we reset it.</span>
</span><span id="AutoSegmentWidget-1407"><a href="#AutoSegmentWidget-1407"><span class="linenos">1407</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_create_widget</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1408"><a href="#AutoSegmentWidget-1408"><span class="linenos">1408</span></a>
</span><span id="AutoSegmentWidget-1409"><a href="#AutoSegmentWidget-1409"><span class="linenos">1409</span></a>    <span class="k">def</span> <span class="nf">_create_volumetric_switch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1410"><a href="#AutoSegmentWidget-1410"><span class="linenos">1410</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AutoSegmentWidget-1411"><a href="#AutoSegmentWidget-1411"><span class="linenos">1411</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_boolean_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1412"><a href="#AutoSegmentWidget-1412"><span class="linenos">1412</span></a>            <span class="s2">&quot;apply_to_volume&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Apply to Volume&quot;</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1413"><a href="#AutoSegmentWidget-1413"><span class="linenos">1413</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;apply_to_volume&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1414"><a href="#AutoSegmentWidget-1414"><span class="linenos">1414</span></a>            <span class="p">)</span>
</span><span id="AutoSegmentWidget-1415"><a href="#AutoSegmentWidget-1415"><span class="linenos">1415</span></a>
</span><span id="AutoSegmentWidget-1416"><a href="#AutoSegmentWidget-1416"><span class="linenos">1416</span></a>    <span class="k">def</span> <span class="nf">_add_common_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1417"><a href="#AutoSegmentWidget-1417"><span class="linenos">1417</span></a>        <span class="c1"># Create the UI element for min object size.</span>
</span><span id="AutoSegmentWidget-1418"><a href="#AutoSegmentWidget-1418"><span class="linenos">1418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="AutoSegmentWidget-1419"><a href="#AutoSegmentWidget-1419"><span class="linenos">1419</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1420"><a href="#AutoSegmentWidget-1420"><span class="linenos">1420</span></a>            <span class="s2">&quot;min_object_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),</span>
</span><span id="AutoSegmentWidget-1421"><a href="#AutoSegmentWidget-1421"><span class="linenos">1421</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;min_object_size&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1422"><a href="#AutoSegmentWidget-1422"><span class="linenos">1422</span></a>        <span class="p">)</span>
</span><span id="AutoSegmentWidget-1423"><a href="#AutoSegmentWidget-1423"><span class="linenos">1423</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1424"><a href="#AutoSegmentWidget-1424"><span class="linenos">1424</span></a>
</span><span id="AutoSegmentWidget-1425"><a href="#AutoSegmentWidget-1425"><span class="linenos">1425</span></a>        <span class="c1"># Create the UI element for with background.</span>
</span><span id="AutoSegmentWidget-1426"><a href="#AutoSegmentWidget-1426"><span class="linenos">1426</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AutoSegmentWidget-1427"><a href="#AutoSegmentWidget-1427"><span class="linenos">1427</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_add_boolean_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1428"><a href="#AutoSegmentWidget-1428"><span class="linenos">1428</span></a>            <span class="s2">&quot;with_background&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1429"><a href="#AutoSegmentWidget-1429"><span class="linenos">1429</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;with_background&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1430"><a href="#AutoSegmentWidget-1430"><span class="linenos">1430</span></a>            <span class="p">))</span>
</span><span id="AutoSegmentWidget-1431"><a href="#AutoSegmentWidget-1431"><span class="linenos">1431</span></a>
</span><span id="AutoSegmentWidget-1432"><a href="#AutoSegmentWidget-1432"><span class="linenos">1432</span></a>        <span class="c1"># Add extra settings for volumetric segmentation: gap_closing and min_extent.</span>
</span><span id="AutoSegmentWidget-1433"><a href="#AutoSegmentWidget-1433"><span class="linenos">1433</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1434"><a href="#AutoSegmentWidget-1434"><span class="linenos">1434</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gap_closing</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="AutoSegmentWidget-1435"><a href="#AutoSegmentWidget-1435"><span class="linenos">1435</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gap_closing_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1436"><a href="#AutoSegmentWidget-1436"><span class="linenos">1436</span></a>                <span class="s2">&quot;gap_closing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap_closing</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1437"><a href="#AutoSegmentWidget-1437"><span class="linenos">1437</span></a>                <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;gap_closing&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1438"><a href="#AutoSegmentWidget-1438"><span class="linenos">1438</span></a>                <span class="p">)</span>
</span><span id="AutoSegmentWidget-1439"><a href="#AutoSegmentWidget-1439"><span class="linenos">1439</span></a>            <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1440"><a href="#AutoSegmentWidget-1440"><span class="linenos">1440</span></a>
</span><span id="AutoSegmentWidget-1441"><a href="#AutoSegmentWidget-1441"><span class="linenos">1441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">min_extent</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="AutoSegmentWidget-1442"><a href="#AutoSegmentWidget-1442"><span class="linenos">1442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">min_extent_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_int_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1443"><a href="#AutoSegmentWidget-1443"><span class="linenos">1443</span></a>                <span class="s2">&quot;min_extent&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_extent</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1444"><a href="#AutoSegmentWidget-1444"><span class="linenos">1444</span></a>                <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;min_extent&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1445"><a href="#AutoSegmentWidget-1445"><span class="linenos">1445</span></a>                <span class="p">)</span>
</span><span id="AutoSegmentWidget-1446"><a href="#AutoSegmentWidget-1446"><span class="linenos">1446</span></a>            <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1447"><a href="#AutoSegmentWidget-1447"><span class="linenos">1447</span></a>
</span><span id="AutoSegmentWidget-1448"><a href="#AutoSegmentWidget-1448"><span class="linenos">1448</span></a>    <span class="k">def</span> <span class="nf">_ais_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1449"><a href="#AutoSegmentWidget-1449"><span class="linenos">1449</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1450"><a href="#AutoSegmentWidget-1450"><span class="linenos">1450</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="AutoSegmentWidget-1451"><a href="#AutoSegmentWidget-1451"><span class="linenos">1451</span></a>
</span><span id="AutoSegmentWidget-1452"><a href="#AutoSegmentWidget-1452"><span class="linenos">1452</span></a>        <span class="c1"># Create the UI element for center_distance_threshold.</span>
</span><span id="AutoSegmentWidget-1453"><a href="#AutoSegmentWidget-1453"><span class="linenos">1453</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="AutoSegmentWidget-1454"><a href="#AutoSegmentWidget-1454"><span class="linenos">1454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1455"><a href="#AutoSegmentWidget-1455"><span class="linenos">1455</span></a>            <span class="s2">&quot;center_distance_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1456"><a href="#AutoSegmentWidget-1456"><span class="linenos">1456</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;center_distance_thresh&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1457"><a href="#AutoSegmentWidget-1457"><span class="linenos">1457</span></a>        <span class="p">)</span>
</span><span id="AutoSegmentWidget-1458"><a href="#AutoSegmentWidget-1458"><span class="linenos">1458</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1459"><a href="#AutoSegmentWidget-1459"><span class="linenos">1459</span></a>
</span><span id="AutoSegmentWidget-1460"><a href="#AutoSegmentWidget-1460"><span class="linenos">1460</span></a>        <span class="c1"># Create the UI element for boundary_distance_threshold.</span>
</span><span id="AutoSegmentWidget-1461"><a href="#AutoSegmentWidget-1461"><span class="linenos">1461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
</span><span id="AutoSegmentWidget-1462"><a href="#AutoSegmentWidget-1462"><span class="linenos">1462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1463"><a href="#AutoSegmentWidget-1463"><span class="linenos">1463</span></a>            <span class="s2">&quot;boundary_distance_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1464"><a href="#AutoSegmentWidget-1464"><span class="linenos">1464</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_distance_thresh&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1465"><a href="#AutoSegmentWidget-1465"><span class="linenos">1465</span></a>        <span class="p">)</span>
</span><span id="AutoSegmentWidget-1466"><a href="#AutoSegmentWidget-1466"><span class="linenos">1466</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1467"><a href="#AutoSegmentWidget-1467"><span class="linenos">1467</span></a>
</span><span id="AutoSegmentWidget-1468"><a href="#AutoSegmentWidget-1468"><span class="linenos">1468</span></a>        <span class="c1"># Add min_object_size and with_background</span>
</span><span id="AutoSegmentWidget-1469"><a href="#AutoSegmentWidget-1469"><span class="linenos">1469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_common_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1470"><a href="#AutoSegmentWidget-1470"><span class="linenos">1470</span></a>
</span><span id="AutoSegmentWidget-1471"><a href="#AutoSegmentWidget-1471"><span class="linenos">1471</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="AutoSegmentWidget-1472"><a href="#AutoSegmentWidget-1472"><span class="linenos">1472</span></a>
</span><span id="AutoSegmentWidget-1473"><a href="#AutoSegmentWidget-1473"><span class="linenos">1473</span></a>    <span class="k">def</span> <span class="nf">_amg_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1474"><a href="#AutoSegmentWidget-1474"><span class="linenos">1474</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1475"><a href="#AutoSegmentWidget-1475"><span class="linenos">1475</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">())</span>
</span><span id="AutoSegmentWidget-1476"><a href="#AutoSegmentWidget-1476"><span class="linenos">1476</span></a>
</span><span id="AutoSegmentWidget-1477"><a href="#AutoSegmentWidget-1477"><span class="linenos">1477</span></a>        <span class="c1"># Create the UI element for pred_iou_thresh.</span>
</span><span id="AutoSegmentWidget-1478"><a href="#AutoSegmentWidget-1478"><span class="linenos">1478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh</span> <span class="o">=</span> <span class="mf">0.88</span>
</span><span id="AutoSegmentWidget-1479"><a href="#AutoSegmentWidget-1479"><span class="linenos">1479</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1480"><a href="#AutoSegmentWidget-1480"><span class="linenos">1480</span></a>            <span class="s2">&quot;pred_iou_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1481"><a href="#AutoSegmentWidget-1481"><span class="linenos">1481</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;pred_iou_thresh&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1482"><a href="#AutoSegmentWidget-1482"><span class="linenos">1482</span></a>            <span class="p">)</span>
</span><span id="AutoSegmentWidget-1483"><a href="#AutoSegmentWidget-1483"><span class="linenos">1483</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1484"><a href="#AutoSegmentWidget-1484"><span class="linenos">1484</span></a>
</span><span id="AutoSegmentWidget-1485"><a href="#AutoSegmentWidget-1485"><span class="linenos">1485</span></a>        <span class="c1"># Create the UI element for stability score thresh.</span>
</span><span id="AutoSegmentWidget-1486"><a href="#AutoSegmentWidget-1486"><span class="linenos">1486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh</span> <span class="o">=</span> <span class="mf">0.95</span>
</span><span id="AutoSegmentWidget-1487"><a href="#AutoSegmentWidget-1487"><span class="linenos">1487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1488"><a href="#AutoSegmentWidget-1488"><span class="linenos">1488</span></a>            <span class="s2">&quot;stability_score_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1489"><a href="#AutoSegmentWidget-1489"><span class="linenos">1489</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;stability_score_thresh&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1490"><a href="#AutoSegmentWidget-1490"><span class="linenos">1490</span></a>        <span class="p">)</span>
</span><span id="AutoSegmentWidget-1491"><a href="#AutoSegmentWidget-1491"><span class="linenos">1491</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1492"><a href="#AutoSegmentWidget-1492"><span class="linenos">1492</span></a>
</span><span id="AutoSegmentWidget-1493"><a href="#AutoSegmentWidget-1493"><span class="linenos">1493</span></a>        <span class="c1"># Create the UI element for box nms thresh.</span>
</span><span id="AutoSegmentWidget-1494"><a href="#AutoSegmentWidget-1494"><span class="linenos">1494</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh</span> <span class="o">=</span> <span class="mf">0.7</span>
</span><span id="AutoSegmentWidget-1495"><a href="#AutoSegmentWidget-1495"><span class="linenos">1495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh_param</span><span class="p">,</span> <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_float_param</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1496"><a href="#AutoSegmentWidget-1496"><span class="linenos">1496</span></a>            <span class="s2">&quot;box_nms_thresh&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1497"><a href="#AutoSegmentWidget-1497"><span class="linenos">1497</span></a>            <span class="n">tooltip</span><span class="o">=</span><span class="n">get_tooltip</span><span class="p">(</span><span class="s2">&quot;autosegment&quot;</span><span class="p">,</span> <span class="s2">&quot;box_nms_thresh&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1498"><a href="#AutoSegmentWidget-1498"><span class="linenos">1498</span></a>            <span class="p">)</span>
</span><span id="AutoSegmentWidget-1499"><a href="#AutoSegmentWidget-1499"><span class="linenos">1499</span></a>        <span class="n">settings</span><span class="o">.</span><span class="n">layout</span><span class="p">()</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1500"><a href="#AutoSegmentWidget-1500"><span class="linenos">1500</span></a>
</span><span id="AutoSegmentWidget-1501"><a href="#AutoSegmentWidget-1501"><span class="linenos">1501</span></a>        <span class="c1"># Add min_object_size and with_background</span>
</span><span id="AutoSegmentWidget-1502"><a href="#AutoSegmentWidget-1502"><span class="linenos">1502</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_common_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1503"><a href="#AutoSegmentWidget-1503"><span class="linenos">1503</span></a>
</span><span id="AutoSegmentWidget-1504"><a href="#AutoSegmentWidget-1504"><span class="linenos">1504</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="AutoSegmentWidget-1505"><a href="#AutoSegmentWidget-1505"><span class="linenos">1505</span></a>
</span><span id="AutoSegmentWidget-1506"><a href="#AutoSegmentWidget-1506"><span class="linenos">1506</span></a>    <span class="k">def</span> <span class="nf">_create_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1507"><a href="#AutoSegmentWidget-1507"><span class="linenos">1507</span></a>        <span class="n">setting_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ais_settings</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amg_settings</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1508"><a href="#AutoSegmentWidget-1508"><span class="linenos">1508</span></a>        <span class="n">settings</span> <span class="o">=</span> <span class="n">_make_collapsible</span><span class="p">(</span><span class="n">setting_values</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Automatic Segmentation Settings&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1509"><a href="#AutoSegmentWidget-1509"><span class="linenos">1509</span></a>        <span class="k">return</span> <span class="n">settings</span>
</span><span id="AutoSegmentWidget-1510"><a href="#AutoSegmentWidget-1510"><span class="linenos">1510</span></a>
</span><span id="AutoSegmentWidget-1511"><a href="#AutoSegmentWidget-1511"><span class="linenos">1511</span></a>    <span class="k">def</span> <span class="nf">_empty_segmentation_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1512"><a href="#AutoSegmentWidget-1512"><span class="linenos">1512</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The automatic segmentation result does not contain any objects.&quot;</span>
</span><span id="AutoSegmentWidget-1513"><a href="#AutoSegmentWidget-1513"><span class="linenos">1513</span></a>        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Setting a smaller value for &#39;min_object_size&#39; may help.&quot;</span>
</span><span id="AutoSegmentWidget-1514"><a href="#AutoSegmentWidget-1514"><span class="linenos">1514</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1515"><a href="#AutoSegmentWidget-1515"><span class="linenos">1515</span></a>            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Setting smaller values for &#39;pred_iou_thresh&#39; and &#39;stability_score_thresh&#39; may also help.&quot;</span>
</span><span id="AutoSegmentWidget-1516"><a href="#AutoSegmentWidget-1516"><span class="linenos">1516</span></a>        <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span>
</span><span id="AutoSegmentWidget-1517"><a href="#AutoSegmentWidget-1517"><span class="linenos">1517</span></a>        <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="AutoSegmentWidget-1518"><a href="#AutoSegmentWidget-1518"><span class="linenos">1518</span></a>
</span><span id="AutoSegmentWidget-1519"><a href="#AutoSegmentWidget-1519"><span class="linenos">1519</span></a>    <span class="k">def</span> <span class="nf">_run_segmentation_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1520"><a href="#AutoSegmentWidget-1520"><span class="linenos">1520</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1521"><a href="#AutoSegmentWidget-1521"><span class="linenos">1521</span></a>
</span><span id="AutoSegmentWidget-1522"><a href="#AutoSegmentWidget-1522"><span class="linenos">1522</span></a>        <span class="nd">@thread_worker</span>
</span><span id="AutoSegmentWidget-1523"><a href="#AutoSegmentWidget-1523"><span class="linenos">1523</span></a>        <span class="k">def</span> <span class="nf">seg_impl</span><span class="p">():</span>
</span><span id="AutoSegmentWidget-1524"><a href="#AutoSegmentWidget-1524"><span class="linenos">1524</span></a>            <span class="k">def</span> <span class="nf">pbar_init</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1525"><a href="#AutoSegmentWidget-1525"><span class="linenos">1525</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1526"><a href="#AutoSegmentWidget-1526"><span class="linenos">1526</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1527"><a href="#AutoSegmentWidget-1527"><span class="linenos">1527</span></a>
</span><span id="AutoSegmentWidget-1528"><a href="#AutoSegmentWidget-1528"><span class="linenos">1528</span></a>            <span class="n">seg</span> <span class="o">=</span> <span class="n">_instance_segmentation_impl</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1529"><a href="#AutoSegmentWidget-1529"><span class="linenos">1529</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1530"><a href="#AutoSegmentWidget-1530"><span class="linenos">1530</span></a>                <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1531"><a href="#AutoSegmentWidget-1531"><span class="linenos">1531</span></a>                <span class="n">pbar_update</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">update</span><span class="p">),</span>
</span><span id="AutoSegmentWidget-1532"><a href="#AutoSegmentWidget-1532"><span class="linenos">1532</span></a>                <span class="o">**</span><span class="n">kwargs</span>
</span><span id="AutoSegmentWidget-1533"><a href="#AutoSegmentWidget-1533"><span class="linenos">1533</span></a>            <span class="p">)</span>
</span><span id="AutoSegmentWidget-1534"><a href="#AutoSegmentWidget-1534"><span class="linenos">1534</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1535"><a href="#AutoSegmentWidget-1535"><span class="linenos">1535</span></a>            <span class="k">return</span> <span class="n">seg</span>
</span><span id="AutoSegmentWidget-1536"><a href="#AutoSegmentWidget-1536"><span class="linenos">1536</span></a>
</span><span id="AutoSegmentWidget-1537"><a href="#AutoSegmentWidget-1537"><span class="linenos">1537</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">seg</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1538"><a href="#AutoSegmentWidget-1538"><span class="linenos">1538</span></a>            <span class="n">is_empty</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AutoSegmentWidget-1539"><a href="#AutoSegmentWidget-1539"><span class="linenos">1539</span></a>            <span class="k">if</span> <span class="n">is_empty</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1540"><a href="#AutoSegmentWidget-1540"><span class="linenos">1540</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_empty_segmentation_warning</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1541"><a href="#AutoSegmentWidget-1541"><span class="linenos">1541</span></a>
</span><span id="AutoSegmentWidget-1542"><a href="#AutoSegmentWidget-1542"><span class="linenos">1542</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1543"><a href="#AutoSegmentWidget-1543"><span class="linenos">1543</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="AutoSegmentWidget-1544"><a href="#AutoSegmentWidget-1544"><span class="linenos">1544</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1545"><a href="#AutoSegmentWidget-1545"><span class="linenos">1545</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="AutoSegmentWidget-1546"><a href="#AutoSegmentWidget-1546"><span class="linenos">1546</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1547"><a href="#AutoSegmentWidget-1547"><span class="linenos">1547</span></a>
</span><span id="AutoSegmentWidget-1548"><a href="#AutoSegmentWidget-1548"><span class="linenos">1548</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">seg_impl</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1549"><a href="#AutoSegmentWidget-1549"><span class="linenos">1549</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1550"><a href="#AutoSegmentWidget-1550"><span class="linenos">1550</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1551"><a href="#AutoSegmentWidget-1551"><span class="linenos">1551</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="AutoSegmentWidget-1552"><a href="#AutoSegmentWidget-1552"><span class="linenos">1552</span></a>
</span><span id="AutoSegmentWidget-1553"><a href="#AutoSegmentWidget-1553"><span class="linenos">1553</span></a>    <span class="c1"># We refuse to run 3D segmentation with the AMG unless we have a GPU or all embeddings</span>
</span><span id="AutoSegmentWidget-1554"><a href="#AutoSegmentWidget-1554"><span class="linenos">1554</span></a>    <span class="c1"># are precomputed. Otherwise this would take too long.</span>
</span><span id="AutoSegmentWidget-1555"><a href="#AutoSegmentWidget-1555"><span class="linenos">1555</span></a>    <span class="k">def</span> <span class="nf">_allow_segment_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1556"><a href="#AutoSegmentWidget-1556"><span class="linenos">1556</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1557"><a href="#AutoSegmentWidget-1557"><span class="linenos">1557</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="AutoSegmentWidget-1558"><a href="#AutoSegmentWidget-1558"><span class="linenos">1558</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="n">AnnotatorState</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1559"><a href="#AutoSegmentWidget-1559"><span class="linenos">1559</span></a>        <span class="n">predictor</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">predictor</span>
</span><span id="AutoSegmentWidget-1560"><a href="#AutoSegmentWidget-1560"><span class="linenos">1560</span></a>        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;cpu&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mps&quot;</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1561"><a href="#AutoSegmentWidget-1561"><span class="linenos">1561</span></a>            <span class="n">n_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AutoSegmentWidget-1562"><a href="#AutoSegmentWidget-1562"><span class="linenos">1562</span></a>            <span class="n">embeddings_are_precomputed</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">amg_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">amg_state</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_slices</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1563"><a href="#AutoSegmentWidget-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">embeddings_are_precomputed</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1564"><a href="#AutoSegmentWidget-1564"><span class="linenos">1564</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="AutoSegmentWidget-1565"><a href="#AutoSegmentWidget-1565"><span class="linenos">1565</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="AutoSegmentWidget-1566"><a href="#AutoSegmentWidget-1566"><span class="linenos">1566</span></a>
</span><span id="AutoSegmentWidget-1567"><a href="#AutoSegmentWidget-1567"><span class="linenos">1567</span></a>    <span class="k">def</span> <span class="nf">_run_segmentation_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1568"><a href="#AutoSegmentWidget-1568"><span class="linenos">1568</span></a>        <span class="n">allow_segment_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_segment_3d</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1569"><a href="#AutoSegmentWidget-1569"><span class="linenos">1569</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_segment_3d</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1570"><a href="#AutoSegmentWidget-1570"><span class="linenos">1570</span></a>            <span class="n">val_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AutoSegmentWidget-1571"><a href="#AutoSegmentWidget-1571"><span class="linenos">1571</span></a>                <span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1572"><a href="#AutoSegmentWidget-1572"><span class="linenos">1572</span></a>                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Volumetric segmentation with AMG is only supported if you have a GPU.&quot;</span>
</span><span id="AutoSegmentWidget-1573"><a href="#AutoSegmentWidget-1573"><span class="linenos">1573</span></a>            <span class="p">}</span>
</span><span id="AutoSegmentWidget-1574"><a href="#AutoSegmentWidget-1574"><span class="linenos">1574</span></a>            <span class="k">return</span> <span class="n">_generate_message</span><span class="p">(</span><span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message_type&quot;</span><span class="p">],</span> <span class="n">val_results</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
</span><span id="AutoSegmentWidget-1575"><a href="#AutoSegmentWidget-1575"><span class="linenos">1575</span></a>
</span><span id="AutoSegmentWidget-1576"><a href="#AutoSegmentWidget-1576"><span class="linenos">1576</span></a>        <span class="n">pbar</span><span class="p">,</span> <span class="n">pbar_signals</span> <span class="o">=</span> <span class="n">_create_pbar_for_threadworker</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1577"><a href="#AutoSegmentWidget-1577"><span class="linenos">1577</span></a>
</span><span id="AutoSegmentWidget-1578"><a href="#AutoSegmentWidget-1578"><span class="linenos">1578</span></a>        <span class="nd">@thread_worker</span>
</span><span id="AutoSegmentWidget-1579"><a href="#AutoSegmentWidget-1579"><span class="linenos">1579</span></a>        <span class="k">def</span> <span class="nf">seg_impl</span><span class="p">():</span>
</span><span id="AutoSegmentWidget-1580"><a href="#AutoSegmentWidget-1580"><span class="linenos">1580</span></a>            <span class="n">segmentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1581"><a href="#AutoSegmentWidget-1581"><span class="linenos">1581</span></a>            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AutoSegmentWidget-1582"><a href="#AutoSegmentWidget-1582"><span class="linenos">1582</span></a>
</span><span id="AutoSegmentWidget-1583"><a href="#AutoSegmentWidget-1583"><span class="linenos">1583</span></a>            <span class="k">def</span> <span class="nf">pbar_init</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1584"><a href="#AutoSegmentWidget-1584"><span class="linenos">1584</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_total</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1585"><a href="#AutoSegmentWidget-1585"><span class="linenos">1585</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_description</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1586"><a href="#AutoSegmentWidget-1586"><span class="linenos">1586</span></a>
</span><span id="AutoSegmentWidget-1587"><a href="#AutoSegmentWidget-1587"><span class="linenos">1587</span></a>            <span class="n">pbar_init</span><span class="p">(</span><span class="n">segmentation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Segment volume&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1588"><a href="#AutoSegmentWidget-1588"><span class="linenos">1588</span></a>
</span><span id="AutoSegmentWidget-1589"><a href="#AutoSegmentWidget-1589"><span class="linenos">1589</span></a>            <span class="c1"># Further optimization: parallelize if state is precomputed for all slices</span>
</span><span id="AutoSegmentWidget-1590"><a href="#AutoSegmentWidget-1590"><span class="linenos">1590</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">segmentation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</span><span id="AutoSegmentWidget-1591"><a href="#AutoSegmentWidget-1591"><span class="linenos">1591</span></a>                <span class="n">seg</span> <span class="o">=</span> <span class="n">_instance_segmentation_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1592"><a href="#AutoSegmentWidget-1592"><span class="linenos">1592</span></a>                <span class="n">seg_max</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1593"><a href="#AutoSegmentWidget-1593"><span class="linenos">1593</span></a>                <span class="k">if</span> <span class="n">seg_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1594"><a href="#AutoSegmentWidget-1594"><span class="linenos">1594</span></a>                    <span class="k">continue</span>
</span><span id="AutoSegmentWidget-1595"><a href="#AutoSegmentWidget-1595"><span class="linenos">1595</span></a>                <span class="n">seg</span><span class="p">[</span><span class="n">seg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">offset</span>
</span><span id="AutoSegmentWidget-1596"><a href="#AutoSegmentWidget-1596"><span class="linenos">1596</span></a>                <span class="n">offset</span> <span class="o">=</span> <span class="n">seg_max</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="AutoSegmentWidget-1597"><a href="#AutoSegmentWidget-1597"><span class="linenos">1597</span></a>                <span class="n">segmentation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg</span>
</span><span id="AutoSegmentWidget-1598"><a href="#AutoSegmentWidget-1598"><span class="linenos">1598</span></a>                <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1599"><a href="#AutoSegmentWidget-1599"><span class="linenos">1599</span></a>
</span><span id="AutoSegmentWidget-1600"><a href="#AutoSegmentWidget-1600"><span class="linenos">1600</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_reset</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1601"><a href="#AutoSegmentWidget-1601"><span class="linenos">1601</span></a>            <span class="n">segmentation</span> <span class="o">=</span> <span class="n">merge_instance_segmentation_3d</span><span class="p">(</span>
</span><span id="AutoSegmentWidget-1602"><a href="#AutoSegmentWidget-1602"><span class="linenos">1602</span></a>                <span class="n">segmentation</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">with_background</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">with_background</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1603"><a href="#AutoSegmentWidget-1603"><span class="linenos">1603</span></a>                <span class="n">gap_closing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gap_closing</span><span class="p">,</span> <span class="n">min_z_extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_extent</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1604"><a href="#AutoSegmentWidget-1604"><span class="linenos">1604</span></a>                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbar_init</span><span class="o">=</span><span class="n">pbar_init</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1605"><a href="#AutoSegmentWidget-1605"><span class="linenos">1605</span></a>                <span class="n">pbar_update</span><span class="o">=</span><span class="k">lambda</span> <span class="n">update</span><span class="p">:</span> <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span id="AutoSegmentWidget-1606"><a href="#AutoSegmentWidget-1606"><span class="linenos">1606</span></a>            <span class="p">)</span>
</span><span id="AutoSegmentWidget-1607"><a href="#AutoSegmentWidget-1607"><span class="linenos">1607</span></a>            <span class="n">pbar_signals</span><span class="o">.</span><span class="n">pbar_stop</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1608"><a href="#AutoSegmentWidget-1608"><span class="linenos">1608</span></a>            <span class="k">return</span> <span class="n">segmentation</span>
</span><span id="AutoSegmentWidget-1609"><a href="#AutoSegmentWidget-1609"><span class="linenos">1609</span></a>
</span><span id="AutoSegmentWidget-1610"><a href="#AutoSegmentWidget-1610"><span class="linenos">1610</span></a>        <span class="k">def</span> <span class="nf">update_segmentation</span><span class="p">(</span><span class="n">segmentation</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1611"><a href="#AutoSegmentWidget-1611"><span class="linenos">1611</span></a>            <span class="n">is_empty</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="AutoSegmentWidget-1612"><a href="#AutoSegmentWidget-1612"><span class="linenos">1612</span></a>            <span class="k">if</span> <span class="n">is_empty</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1613"><a href="#AutoSegmentWidget-1613"><span class="linenos">1613</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_empty_segmentation_warning</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1614"><a href="#AutoSegmentWidget-1614"><span class="linenos">1614</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">segmentation</span>
</span><span id="AutoSegmentWidget-1615"><a href="#AutoSegmentWidget-1615"><span class="linenos">1615</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;auto_segmentation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1616"><a href="#AutoSegmentWidget-1616"><span class="linenos">1616</span></a>
</span><span id="AutoSegmentWidget-1617"><a href="#AutoSegmentWidget-1617"><span class="linenos">1617</span></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">seg_impl</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1618"><a href="#AutoSegmentWidget-1618"><span class="linenos">1618</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">returned</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">update_segmentation</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1619"><a href="#AutoSegmentWidget-1619"><span class="linenos">1619</span></a>        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="AutoSegmentWidget-1620"><a href="#AutoSegmentWidget-1620"><span class="linenos">1620</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span><span id="AutoSegmentWidget-1621"><a href="#AutoSegmentWidget-1621"><span class="linenos">1621</span></a>
</span><span id="AutoSegmentWidget-1622"><a href="#AutoSegmentWidget-1622"><span class="linenos">1622</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1623"><a href="#AutoSegmentWidget-1623"><span class="linenos">1623</span></a>        <span class="k">if</span> <span class="n">_validate_embeddings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">):</span>
</span><span id="AutoSegmentWidget-1624"><a href="#AutoSegmentWidget-1624"><span class="linenos">1624</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="AutoSegmentWidget-1625"><a href="#AutoSegmentWidget-1625"><span class="linenos">1625</span></a>
</span><span id="AutoSegmentWidget-1626"><a href="#AutoSegmentWidget-1626"><span class="linenos">1626</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1627"><a href="#AutoSegmentWidget-1627"><span class="linenos">1627</span></a>            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AutoSegmentWidget-1628"><a href="#AutoSegmentWidget-1628"><span class="linenos">1628</span></a>                <span class="s2">&quot;center_distance_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_distance_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1629"><a href="#AutoSegmentWidget-1629"><span class="linenos">1629</span></a>                <span class="s2">&quot;boundary_distance_threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_distance_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1630"><a href="#AutoSegmentWidget-1630"><span class="linenos">1630</span></a>                <span class="s2">&quot;min_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_size</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1631"><a href="#AutoSegmentWidget-1631"><span class="linenos">1631</span></a>            <span class="p">}</span>
</span><span id="AutoSegmentWidget-1632"><a href="#AutoSegmentWidget-1632"><span class="linenos">1632</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1633"><a href="#AutoSegmentWidget-1633"><span class="linenos">1633</span></a>            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AutoSegmentWidget-1634"><a href="#AutoSegmentWidget-1634"><span class="linenos">1634</span></a>                <span class="s2">&quot;pred_iou_thresh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_iou_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1635"><a href="#AutoSegmentWidget-1635"><span class="linenos">1635</span></a>                <span class="s2">&quot;stability_score_thresh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_score_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1636"><a href="#AutoSegmentWidget-1636"><span class="linenos">1636</span></a>                <span class="s2">&quot;box_nms_thresh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_nms_thresh</span><span class="p">,</span>
</span><span id="AutoSegmentWidget-1637"><a href="#AutoSegmentWidget-1637"><span class="linenos">1637</span></a>            <span class="p">}</span>
</span><span id="AutoSegmentWidget-1638"><a href="#AutoSegmentWidget-1638"><span class="linenos">1638</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1639"><a href="#AutoSegmentWidget-1639"><span class="linenos">1639</span></a>            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_segmentation_3d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1640"><a href="#AutoSegmentWidget-1640"><span class="linenos">1640</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_volume</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1641"><a href="#AutoSegmentWidget-1641"><span class="linenos">1641</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AutoSegmentWidget-1642"><a href="#AutoSegmentWidget-1642"><span class="linenos">1642</span></a>            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_segmentation_2d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1643"><a href="#AutoSegmentWidget-1643"><span class="linenos">1643</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AutoSegmentWidget-1644"><a href="#AutoSegmentWidget-1644"><span class="linenos">1644</span></a>            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_segmentation_2d</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1645"><a href="#AutoSegmentWidget-1645"><span class="linenos">1645</span></a>        <span class="n">_select_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span><span class="p">,</span> <span class="s2">&quot;auto_segmentation&quot;</span><span class="p">)</span>
</span><span id="AutoSegmentWidget-1646"><a href="#AutoSegmentWidget-1646"><span class="linenos">1646</span></a>        <span class="k">return</span> <span class="n">worker</span>
</span></pre></div>


            <div class="docstring"><p>QWidget(parent: typing.Optional[QWidget] = None, flags: Union[Qt.WindowFlags, Qt.WindowType] = Qt.WindowFlags())</p>
</div>


                            <div id="AutoSegmentWidget.__init__" class="classattr">
                                        <input id="AutoSegmentWidget.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AutoSegmentWidget</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">viewer</span>, </span><span class="param"><span class="n">with_decoder</span>, </span><span class="param"><span class="n">volumetric</span>, </span><span class="param"><span class="n">parent</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="AutoSegmentWidget.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AutoSegmentWidget.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AutoSegmentWidget.__init__-1368"><a href="#AutoSegmentWidget.__init__-1368"><span class="linenos">1368</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">viewer</span><span class="p">,</span> <span class="n">with_decoder</span><span class="p">,</span> <span class="n">volumetric</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AutoSegmentWidget.__init__-1369"><a href="#AutoSegmentWidget.__init__-1369"><span class="linenos">1369</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
</span><span id="AutoSegmentWidget.__init__-1370"><a href="#AutoSegmentWidget.__init__-1370"><span class="linenos">1370</span></a>
</span><span id="AutoSegmentWidget.__init__-1371"><a href="#AutoSegmentWidget.__init__-1371"><span class="linenos">1371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_viewer</span> <span class="o">=</span> <span class="n">viewer</span>
</span><span id="AutoSegmentWidget.__init__-1372"><a href="#AutoSegmentWidget.__init__-1372"><span class="linenos">1372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">with_decoder</span> <span class="o">=</span> <span class="n">with_decoder</span>
</span><span id="AutoSegmentWidget.__init__-1373"><a href="#AutoSegmentWidget.__init__-1373"><span class="linenos">1373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">volumetric</span> <span class="o">=</span> <span class="n">volumetric</span>
</span><span id="AutoSegmentWidget.__init__-1374"><a href="#AutoSegmentWidget.__init__-1374"><span class="linenos">1374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_create_widget</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="AutoSegmentWidget.with_decoder" class="classattr">
                                <div class="attr variable">
            <span class="name">with_decoder</span>

        
    </div>
    <a class="headerlink" href="#AutoSegmentWidget.with_decoder"></a>
    
    

                            </div>
                            <div id="AutoSegmentWidget.volumetric" class="classattr">
                                <div class="attr variable">
            <span class="name">volumetric</span>

        
    </div>
    <a class="headerlink" href="#AutoSegmentWidget.volumetric"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>PyQt5.QtWidgets.QWidget</dt>
                                <dd id="AutoSegmentWidget.RenderFlag" class="class">RenderFlag</dd>
                <dd id="AutoSegmentWidget.RenderFlags" class="class">RenderFlags</dd>
                <dd id="AutoSegmentWidget.acceptDrops" class="function">acceptDrops</dd>
                <dd id="AutoSegmentWidget.accessibleDescription" class="function">accessibleDescription</dd>
                <dd id="AutoSegmentWidget.accessibleName" class="function">accessibleName</dd>
                <dd id="AutoSegmentWidget.actionEvent" class="function">actionEvent</dd>
                <dd id="AutoSegmentWidget.actions" class="function">actions</dd>
                <dd id="AutoSegmentWidget.activateWindow" class="function">activateWindow</dd>
                <dd id="AutoSegmentWidget.addAction" class="function">addAction</dd>
                <dd id="AutoSegmentWidget.addActions" class="function">addActions</dd>
                <dd id="AutoSegmentWidget.adjustSize" class="function">adjustSize</dd>
                <dd id="AutoSegmentWidget.autoFillBackground" class="function">autoFillBackground</dd>
                <dd id="AutoSegmentWidget.backgroundRole" class="function">backgroundRole</dd>
                <dd id="AutoSegmentWidget.baseSize" class="function">baseSize</dd>
                <dd id="AutoSegmentWidget.changeEvent" class="function">changeEvent</dd>
                <dd id="AutoSegmentWidget.childAt" class="function">childAt</dd>
                <dd id="AutoSegmentWidget.childrenRect" class="function">childrenRect</dd>
                <dd id="AutoSegmentWidget.childrenRegion" class="function">childrenRegion</dd>
                <dd id="AutoSegmentWidget.clearFocus" class="function">clearFocus</dd>
                <dd id="AutoSegmentWidget.clearMask" class="function">clearMask</dd>
                <dd id="AutoSegmentWidget.close" class="function">close</dd>
                <dd id="AutoSegmentWidget.closeEvent" class="function">closeEvent</dd>
                <dd id="AutoSegmentWidget.contentsMargins" class="function">contentsMargins</dd>
                <dd id="AutoSegmentWidget.contentsRect" class="function">contentsRect</dd>
                <dd id="AutoSegmentWidget.contextMenuEvent" class="function">contextMenuEvent</dd>
                <dd id="AutoSegmentWidget.contextMenuPolicy" class="function">contextMenuPolicy</dd>
                <dd id="AutoSegmentWidget.create" class="function">create</dd>
                <dd id="AutoSegmentWidget.createWindowContainer" class="function">createWindowContainer</dd>
                <dd id="AutoSegmentWidget.cursor" class="function">cursor</dd>
                <dd id="AutoSegmentWidget.destroy" class="function">destroy</dd>
                <dd id="AutoSegmentWidget.devType" class="function">devType</dd>
                <dd id="AutoSegmentWidget.dragEnterEvent" class="function">dragEnterEvent</dd>
                <dd id="AutoSegmentWidget.dragLeaveEvent" class="function">dragLeaveEvent</dd>
                <dd id="AutoSegmentWidget.dragMoveEvent" class="function">dragMoveEvent</dd>
                <dd id="AutoSegmentWidget.dropEvent" class="function">dropEvent</dd>
                <dd id="AutoSegmentWidget.effectiveWinId" class="function">effectiveWinId</dd>
                <dd id="AutoSegmentWidget.ensurePolished" class="function">ensurePolished</dd>
                <dd id="AutoSegmentWidget.enterEvent" class="function">enterEvent</dd>
                <dd id="AutoSegmentWidget.event" class="function">event</dd>
                <dd id="AutoSegmentWidget.find" class="function">find</dd>
                <dd id="AutoSegmentWidget.focusInEvent" class="function">focusInEvent</dd>
                <dd id="AutoSegmentWidget.focusNextChild" class="function">focusNextChild</dd>
                <dd id="AutoSegmentWidget.focusNextPrevChild" class="function">focusNextPrevChild</dd>
                <dd id="AutoSegmentWidget.focusOutEvent" class="function">focusOutEvent</dd>
                <dd id="AutoSegmentWidget.focusPolicy" class="function">focusPolicy</dd>
                <dd id="AutoSegmentWidget.focusPreviousChild" class="function">focusPreviousChild</dd>
                <dd id="AutoSegmentWidget.focusProxy" class="function">focusProxy</dd>
                <dd id="AutoSegmentWidget.focusWidget" class="function">focusWidget</dd>
                <dd id="AutoSegmentWidget.font" class="function">font</dd>
                <dd id="AutoSegmentWidget.fontInfo" class="function">fontInfo</dd>
                <dd id="AutoSegmentWidget.fontMetrics" class="function">fontMetrics</dd>
                <dd id="AutoSegmentWidget.foregroundRole" class="function">foregroundRole</dd>
                <dd id="AutoSegmentWidget.frameGeometry" class="function">frameGeometry</dd>
                <dd id="AutoSegmentWidget.frameSize" class="function">frameSize</dd>
                <dd id="AutoSegmentWidget.geometry" class="function">geometry</dd>
                <dd id="AutoSegmentWidget.getContentsMargins" class="function">getContentsMargins</dd>
                <dd id="AutoSegmentWidget.grab" class="function">grab</dd>
                <dd id="AutoSegmentWidget.grabGesture" class="function">grabGesture</dd>
                <dd id="AutoSegmentWidget.grabKeyboard" class="function">grabKeyboard</dd>
                <dd id="AutoSegmentWidget.grabMouse" class="function">grabMouse</dd>
                <dd id="AutoSegmentWidget.grabShortcut" class="function">grabShortcut</dd>
                <dd id="AutoSegmentWidget.graphicsEffect" class="function">graphicsEffect</dd>
                <dd id="AutoSegmentWidget.graphicsProxyWidget" class="function">graphicsProxyWidget</dd>
                <dd id="AutoSegmentWidget.hasFocus" class="function">hasFocus</dd>
                <dd id="AutoSegmentWidget.hasHeightForWidth" class="function">hasHeightForWidth</dd>
                <dd id="AutoSegmentWidget.hasMouseTracking" class="function">hasMouseTracking</dd>
                <dd id="AutoSegmentWidget.hasTabletTracking" class="function">hasTabletTracking</dd>
                <dd id="AutoSegmentWidget.height" class="function">height</dd>
                <dd id="AutoSegmentWidget.heightForWidth" class="function">heightForWidth</dd>
                <dd id="AutoSegmentWidget.hide" class="function">hide</dd>
                <dd id="AutoSegmentWidget.hideEvent" class="function">hideEvent</dd>
                <dd id="AutoSegmentWidget.initPainter" class="function">initPainter</dd>
                <dd id="AutoSegmentWidget.inputMethodEvent" class="function">inputMethodEvent</dd>
                <dd id="AutoSegmentWidget.inputMethodHints" class="function">inputMethodHints</dd>
                <dd id="AutoSegmentWidget.inputMethodQuery" class="function">inputMethodQuery</dd>
                <dd id="AutoSegmentWidget.insertAction" class="function">insertAction</dd>
                <dd id="AutoSegmentWidget.insertActions" class="function">insertActions</dd>
                <dd id="AutoSegmentWidget.isActiveWindow" class="function">isActiveWindow</dd>
                <dd id="AutoSegmentWidget.isAncestorOf" class="function">isAncestorOf</dd>
                <dd id="AutoSegmentWidget.isEnabled" class="function">isEnabled</dd>
                <dd id="AutoSegmentWidget.isEnabledTo" class="function">isEnabledTo</dd>
                <dd id="AutoSegmentWidget.isFullScreen" class="function">isFullScreen</dd>
                <dd id="AutoSegmentWidget.isHidden" class="function">isHidden</dd>
                <dd id="AutoSegmentWidget.isLeftToRight" class="function">isLeftToRight</dd>
                <dd id="AutoSegmentWidget.isMaximized" class="function">isMaximized</dd>
                <dd id="AutoSegmentWidget.isMinimized" class="function">isMinimized</dd>
                <dd id="AutoSegmentWidget.isModal" class="function">isModal</dd>
                <dd id="AutoSegmentWidget.isRightToLeft" class="function">isRightToLeft</dd>
                <dd id="AutoSegmentWidget.isVisible" class="function">isVisible</dd>
                <dd id="AutoSegmentWidget.isVisibleTo" class="function">isVisibleTo</dd>
                <dd id="AutoSegmentWidget.isWindow" class="function">isWindow</dd>
                <dd id="AutoSegmentWidget.isWindowModified" class="function">isWindowModified</dd>
                <dd id="AutoSegmentWidget.keyPressEvent" class="function">keyPressEvent</dd>
                <dd id="AutoSegmentWidget.keyReleaseEvent" class="function">keyReleaseEvent</dd>
                <dd id="AutoSegmentWidget.keyboardGrabber" class="function">keyboardGrabber</dd>
                <dd id="AutoSegmentWidget.layout" class="function">layout</dd>
                <dd id="AutoSegmentWidget.layoutDirection" class="function">layoutDirection</dd>
                <dd id="AutoSegmentWidget.leaveEvent" class="function">leaveEvent</dd>
                <dd id="AutoSegmentWidget.locale" class="function">locale</dd>
                <dd id="AutoSegmentWidget.lower" class="function">lower</dd>
                <dd id="AutoSegmentWidget.mapFrom" class="function">mapFrom</dd>
                <dd id="AutoSegmentWidget.mapFromGlobal" class="function">mapFromGlobal</dd>
                <dd id="AutoSegmentWidget.mapFromParent" class="function">mapFromParent</dd>
                <dd id="AutoSegmentWidget.mapTo" class="function">mapTo</dd>
                <dd id="AutoSegmentWidget.mapToGlobal" class="function">mapToGlobal</dd>
                <dd id="AutoSegmentWidget.mapToParent" class="function">mapToParent</dd>
                <dd id="AutoSegmentWidget.mask" class="function">mask</dd>
                <dd id="AutoSegmentWidget.maximumHeight" class="function">maximumHeight</dd>
                <dd id="AutoSegmentWidget.maximumSize" class="function">maximumSize</dd>
                <dd id="AutoSegmentWidget.maximumWidth" class="function">maximumWidth</dd>
                <dd id="AutoSegmentWidget.metric" class="function">metric</dd>
                <dd id="AutoSegmentWidget.minimumHeight" class="function">minimumHeight</dd>
                <dd id="AutoSegmentWidget.minimumSize" class="function">minimumSize</dd>
                <dd id="AutoSegmentWidget.minimumSizeHint" class="function">minimumSizeHint</dd>
                <dd id="AutoSegmentWidget.minimumWidth" class="function">minimumWidth</dd>
                <dd id="AutoSegmentWidget.mouseDoubleClickEvent" class="function">mouseDoubleClickEvent</dd>
                <dd id="AutoSegmentWidget.mouseGrabber" class="function">mouseGrabber</dd>
                <dd id="AutoSegmentWidget.mouseMoveEvent" class="function">mouseMoveEvent</dd>
                <dd id="AutoSegmentWidget.mousePressEvent" class="function">mousePressEvent</dd>
                <dd id="AutoSegmentWidget.mouseReleaseEvent" class="function">mouseReleaseEvent</dd>
                <dd id="AutoSegmentWidget.move" class="function">move</dd>
                <dd id="AutoSegmentWidget.moveEvent" class="function">moveEvent</dd>
                <dd id="AutoSegmentWidget.nativeEvent" class="function">nativeEvent</dd>
                <dd id="AutoSegmentWidget.nativeParentWidget" class="function">nativeParentWidget</dd>
                <dd id="AutoSegmentWidget.nextInFocusChain" class="function">nextInFocusChain</dd>
                <dd id="AutoSegmentWidget.normalGeometry" class="function">normalGeometry</dd>
                <dd id="AutoSegmentWidget.overrideWindowFlags" class="function">overrideWindowFlags</dd>
                <dd id="AutoSegmentWidget.overrideWindowState" class="function">overrideWindowState</dd>
                <dd id="AutoSegmentWidget.paintEngine" class="function">paintEngine</dd>
                <dd id="AutoSegmentWidget.paintEvent" class="function">paintEvent</dd>
                <dd id="AutoSegmentWidget.palette" class="function">palette</dd>
                <dd id="AutoSegmentWidget.parentWidget" class="function">parentWidget</dd>
                <dd id="AutoSegmentWidget.pos" class="function">pos</dd>
                <dd id="AutoSegmentWidget.previousInFocusChain" class="function">previousInFocusChain</dd>
                <dd id="AutoSegmentWidget.raise_" class="function">raise_</dd>
                <dd id="AutoSegmentWidget.rect" class="function">rect</dd>
                <dd id="AutoSegmentWidget.releaseKeyboard" class="function">releaseKeyboard</dd>
                <dd id="AutoSegmentWidget.releaseMouse" class="function">releaseMouse</dd>
                <dd id="AutoSegmentWidget.releaseShortcut" class="function">releaseShortcut</dd>
                <dd id="AutoSegmentWidget.removeAction" class="function">removeAction</dd>
                <dd id="AutoSegmentWidget.render" class="function">render</dd>
                <dd id="AutoSegmentWidget.repaint" class="function">repaint</dd>
                <dd id="AutoSegmentWidget.resize" class="function">resize</dd>
                <dd id="AutoSegmentWidget.resizeEvent" class="function">resizeEvent</dd>
                <dd id="AutoSegmentWidget.restoreGeometry" class="function">restoreGeometry</dd>
                <dd id="AutoSegmentWidget.saveGeometry" class="function">saveGeometry</dd>
                <dd id="AutoSegmentWidget.screen" class="function">screen</dd>
                <dd id="AutoSegmentWidget.scroll" class="function">scroll</dd>
                <dd id="AutoSegmentWidget.setAcceptDrops" class="function">setAcceptDrops</dd>
                <dd id="AutoSegmentWidget.setAccessibleDescription" class="function">setAccessibleDescription</dd>
                <dd id="AutoSegmentWidget.setAccessibleName" class="function">setAccessibleName</dd>
                <dd id="AutoSegmentWidget.setAttribute" class="function">setAttribute</dd>
                <dd id="AutoSegmentWidget.setAutoFillBackground" class="function">setAutoFillBackground</dd>
                <dd id="AutoSegmentWidget.setBackgroundRole" class="function">setBackgroundRole</dd>
                <dd id="AutoSegmentWidget.setBaseSize" class="function">setBaseSize</dd>
                <dd id="AutoSegmentWidget.setContentsMargins" class="function">setContentsMargins</dd>
                <dd id="AutoSegmentWidget.setContextMenuPolicy" class="function">setContextMenuPolicy</dd>
                <dd id="AutoSegmentWidget.setCursor" class="function">setCursor</dd>
                <dd id="AutoSegmentWidget.setDisabled" class="function">setDisabled</dd>
                <dd id="AutoSegmentWidget.setEnabled" class="function">setEnabled</dd>
                <dd id="AutoSegmentWidget.setFixedHeight" class="function">setFixedHeight</dd>
                <dd id="AutoSegmentWidget.setFixedSize" class="function">setFixedSize</dd>
                <dd id="AutoSegmentWidget.setFixedWidth" class="function">setFixedWidth</dd>
                <dd id="AutoSegmentWidget.setFocus" class="function">setFocus</dd>
                <dd id="AutoSegmentWidget.setFocusPolicy" class="function">setFocusPolicy</dd>
                <dd id="AutoSegmentWidget.setFocusProxy" class="function">setFocusProxy</dd>
                <dd id="AutoSegmentWidget.setFont" class="function">setFont</dd>
                <dd id="AutoSegmentWidget.setForegroundRole" class="function">setForegroundRole</dd>
                <dd id="AutoSegmentWidget.setGeometry" class="function">setGeometry</dd>
                <dd id="AutoSegmentWidget.setGraphicsEffect" class="function">setGraphicsEffect</dd>
                <dd id="AutoSegmentWidget.setHidden" class="function">setHidden</dd>
                <dd id="AutoSegmentWidget.setInputMethodHints" class="function">setInputMethodHints</dd>
                <dd id="AutoSegmentWidget.setLayout" class="function">setLayout</dd>
                <dd id="AutoSegmentWidget.setLayoutDirection" class="function">setLayoutDirection</dd>
                <dd id="AutoSegmentWidget.setLocale" class="function">setLocale</dd>
                <dd id="AutoSegmentWidget.setMask" class="function">setMask</dd>
                <dd id="AutoSegmentWidget.setMaximumHeight" class="function">setMaximumHeight</dd>
                <dd id="AutoSegmentWidget.setMaximumSize" class="function">setMaximumSize</dd>
                <dd id="AutoSegmentWidget.setMaximumWidth" class="function">setMaximumWidth</dd>
                <dd id="AutoSegmentWidget.setMinimumHeight" class="function">setMinimumHeight</dd>
                <dd id="AutoSegmentWidget.setMinimumSize" class="function">setMinimumSize</dd>
                <dd id="AutoSegmentWidget.setMinimumWidth" class="function">setMinimumWidth</dd>
                <dd id="AutoSegmentWidget.setMouseTracking" class="function">setMouseTracking</dd>
                <dd id="AutoSegmentWidget.setPalette" class="function">setPalette</dd>
                <dd id="AutoSegmentWidget.setParent" class="function">setParent</dd>
                <dd id="AutoSegmentWidget.setShortcutAutoRepeat" class="function">setShortcutAutoRepeat</dd>
                <dd id="AutoSegmentWidget.setShortcutEnabled" class="function">setShortcutEnabled</dd>
                <dd id="AutoSegmentWidget.setSizeIncrement" class="function">setSizeIncrement</dd>
                <dd id="AutoSegmentWidget.setSizePolicy" class="function">setSizePolicy</dd>
                <dd id="AutoSegmentWidget.setStatusTip" class="function">setStatusTip</dd>
                <dd id="AutoSegmentWidget.setStyle" class="function">setStyle</dd>
                <dd id="AutoSegmentWidget.setStyleSheet" class="function">setStyleSheet</dd>
                <dd id="AutoSegmentWidget.setTabOrder" class="function">setTabOrder</dd>
                <dd id="AutoSegmentWidget.setTabletTracking" class="function">setTabletTracking</dd>
                <dd id="AutoSegmentWidget.setToolTip" class="function">setToolTip</dd>
                <dd id="AutoSegmentWidget.setToolTipDuration" class="function">setToolTipDuration</dd>
                <dd id="AutoSegmentWidget.setUpdatesEnabled" class="function">setUpdatesEnabled</dd>
                <dd id="AutoSegmentWidget.setVisible" class="function">setVisible</dd>
                <dd id="AutoSegmentWidget.setWhatsThis" class="function">setWhatsThis</dd>
                <dd id="AutoSegmentWidget.setWindowFilePath" class="function">setWindowFilePath</dd>
                <dd id="AutoSegmentWidget.setWindowFlag" class="function">setWindowFlag</dd>
                <dd id="AutoSegmentWidget.setWindowFlags" class="function">setWindowFlags</dd>
                <dd id="AutoSegmentWidget.setWindowIcon" class="function">setWindowIcon</dd>
                <dd id="AutoSegmentWidget.setWindowIconText" class="function">setWindowIconText</dd>
                <dd id="AutoSegmentWidget.setWindowModality" class="function">setWindowModality</dd>
                <dd id="AutoSegmentWidget.setWindowModified" class="function">setWindowModified</dd>
                <dd id="AutoSegmentWidget.setWindowOpacity" class="function">setWindowOpacity</dd>
                <dd id="AutoSegmentWidget.setWindowRole" class="function">setWindowRole</dd>
                <dd id="AutoSegmentWidget.setWindowState" class="function">setWindowState</dd>
                <dd id="AutoSegmentWidget.setWindowTitle" class="function">setWindowTitle</dd>
                <dd id="AutoSegmentWidget.sharedPainter" class="function">sharedPainter</dd>
                <dd id="AutoSegmentWidget.show" class="function">show</dd>
                <dd id="AutoSegmentWidget.showEvent" class="function">showEvent</dd>
                <dd id="AutoSegmentWidget.showFullScreen" class="function">showFullScreen</dd>
                <dd id="AutoSegmentWidget.showMaximized" class="function">showMaximized</dd>
                <dd id="AutoSegmentWidget.showMinimized" class="function">showMinimized</dd>
                <dd id="AutoSegmentWidget.showNormal" class="function">showNormal</dd>
                <dd id="AutoSegmentWidget.size" class="function">size</dd>
                <dd id="AutoSegmentWidget.sizeHint" class="function">sizeHint</dd>
                <dd id="AutoSegmentWidget.sizeIncrement" class="function">sizeIncrement</dd>
                <dd id="AutoSegmentWidget.sizePolicy" class="function">sizePolicy</dd>
                <dd id="AutoSegmentWidget.stackUnder" class="function">stackUnder</dd>
                <dd id="AutoSegmentWidget.statusTip" class="function">statusTip</dd>
                <dd id="AutoSegmentWidget.style" class="function">style</dd>
                <dd id="AutoSegmentWidget.styleSheet" class="function">styleSheet</dd>
                <dd id="AutoSegmentWidget.tabletEvent" class="function">tabletEvent</dd>
                <dd id="AutoSegmentWidget.testAttribute" class="function">testAttribute</dd>
                <dd id="AutoSegmentWidget.toolTip" class="function">toolTip</dd>
                <dd id="AutoSegmentWidget.toolTipDuration" class="function">toolTipDuration</dd>
                <dd id="AutoSegmentWidget.underMouse" class="function">underMouse</dd>
                <dd id="AutoSegmentWidget.ungrabGesture" class="function">ungrabGesture</dd>
                <dd id="AutoSegmentWidget.unsetCursor" class="function">unsetCursor</dd>
                <dd id="AutoSegmentWidget.unsetLayoutDirection" class="function">unsetLayoutDirection</dd>
                <dd id="AutoSegmentWidget.unsetLocale" class="function">unsetLocale</dd>
                <dd id="AutoSegmentWidget.update" class="function">update</dd>
                <dd id="AutoSegmentWidget.updateGeometry" class="function">updateGeometry</dd>
                <dd id="AutoSegmentWidget.updateMicroFocus" class="function">updateMicroFocus</dd>
                <dd id="AutoSegmentWidget.updatesEnabled" class="function">updatesEnabled</dd>
                <dd id="AutoSegmentWidget.visibleRegion" class="function">visibleRegion</dd>
                <dd id="AutoSegmentWidget.whatsThis" class="function">whatsThis</dd>
                <dd id="AutoSegmentWidget.wheelEvent" class="function">wheelEvent</dd>
                <dd id="AutoSegmentWidget.width" class="function">width</dd>
                <dd id="AutoSegmentWidget.winId" class="function">winId</dd>
                <dd id="AutoSegmentWidget.window" class="function">window</dd>
                <dd id="AutoSegmentWidget.windowFilePath" class="function">windowFilePath</dd>
                <dd id="AutoSegmentWidget.windowFlags" class="function">windowFlags</dd>
                <dd id="AutoSegmentWidget.windowHandle" class="function">windowHandle</dd>
                <dd id="AutoSegmentWidget.windowIcon" class="function">windowIcon</dd>
                <dd id="AutoSegmentWidget.windowIconText" class="function">windowIconText</dd>
                <dd id="AutoSegmentWidget.windowModality" class="function">windowModality</dd>
                <dd id="AutoSegmentWidget.windowOpacity" class="function">windowOpacity</dd>
                <dd id="AutoSegmentWidget.windowRole" class="function">windowRole</dd>
                <dd id="AutoSegmentWidget.windowState" class="function">windowState</dd>
                <dd id="AutoSegmentWidget.windowTitle" class="function">windowTitle</dd>
                <dd id="AutoSegmentWidget.windowType" class="function">windowType</dd>
                <dd id="AutoSegmentWidget.x" class="function">x</dd>
                <dd id="AutoSegmentWidget.y" class="function">y</dd>
                <dd id="AutoSegmentWidget.DrawChildren" class="variable">DrawChildren</dd>
                <dd id="AutoSegmentWidget.DrawWindowBackground" class="variable">DrawWindowBackground</dd>
                <dd id="AutoSegmentWidget.IgnoreMask" class="variable">IgnoreMask</dd>
                <dd id="AutoSegmentWidget.windowIconTextChanged" class="function">windowIconTextChanged</dd>
                <dd id="AutoSegmentWidget.windowIconChanged" class="function">windowIconChanged</dd>
                <dd id="AutoSegmentWidget.windowTitleChanged" class="function">windowTitleChanged</dd>
                <dd id="AutoSegmentWidget.customContextMenuRequested" class="function">customContextMenuRequested</dd>

            </div>
            <div><dt>PyQt5.QtCore.QObject</dt>
                                <dd id="AutoSegmentWidget.blockSignals" class="function">blockSignals</dd>
                <dd id="AutoSegmentWidget.childEvent" class="function">childEvent</dd>
                <dd id="AutoSegmentWidget.children" class="function">children</dd>
                <dd id="AutoSegmentWidget.connectNotify" class="function">connectNotify</dd>
                <dd id="AutoSegmentWidget.customEvent" class="function">customEvent</dd>
                <dd id="AutoSegmentWidget.deleteLater" class="function">deleteLater</dd>
                <dd id="AutoSegmentWidget.disconnect" class="function">disconnect</dd>
                <dd id="AutoSegmentWidget.disconnectNotify" class="function">disconnectNotify</dd>
                <dd id="AutoSegmentWidget.dumpObjectInfo" class="function">dumpObjectInfo</dd>
                <dd id="AutoSegmentWidget.dumpObjectTree" class="function">dumpObjectTree</dd>
                <dd id="AutoSegmentWidget.dynamicPropertyNames" class="function">dynamicPropertyNames</dd>
                <dd id="AutoSegmentWidget.eventFilter" class="function">eventFilter</dd>
                <dd id="AutoSegmentWidget.findChild" class="function">findChild</dd>
                <dd id="AutoSegmentWidget.findChildren" class="function">findChildren</dd>
                <dd id="AutoSegmentWidget.inherits" class="function">inherits</dd>
                <dd id="AutoSegmentWidget.installEventFilter" class="function">installEventFilter</dd>
                <dd id="AutoSegmentWidget.isSignalConnected" class="function">isSignalConnected</dd>
                <dd id="AutoSegmentWidget.isWidgetType" class="function">isWidgetType</dd>
                <dd id="AutoSegmentWidget.isWindowType" class="function">isWindowType</dd>
                <dd id="AutoSegmentWidget.killTimer" class="function">killTimer</dd>
                <dd id="AutoSegmentWidget.metaObject" class="function">metaObject</dd>
                <dd id="AutoSegmentWidget.moveToThread" class="function">moveToThread</dd>
                <dd id="AutoSegmentWidget.objectName" class="function">objectName</dd>
                <dd id="AutoSegmentWidget.parent" class="function">parent</dd>
                <dd id="AutoSegmentWidget.property" class="function">property</dd>
                <dd id="AutoSegmentWidget.pyqtConfigure" class="function">pyqtConfigure</dd>
                <dd id="AutoSegmentWidget.receivers" class="function">receivers</dd>
                <dd id="AutoSegmentWidget.removeEventFilter" class="function">removeEventFilter</dd>
                <dd id="AutoSegmentWidget.sender" class="function">sender</dd>
                <dd id="AutoSegmentWidget.senderSignalIndex" class="function">senderSignalIndex</dd>
                <dd id="AutoSegmentWidget.setObjectName" class="function">setObjectName</dd>
                <dd id="AutoSegmentWidget.setProperty" class="function">setProperty</dd>
                <dd id="AutoSegmentWidget.signalsBlocked" class="function">signalsBlocked</dd>
                <dd id="AutoSegmentWidget.startTimer" class="function">startTimer</dd>
                <dd id="AutoSegmentWidget.thread" class="function">thread</dd>
                <dd id="AutoSegmentWidget.timerEvent" class="function">timerEvent</dd>
                <dd id="AutoSegmentWidget.tr" class="function">tr</dd>
                <dd id="AutoSegmentWidget.staticMetaObject" class="variable">staticMetaObject</dd>
                <dd id="AutoSegmentWidget.objectNameChanged" class="function">objectNameChanged</dd>
                <dd id="AutoSegmentWidget.destroyed" class="function">destroyed</dd>

            </div>
            <div><dt>PyQt5.QtGui.QPaintDevice</dt>
                                <dd id="AutoSegmentWidget.PaintDeviceMetric" class="class">PaintDeviceMetric</dd>
                <dd id="AutoSegmentWidget.colorCount" class="function">colorCount</dd>
                <dd id="AutoSegmentWidget.depth" class="function">depth</dd>
                <dd id="AutoSegmentWidget.devicePixelRatio" class="function">devicePixelRatio</dd>
                <dd id="AutoSegmentWidget.devicePixelRatioF" class="function">devicePixelRatioF</dd>
                <dd id="AutoSegmentWidget.devicePixelRatioFScale" class="function">devicePixelRatioFScale</dd>
                <dd id="AutoSegmentWidget.heightMM" class="function">heightMM</dd>
                <dd id="AutoSegmentWidget.logicalDpiX" class="function">logicalDpiX</dd>
                <dd id="AutoSegmentWidget.logicalDpiY" class="function">logicalDpiY</dd>
                <dd id="AutoSegmentWidget.paintingActive" class="function">paintingActive</dd>
                <dd id="AutoSegmentWidget.physicalDpiX" class="function">physicalDpiX</dd>
                <dd id="AutoSegmentWidget.physicalDpiY" class="function">physicalDpiY</dd>
                <dd id="AutoSegmentWidget.widthMM" class="function">widthMM</dd>
                <dd id="AutoSegmentWidget.PdmDepth" class="variable">PdmDepth</dd>
                <dd id="AutoSegmentWidget.PdmDevicePixelRatio" class="variable">PdmDevicePixelRatio</dd>
                <dd id="AutoSegmentWidget.PdmDevicePixelRatioScaled" class="variable">PdmDevicePixelRatioScaled</dd>
                <dd id="AutoSegmentWidget.PdmDpiX" class="variable">PdmDpiX</dd>
                <dd id="AutoSegmentWidget.PdmDpiY" class="variable">PdmDpiY</dd>
                <dd id="AutoSegmentWidget.PdmHeight" class="variable">PdmHeight</dd>
                <dd id="AutoSegmentWidget.PdmHeightMM" class="variable">PdmHeightMM</dd>
                <dd id="AutoSegmentWidget.PdmNumColors" class="variable">PdmNumColors</dd>
                <dd id="AutoSegmentWidget.PdmPhysicalDpiX" class="variable">PdmPhysicalDpiX</dd>
                <dd id="AutoSegmentWidget.PdmPhysicalDpiY" class="variable">PdmPhysicalDpiY</dd>
                <dd id="AutoSegmentWidget.PdmWidth" class="variable">PdmWidth</dd>
                <dd id="AutoSegmentWidget.PdmWidthMM" class="variable">PdmWidthMM</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>